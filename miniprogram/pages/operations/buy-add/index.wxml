<!--
  收购登记页面（仓库工作人员填写）
  使用 TDesign 组件库
-->
<view class="acquisition-page">
  <!-- 页面标题 -->
  <view class="page-header">
    <text class="page-title">收购登记</text>
    <text class="page-subtitle">仓库工作人员填写收购信息</text>
  </view>

  <!-- 基本信息 -->
  <view class="form-section">
    <view class="section-header">
      <view class="section-indicator indicator-orange"></view>
      <text class="section-title">基本信息</text>
    </view>
    
    <t-cell-group theme="card" class="form-card-group">
      <!-- 收购日期 -->
      <t-cell
        title="收购日期"
        arrow
        hover
        note="{{form.date || '选择日期'}}"
        required
        bind:click="showDatePicker"
      />
      
      <!-- 仓库显示（自动获取，不可选择）-->
      <t-cell
        title="仓库"
        note="{{warehouseInfo.name || '未绑定仓库'}}"
        required
      />
      
      <!-- 农户选择 -->
      <t-cell
        title="农户"
        arrow
        hover
        note="{{selectedFarmer.name || '点击搜索农户'}}"
        required
        bind:click="showFarmerSearch"
      />
      
      <!-- 搜索到的农户信息 -->
      <t-cell
        wx:if="{{selectedFarmer.id}}"
        title="已选农户"
        description="编号：{{selectedFarmer.farmerId}} | {{selectedFarmer.addressText}}"
      >
        <view slot="note" class="farmer-info-slot">
          <text class="farmer-phone">{{selectedFarmer.phone}}</text>
          <view class="grade-badge grade-{{selectedFarmer.grade}}">{{selectedFarmer.gradeText}}</view>
        </view>
      </t-cell>
      
      <!-- 预估收购重量 -->
      <t-cell
        wx:if="{{selectedFarmer.id}}"
        title="预估收购重量"
      >
        <view slot="note" class="estimated-weight-display">
          <text class="estimated-value">{{estimatedWeight}}</text>
          <text class="estimated-unit">KG</text>
        </view>
        <text slot="description" class="estimated-note">基于种植面积 {{selectedFarmer.acreage || 0}} 亩</text>
      </t-cell>
    </t-cell-group>
  </view>

  <!-- 称重信息 -->
  <view class="form-section">
    <view class="section-header">
      <view class="section-indicator indicator-blue"></view>
      <text class="section-title">称重信息</text>
    </view>
    
    <view class="form-card">
      <!-- 毛重 -->
      <view class="form-row">
        <text class="form-label required">毛重</text>
        <view class="form-input-wrap">
          <input 
            class="form-input"
            type="digit"
            placeholder="请输入"
            value="{{form.grossWeight}}"
            bindinput="onGrossWeightInput"
          />
          <text class="form-unit">KG</text>
        </view>
      </view>
      
      <!-- 皮重 -->
      <view class="form-row">
        <text class="form-label required">皮重</text>
        <view class="form-input-wrap">
          <input 
            class="form-input"
            type="digit"
            placeholder="请输入"
            value="{{form.tareWeight}}"
            bindinput="onTareWeightInput"
          />
          <text class="form-unit">KG</text>
        </view>
      </view>
      
      <!-- 水杂率 -->
      <view class="form-row">
        <text class="form-label required">水杂率</text>
        <view class="form-input-wrap">
          <input 
            class="form-input"
            type="digit"
            placeholder="请输入"
            value="{{form.moistureRate}}"
            bindinput="onMoistureRateInput"
          />
          <text class="form-unit">%</text>
        </view>
      </view>
      
      <!-- 水杂 -->
      <view class="form-row">
        <text class="form-label">水杂</text>
        <view class="form-value-wrap">
          <text class="form-value">{{moistureWeight}}</text>
          <text class="form-unit">KG</text>
        </view>
      </view>
      
      <!-- 净重 -->
      <view class="form-row">
        <text class="form-label">净重</text>
        <view class="form-value-wrap">
          <text class="form-value highlight-blue">{{netWeight}}</text>
          <text class="form-unit">KG</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 金额信息 -->
  <view class="form-section">
    <view class="section-header">
      <view class="section-indicator indicator-green"></view>
      <text class="section-title">金额信息</text>
    </view>
    
    <view class="form-card">
      <!-- 单价 -->
      <view class="form-row">
        <text class="form-label required">单价</text>
        <view class="form-input-wrap">
          <input 
            class="form-input"
            type="digit"
            placeholder="请输入"
            value="{{form.unitPrice}}"
            bindinput="onUnitPriceInput"
          />
          <text class="form-unit">元/KG</text>
        </view>
      </view>
      
      <!-- 金额 -->
      <view class="form-row">
        <text class="form-label">金额</text>
        <view class="form-value-wrap">
          <text class="form-value highlight-green">{{totalAmountWan}}</text>
          <text class="form-unit">万元</text>
        </view>
      </view>
      
      <!-- 计算公式 -->
      <view class="formula-row" wx:if="{{netWeight && form.unitPrice}}">
        <text class="formula-text">{{netWeight}} KG × {{form.unitPrice}} 元 = ¥{{totalAmount}}</text>
      </view>
    </view>
  </view>

  <!-- 备注信息 -->
  <view class="form-section">
    <view class="section-header">
      <view class="section-indicator indicator-purple"></view>
      <text class="section-title">备注信息</text>
    </view>
    
    <view class="form-card">
      <t-textarea
        placeholder="请输入备注信息（选填）"
        value="{{form.remark}}"
        maxlength="200"
        indicator
        autosize
        bind:change="onRemarkInput"
      />
    </view>
  </view>

  <!-- 提示信息 -->
  <view class="tips">
    <view class="tip-item">
      <text class="tip-dot">•</text>
      <text>预估收购重量 = 种植面积 × 300 KG/亩</text>
    </view>
    <view class="tip-item">
      <text class="tip-dot">•</text>
      <text>净重 = 毛重 - 皮重 - 水杂</text>
    </view>
    <view class="tip-item">
      <text class="tip-dot">•</text>
      <text>水杂 = (毛重 - 皮重) × 水杂率</text>
    </view>
  </view>

  <!-- 底部按钮 -->
  <view class="bottom-actions">
    <t-button 
      theme="light" 
      size="large" 
      block 
      bind:tap="onCancel"
    >取消</t-button>
    <t-button 
      theme="primary" 
      size="large" 
      block 
      loading="{{submitting}}"
      disabled="{{!canSubmit}}"
      bind:tap="onSubmit"
      style="--td-button-primary-bg-color: #f97316; --td-button-primary-border-color: #f97316;"
    >确认收购</t-button>
  </view>
</view>

<!-- 农户搜索弹窗 -->
<t-popup 
  visible="{{showFarmerPopup}}" 
  placement="bottom"
  bind:visible-change="onFarmerPopupChange"
>
  <view class="popup-container">
    <view class="popup-header">
      <text class="popup-title">搜索农户</text>
      <view class="popup-close" bindtap="closeFarmerPopup">
        <t-icon name="close" size="44rpx" color="#6b7280" />
      </view>
    </view>
    
    <!-- 搜索输入区域 -->
    <view class="search-section">
      <view class="search-row">
        <t-input
          placeholder="请输入农户手机号"
          type="number"
          maxlength="11"
          value="{{searchPhone}}"
          clearable
          bind:change="onSearchPhoneChange"
          style="flex: 1;"
        />
        <t-button 
          theme="primary" 
          size="medium"
          bind:tap="searchFarmer"
          loading="{{searching}}"
          disabled="{{searchPhone.length !== 11}}"
          style="--td-button-primary-bg-color: #f97316; --td-button-primary-border-color: #f97316; margin-left: 20rpx;"
        >搜索</t-button>
      </view>
      <text class="search-hint">请输入农户的11位手机号码进行搜索</text>
    </view>
    
    <!-- 搜索结果 -->
    <view class="search-result" wx:if="{{searchResult.id}}">
      <view class="result-header">搜索结果</view>
      <view class="result-card">
        <view class="result-info" bindtap="confirmSelectFarmer">
          <view class="result-name-row">
            <text class="result-name">{{searchResult.name}}</text>
            <view class="grade-badge grade-{{searchResult.grade}}">{{searchResult.gradeText}}</view>
          </view>
          <text class="result-id">编号：{{searchResult.farmerId}}</text>
          <text class="result-phone">{{searchResult.phone}}</text>
          <text class="result-address">{{searchResult.addressText}}</text>
          <text class="result-acreage">种植面积：{{searchResult.acreage}} 亩</text>
        </view>
        <view class="result-action">
          <t-button 
            theme="primary" 
            size="small"
            catchtap="confirmSelectFarmer"
            style="--td-button-primary-bg-color: #059669; --td-button-primary-border-color: #059669;"
          >选择</t-button>
        </view>
      </view>
    </view>
    
    <!-- 未搜索或无结果提示 -->
    <view class="search-empty" wx:if="{{!searchResult.id && searchedOnce}}">
      <text class="empty-text">未找到该手机号对应的农户</text>
    </view>
  </view>
</t-popup>

<!-- 日期选择器 -->
<t-date-time-picker
  visible="{{showDatePicker}}"
  mode="date"
  value="{{datePickerValue}}"
  format="YYYY-MM-DD"
  title="选择收购日期"
  bind:confirm="onDateConfirm"
  bind:cancel="onDateCancel"
/>
