<!--
  收购登记页面
  仓库管理员专用
-->
<view class="page-container">
  <!-- 顶部背景 -->
  <view class="header-bg"></view>

  <!-- 页面标题 -->
  <view class="page-header">
    <view class="header-info">
      <text class="page-title">收购登记</text>
      <text class="page-subtitle">{{warehouseInfo.name || '仓库'}}</text>
    </view>
    <view class="header-date" bindtap="showDatePicker">
      <t-icon name="calendar" size="36rpx" />
      <text>{{form.date || '选择日期'}}</text>
    </view>
  </view>

  <!-- 农户选择卡片 -->
  <view class="card farmer-card" bindtap="showFarmerSearch">
    <view wx:if="{{!selectedFarmer.id}}" class="farmer-empty">
      <view class="empty-icon">
        <t-icon name="user-add" size="56rpx" color="#9ca3af" />
      </view>
      <text class="empty-text">点击选择农户</text>
      <text class="empty-hint">请先搜索并选择交苗农户</text>
    </view>
    
    <view wx:else class="farmer-selected">
      <view class="farmer-main">
        <view class="farmer-avatar">
          <text>{{selectedFarmer.name[0]}}</text>
        </view>
        <view class="farmer-info">
          <view class="farmer-name-row">
            <text class="farmer-name">{{selectedFarmer.name}}</text>
            <view class="grade-tag grade-{{selectedFarmer.grade}}">{{selectedFarmer.gradeText}}</view>
          </view>
          <text class="farmer-meta">{{selectedFarmer.phone}} · {{selectedFarmer.acreage}}亩</text>
          <text class="farmer-address">{{selectedFarmer.addressText}}</text>
        </view>
        <t-icon name="chevron-right" size="40rpx" color="#d1d5db" />
      </view>
      
      <!-- 历史收购统计 -->
      <view wx:if="{{farmerSummary.totalCount > 0}}" class="farmer-history">
        <view class="history-item">
          <text class="history-value">{{farmerSummary.totalCount}}</text>
          <text class="history-label">历史笔数</text>
        </view>
        <view class="history-divider"></view>
        <view class="history-item">
          <text class="history-value">{{farmerSummary.totalWeight}}</text>
          <text class="history-label">累计(kg)</text>
        </view>
        <view class="history-divider"></view>
        <view class="history-item">
          <text class="history-value highlight">{{farmerSummary.totalAmountWan}}</text>
          <text class="history-label">金额(万)</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 称重信息卡片 -->
  <view class="card">
    <view class="card-header">
      <view class="card-indicator blue"></view>
      <text class="card-title">称重信息</text>
    </view>
    
    <view class="input-grid">
      <!-- 毛重 -->
      <view class="input-item">
        <text class="input-label">毛重 *</text>
        <view class="input-box">
          <input 
            class="input-field"
            type="digit"
            placeholder="0"
            value="{{form.grossWeight}}"
            bindinput="onGrossWeightInput"
          />
          <text class="input-unit">kg</text>
        </view>
      </view>
      
      <!-- 皮重 -->
      <view class="input-item">
        <text class="input-label">皮重 *</text>
        <view class="input-box">
          <input 
            class="input-field"
            type="digit"
            placeholder="0"
            value="{{form.tareWeight}}"
            bindinput="onTareWeightInput"
          />
          <text class="input-unit">kg</text>
        </view>
      </view>
      
      <!-- 水杂率 -->
      <view class="input-item">
        <text class="input-label">水杂率 *</text>
        <view class="input-box">
          <input 
            class="input-field"
            type="digit"
            placeholder="0"
            value="{{form.moistureRate}}"
            bindinput="onMoistureRateInput"
          />
          <text class="input-unit">%</text>
        </view>
      </view>
      
      <!-- 单价 -->
      <view class="input-item">
        <text class="input-label">单价 *</text>
        <view class="input-box">
          <input 
            class="input-field"
            type="digit"
            placeholder="0"
            value="{{form.unitPrice}}"
            bindinput="onUnitPriceInput"
          />
          <text class="input-unit">元/kg</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 计算结果卡片 -->
  <view class="card result-card">
    <view class="card-header">
      <view class="card-indicator green"></view>
      <text class="card-title">计算结果</text>
    </view>
    
    <!-- 结果列表 -->
    <view class="result-list">
      <view class="result-row-item">
        <text class="result-item-label">水杂</text>
        <view class="result-item-value-wrap">
          <text class="result-item-value">{{moistureWeight}}</text>
          <text class="result-item-unit">kg</text>
        </view>
      </view>
      
      <view class="result-row-item highlight-row">
        <text class="result-item-label">净重</text>
        <view class="result-item-value-wrap">
          <text class="result-item-value highlight-blue">{{netWeight}}</text>
          <text class="result-item-unit">kg</text>
        </view>
      </view>
      
      <view class="result-row-item">
        <text class="result-item-label">金额</text>
        <view class="result-item-value-wrap">
          <text class="result-item-value highlight-green">¥{{totalAmount}}</text>
        </view>
      </view>
    </view>
    
    <!-- 计算公式 -->
    <view class="formula" wx:if="{{netWeight && form.unitPrice}}">
      <text>{{netWeight}} kg × {{form.unitPrice}} 元/kg = ¥{{totalAmount}}</text>
    </view>
  </view>
  
  <!-- 农户概况卡片（发苗+预估） -->
  <view class="card overview-card" wx:if="{{selectedFarmer.id}}">
    <view class="card-header">
      <view class="card-indicator purple"></view>
      <text class="card-title">农户概况</text>
    </view>
    
    <!-- 发苗情况 -->
    <view class="overview-grid">
      <view class="overview-item">
        <text class="overview-label">签约面积</text>
        <text class="overview-value">{{selectedFarmer.acreage}} 亩</text>
      </view>
      <view class="overview-item">
        <text class="overview-label">签约苗量</text>
        <text class="overview-value">{{selectedFarmer.seedTotal}} 万株</text>
      </view>
      <view class="overview-item">
        <text class="overview-label">已发苗</text>
        <text class="overview-value highlight-purple">{{selectedFarmer.distributedArea}} 亩</text>
      </view>
      <view class="overview-item">
        <text class="overview-label">已发苗量</text>
        <text class="overview-value highlight-purple">{{selectedFarmer.distributedQuantity}} 万株</text>
      </view>
    </view>
    
    <!-- 预估收购 -->
    <view class="estimate-section">
      <view class="estimate-row-item">
        <text class="estimate-label">预估总收购量</text>
        <text class="estimate-value">{{estimatedWeight}} kg</text>
      </view>
      <view class="estimate-row-item">
        <text class="estimate-label">已收购</text>
        <text class="estimate-value">{{farmerSummary.totalWeight || 0}} kg</text>
      </view>
      <view class="estimate-row-item highlight">
        <text class="estimate-label">剩余预估</text>
        <text class="estimate-value {{remainingWeight >= 0 ? '' : 'warning'}}">{{remainingWeight}} kg</text>
      </view>
    </view>
  </view>

  <!-- 备注卡片 -->
  <view class="card">
    <view class="card-header">
      <view class="card-indicator purple"></view>
      <text class="card-title">备注（选填）</text>
    </view>
    <t-textarea
      placeholder="请输入备注信息"
      value="{{form.remark}}"
      maxlength="200"
      indicator
      autosize
      bind:change="onRemarkInput"
    />
  </view>

  <!-- 底部安全区 -->
  <view class="safe-bottom"></view>
</view>

<!-- 底部操作栏 -->
<view class="bottom-bar">
  <view class="bottom-summary" wx:if="{{netWeight > 0}}">
    <view class="summary-row">
      <text class="summary-label">净重</text>
      <text class="summary-value">{{netWeight}} kg</text>
    </view>
    <view class="summary-row">
      <text class="summary-label">金额</text>
      <text class="summary-value highlight">¥{{totalAmount}}</text>
    </view>
  </view>
  <view class="bottom-actions">
    <view class="btn-cancel" bindtap="onCancel">取消</view>
    <view class="btn-submit {{canSubmit ? '' : 'disabled'}}" bindtap="onSubmit">
      <t-loading wx:if="{{submitting}}" theme="circular" size="32rpx" color="#ffffff" />
      <text wx:else>确认收购</text>
    </view>
  </view>
</view>

<!-- 农户搜索弹窗 -->
<t-popup 
  visible="{{showFarmerPopup}}" 
  placement="bottom"
  bind:visible-change="onFarmerPopupChange"
>
  <view class="popup-wrap">
    <view class="popup-header">
      <text class="popup-title">搜索农户</text>
      <view class="popup-close" bindtap="closeFarmerPopup">
        <t-icon name="close" size="44rpx" color="#6b7280" />
      </view>
    </view>
    
    <!-- 搜索区 -->
    <view class="search-section">
      <view class="search-input-row">
        <view class="search-input-wrap">
          <t-icon name="search" size="36rpx" color="#9ca3af" />
          <input 
            class="search-input"
            type="number"
            maxlength="11"
            placeholder="输入农户手机号"
            value="{{searchPhone}}"
            bindinput="onSearchPhoneInput"
          />
          <view wx:if="{{searchPhone}}" class="search-clear" bindtap="clearSearchPhone">
            <t-icon name="close-circle-filled" size="36rpx" color="#d1d5db" />
          </view>
        </view>
        <view 
          class="search-btn {{searchPhone.length === 11 ? 'active' : ''}}" 
          bindtap="searchFarmer"
        >
          <t-loading wx:if="{{searching}}" theme="circular" size="32rpx" color="#ffffff" />
          <text wx:else>搜索</text>
        </view>
      </view>
    </view>
    
    <!-- 搜索结果 -->
    <view wx:if="{{searchResult.id}}" class="search-result">
      <view class="result-card" bindtap="confirmSelectFarmer">
        <view class="result-avatar">
          <text>{{searchResult.name[0]}}</text>
        </view>
        <view class="result-info">
          <view class="result-name-row">
            <text class="result-name">{{searchResult.name}}</text>
            <view class="grade-tag grade-{{searchResult.grade}}">{{searchResult.gradeText}}</view>
          </view>
          <text class="result-phone">{{searchResult.phone}}</text>
          <text class="result-meta">{{searchResult.acreage}}亩 · {{searchResult.addressText}}</text>
        </view>
        <view class="result-select">
          <t-icon name="check" size="40rpx" color="#059669" />
        </view>
      </view>
    </view>
    
    <!-- 空状态 -->
    <view wx:if="{{!searchResult.id && searchedOnce}}" class="search-empty">
      <t-icon name="user-error" size="80rpx" color="#d1d5db" />
      <text>未找到该手机号对应的农户</text>
    </view>
    
    <!-- 初始提示 -->
    <view wx:if="{{!searchResult.id && !searchedOnce}}" class="search-hint-wrap">
      <t-icon name="info-circle" size="40rpx" color="#9ca3af" />
      <text>请输入农户的11位手机号码进行搜索</text>
    </view>
  </view>
</t-popup>

<!-- 日期选择器 -->
<t-date-time-picker
  visible="{{showDatePicker}}"
  mode="date"
  value="{{datePickerValue}}"
  format="YYYY-MM-DD"
  title="选择收购日期"
  bind:confirm="onDateConfirm"
  bind:cancel="onDateCancel"
/>
