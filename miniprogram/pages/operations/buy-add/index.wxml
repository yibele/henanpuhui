<!--
  收购登记页面（仓库工作人员填写）
-->
<view class="acquisition-page">
  <!-- 页面标题 -->
  <view class="page-header">
    <text class="page-title">收购登记</text>
    <text class="page-subtitle">仓库工作人员填写收购信息</text>
  </view>

  <!-- 基本信息 -->
  <view class="form-section">
    <view class="section-header">
      <view class="section-indicator indicator-orange"></view>
      <text class="section-title">基本信息</text>
    </view>
    
    <view class="form-card">
      <!-- 收购日期 -->
      <view class="form-item" bindtap="showDatePicker">
        <text class="form-label required">收购日期</text>
        <view class="form-value-row">
          <text class="form-value">{{form.date || '选择日期'}}</text>
          <t-icon name="calendar" size="40rpx" color="#9ca3af" />
        </view>
      </view>
      
      <view class="form-divider"></view>
      
      <!-- 仓库选择 -->
      <view class="form-item" bindtap="showWarehouseSelect">
        <text class="form-label required">仓库</text>
        <view class="form-value-row">
          <text class="form-value {{selectedWarehouse ? '' : 'form-placeholder'}}">
            {{selectedWarehouse.name || '选择仓库'}}
          </text>
          <t-icon name="chevron-right" size="40rpx" color="#d1d5db" />
        </view>
      </view>
      
      <view class="form-divider"></view>
      
      <!-- 农户选择 -->
      <view class="form-item" bindtap="showFarmerSelect">
        <text class="form-label required">农户姓名</text>
        <view class="form-value-row">
          <text class="form-value {{selectedFarmer ? '' : 'form-placeholder'}}">
            {{selectedFarmer.name || '选择农户'}}
          </text>
          <t-icon name="chevron-right" size="40rpx" color="#d1d5db" />
        </view>
      </view>
      
      <view class="form-divider" wx:if="{{selectedFarmer.id}}"></view>
      
      <!-- 预估收购重量 -->
      <view class="form-item" wx:if="{{selectedFarmer.id}}">
        <text class="form-label">预估收购重量</text>
        <view class="estimated-weight-display">
          <text class="estimated-value">{{estimatedWeight}}</text>
          <text class="estimated-unit">KG</text>
          <text class="estimated-note">（基于种植面积 {{selectedFarmer.acreage || 0}} 亩）</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 称重信息 -->
  <view class="form-section">
    <view class="section-header">
      <view class="section-indicator indicator-blue"></view>
      <text class="section-title">称重信息</text>
    </view>
    
    <view class="form-card">
      <!-- 手重（毛重）-->
      <view class="form-item">
        <text class="form-label required">手重（毛重 KG）</text>
        <view class="input-with-unit">
          <input 
            class="form-input weight-input"
            type="digit"
            placeholder="输入毛重"
            value="{{form.grossWeight}}"
            bindinput="onGrossWeightInput"
          />
          <text class="input-unit">KG</text>
        </view>
      </view>
      
      <view class="form-divider"></view>
      
      <!-- 皮重（容器重量）-->
      <view class="form-item">
        <text class="form-label required">皮重（容器 KG）</text>
        <view class="input-with-unit">
          <input 
            class="form-input weight-input"
            type="digit"
            placeholder="输入皮重"
            value="{{form.tareWeight}}"
            bindinput="onTareWeightInput"
          />
          <text class="input-unit">KG</text>
        </view>
      </view>
      
      <view class="form-divider"></view>
      
      <!-- 水杂率 -->
      <view class="form-item">
        <text class="form-label required">水杂率</text>
        <view class="input-with-unit">
          <input 
            class="form-input"
            type="digit"
            placeholder="输入水杂率"
            value="{{form.moistureRate}}"
            bindinput="onMoistureRateInput"
          />
          <text class="input-unit">%</text>
        </view>
      </view>
      
      <view class="form-divider"></view>
      
      <!-- 水杂（自动计算）-->
      <view class="form-item">
        <text class="form-label">水杂（自动计算）</text>
        <view class="readonly-value-row">
          <text class="readonly-value">{{moistureWeight}}</text>
          <text class="readonly-unit">KG</text>
        </view>
      </view>
      
      <view class="form-divider"></view>
      
      <!-- 净重（自动计算）-->
      <view class="form-item">
        <text class="form-label">净重（自动计算）</text>
        <view class="readonly-value-row">
          <text class="readonly-value readonly-highlight">{{netWeight}}</text>
          <text class="readonly-unit">KG</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 金额信息 -->
  <view class="form-section">
    <view class="section-header">
      <view class="section-indicator indicator-green"></view>
      <text class="section-title">金额信息</text>
    </view>
    
    <view class="form-card">
      <!-- 单价 -->
      <view class="form-item">
        <text class="form-label required">单价（元/KG）</text>
        <view class="input-with-unit">
          <text class="input-prefix">¥</text>
          <input 
            class="form-input price-input"
            type="digit"
            placeholder="输入单价"
            value="{{form.unitPrice}}"
            bindinput="onUnitPriceInput"
          />
          <text class="input-unit">元/KG</text>
        </view>
      </view>
      
      <view class="form-divider"></view>
      
      <!-- 金额（自动计算）-->
      <view class="form-item">
        <text class="form-label">金额（自动计算）</text>
        <view class="amount-display">
          <text class="amount-value">{{totalAmountWan}}</text>
          <text class="amount-unit">万元</text>
          <view class="amount-formula" wx:if="{{netWeight && form.unitPrice}}">
            <text>{{netWeight}} KG × {{form.unitPrice}} 元 = ¥{{totalAmount}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 备注信息 -->
  <view class="form-section">
    <view class="section-header">
      <view class="section-indicator indicator-purple"></view>
      <text class="section-title">备注信息</text>
    </view>
    
    <view class="form-card">
      <view class="form-item form-item-textarea">
        <text class="form-label">备注</text>
        <textarea 
          class="form-textarea"
          placeholder="请输入备注信息（选填）"
          value="{{form.remark}}"
          bindinput="onRemarkInput"
          maxlength="200"
          show-confirm-bar="{{false}}"
        />
        <view class="textarea-counter">{{form.remark.length}}/200</view>
      </view>
    </view>
  </view>

  <!-- 提示信息 -->
  <view class="tips">
    <view class="tip-item">
      <t-icon name="info-circle-filled" size="28rpx" color="#f97316" />
      <text>预估收购重量 = 种植面积 × 300 KG/亩</text>
    </view>
    <view class="tip-item">
      <t-icon name="info-circle-filled" size="28rpx" color="#f97316" />
      <text>净重 = 手重 - 皮重 - 水杂</text>
    </view>
    <view class="tip-item">
      <t-icon name="info-circle-filled" size="28rpx" color="#f97316" />
      <text>水杂 = (手重 - 皮重) × 水杂率</text>
    </view>
    <view class="tip-item">
      <t-icon name="info-circle-filled" size="28rpx" color="#f97316" />
      <text>金额 = 净重 × 单价 ÷ 10000（万元）</text>
    </view>
  </view>

  <!-- 底部按钮 -->
  <view class="bottom-actions">
    <button class="btn btn-cancel" bindtap="onCancel">取消</button>
    <button 
      class="btn btn-submit btn-orange {{!canSubmit ? 'btn-disabled' : ''}}" 
      bindtap="onSubmit"
      loading="{{submitting}}"
      disabled="{{!canSubmit}}"
    >确认收购</button>
  </view>
</view>

<!-- 仓库选择弹窗 -->
<t-popup 
  visible="{{showWarehousePopup}}" 
  placement="bottom"
  bind:visible-change="onWarehousePopupChange"
>
  <view class="popup-container">
    <view class="popup-header">
      <text class="popup-title">选择仓库</text>
      <view class="popup-close" bindtap="closeWarehousePopup">
        <t-icon name="close" size="44rpx" color="#6b7280" />
      </view>
    </view>
    
    <scroll-view class="popup-list" scroll-y>
      <view 
        wx:for="{{warehouses}}" 
        wx:key="id"
        class="popup-item {{selectedWarehouse.id === item.id ? 'selected' : ''}}"
        data-warehouse="{{item}}"
        bindtap="onSelectWarehouse"
      >
        <view class="popup-item-left">
          <text class="popup-item-name">{{item.name}}</text>
          <text class="popup-item-sub">编号：{{item.code}} | {{item.location}}</text>
        </view>
        <t-icon 
          wx:if="{{selectedWarehouse.id === item.id}}" 
          name="check-circle-filled" 
          size="44rpx" 
          color="#f97316" 
        />
      </view>
    </scroll-view>
  </view>
</t-popup>

<!-- 农户选择弹窗 -->
<t-popup 
  visible="{{showFarmerPopup}}" 
  placement="bottom"
  bind:visible-change="onFarmerPopupChange"
>
  <view class="popup-container">
    <view class="popup-header">
      <text class="popup-title">选择农户</text>
      <view class="popup-close" bindtap="closeFarmerPopup">
        <t-icon name="close" size="44rpx" color="#6b7280" />
      </view>
    </view>
    
    <!-- 搜索栏 -->
    <view class="popup-search">
      <view class="search-input-wrap">
        <t-icon name="search" size="36rpx" color="#9ca3af" />
        <input 
          class="search-input"
          placeholder="搜索姓名或手机号"
          value="{{searchValue}}"
          bindinput="onSearchFarmer"
        />
        <view class="search-clear" wx:if="{{searchValue}}" bindtap="clearSearch">
          <t-icon name="close-circle-filled" size="32rpx" color="#d1d5db" />
        </view>
      </view>
    </view>
    
    <scroll-view class="popup-list" scroll-y>
      <view 
        wx:for="{{filteredFarmers}}" 
        wx:key="id"
        class="popup-item {{selectedFarmer.id === item.id ? 'selected' : ''}}"
        data-farmer="{{item}}"
        bindtap="onSelectFarmer"
      >
        <view class="popup-item-left">
          <view class="popup-item-name-row">
            <text class="popup-item-name">{{item.name}}</text>
            <view class="grade-badge grade-{{item.grade}}">{{item.gradeText}}</view>
          </view>
          <text class="popup-item-sub">{{item.phone}} | {{item.addressText}}</text>
        </view>
        <t-icon 
          wx:if="{{selectedFarmer.id === item.id}}" 
          name="check-circle-filled" 
          size="44rpx" 
          color="#f97316" 
        />
      </view>
      
      <!-- 空状态 -->
      <view class="empty-state" wx:if="{{filteredFarmers.length === 0}}">
        <t-icon name="search" size="80rpx" color="#d1d5db" />
        <text>未找到匹配的农户</text>
      </view>
    </scroll-view>
  </view>
</t-popup>

<!-- 日期选择器 -->
<t-date-time-picker
  visible="{{showDatePicker}}"
  mode="date"
  value="{{datePickerValue}}"
  format="YYYY-MM-DD"
  title="选择收购日期"
  bind:confirm="onDateConfirm"
  bind:cancel="onDateCancel"
/>
