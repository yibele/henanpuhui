<!--
  发放种苗页面
  助理录入/编辑种苗发放信息
-->
<view class="seed-add-page">
  <!-- 页面标题 -->
  <view class="page-header">
    <text class="page-title">{{pageTitle}}</text>
    <text class="page-subtitle">{{isEditMode ? '修改发苗记录信息' : '录入农户领取种苗信息'}}</text>
  </view>

  <!-- 选择农户卡片 -->
  <view class="form-section">
    <view class="section-header">
      <view class="section-indicator indicator-green"></view>
      <text class="section-title">选择农户</text>
    </view>
    
    <view class="form-card" bindtap="showFarmerSelect">
      <view class="farmer-select-row">
        <view class="farmer-info" wx:if="{{selectedFarmer}}">
          <text class="farmer-name">{{selectedFarmer.name}}</text>
          <text class="farmer-phone">{{selectedFarmer.phone}}</text>
        </view>
        <view class="farmer-placeholder" wx:else>
          <t-icon name="user-add" size="48rpx" color="#9ca3af" />
          <text>点击选择农户</text>
        </view>
        <t-icon name="chevron-right" size="40rpx" color="#d1d5db" />
      </view>
    </view>

    <!-- 面积统计（选择农户后显示） -->
    <view class="area-stats-card" wx:if="{{selectedFarmer}}">
      <view class="area-stats-row">
        <view class="area-stat-item">
          <text class="area-stat-label">签约总面积</text>
          <text class="area-stat-value total">{{areaStats.totalArea}} 亩</text>
        </view>
        <view class="area-stat-divider"></view>
        <view class="area-stat-item">
          <text class="area-stat-label">已发放面积</text>
          <text class="area-stat-value used">{{areaStats.distributedArea}} 亩</text>
        </view>
        <view class="area-stat-divider"></view>
        <view class="area-stat-item">
          <text class="area-stat-label">剩余面积</text>
          <text class="area-stat-value remaining">{{areaStats.remainingArea}} 亩</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 发放信息 -->
  <view class="form-section">
    <view class="section-header">
      <view class="section-indicator indicator-blue"></view>
      <text class="section-title">发放信息</text>
    </view>
    
    <view class="form-card">
      <!-- 发放时间 -->
      <view class="form-item" bindtap="showDatePicker">
        <text class="form-label required">发放时间</text>
        <view class="form-value-row">
          <text class="form-value">{{form.distributeTime || '选择日期时间'}}</text>
          <t-icon name="calendar" size="40rpx" color="#9ca3af" />
        </view>
      </view>
      
      <view class="form-divider"></view>
      
      <!-- 发放数量 -->
      <view class="form-item">
        <text class="form-label required">发放数量（株）</text>
        <view class="input-with-unit">
          <input 
            class="form-input"
            type="number"
            placeholder="输入数量"
            value="{{form.quantity}}"
            bindinput="onQuantityInput"
          />
          <text class="input-unit">株</text>
        </view>
      </view>
      
      <view class="form-divider"></view>
      
      <!-- 单价 -->
      <view class="form-item">
        <text class="form-label required">单价（元/株）</text>
        <view class="input-with-unit">
          <input 
            class="form-input"
            type="digit"
            placeholder="输入单价"
            value="{{form.unitPrice}}"
            bindinput="onUnitPriceInput"
          />
          <text class="input-unit">元/株</text>
        </view>
      </view>
      
      <view class="form-divider"></view>
      
      <!-- 已发放金额（自动计算） -->
      <view class="form-item">
        <text class="form-label">已发放金额</text>
        <view class="auto-calc-value">
          <text class="calc-amount">¥{{calculatedAmount}}</text>
          <text class="calc-formula" wx:if="{{form.quantity && form.unitPrice}}">({{form.quantity}}株 × {{form.unitPrice}}元)</text>
          <text class="calc-hint" wx:else>自动计算：数量 × 单价</text>
        </view>
      </view>
      
      <view class="form-divider"></view>
      
      <!-- 已发放面积 -->
      <view class="form-item">
        <view class="form-label-row">
          <text class="form-label required">已发放面积（亩）</text>
          <text class="form-hint" wx:if="{{selectedFarmer}}">/ 总面积 {{selectedFarmer.acreage || 0}} 亩</text>
        </view>
        <view class="input-with-unit">
          <input 
            class="form-input"
            type="digit"
            placeholder="输入面积"
            value="{{form.distributedArea}}"
            bindinput="onDistributedAreaInput"
          />
          <text class="input-unit">亩</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 领取信息 -->
  <view class="form-section">
    <view class="section-header">
      <view class="section-indicator indicator-orange"></view>
      <text class="section-title">领取信息</text>
    </view>
    
    <view class="form-card">
      <!-- 领取人 -->
      <view class="form-item">
        <text class="form-label required">领取人</text>
        <input 
          class="form-input"
          placeholder="输入领取人姓名"
          value="{{form.receiverName}}"
          bindinput="onReceiverNameInput"
        />
      </view>
      
      <view class="form-divider"></view>
      
      <!-- 领取地点 -->
      <view class="form-item">
        <text class="form-label required">领取地点</text>
        <input 
          class="form-input"
          placeholder="输入领取地点"
          value="{{form.receiveLocation}}"
          bindinput="onReceiveLocationInput"
        />
      </view>
    </view>
  </view>

  <!-- 负责人信息 -->
  <view class="form-section">
    <view class="section-header">
      <view class="section-indicator indicator-purple"></view>
      <text class="section-title">发苗负责人</text>
    </view>
    
    <view class="form-card">
      <view class="form-item">
        <text class="form-label required">负责人姓名</text>
        <input 
          class="form-input"
          placeholder="输入发苗负责人姓名"
          value="{{form.managerName}}"
          bindinput="onManagerNameInput"
        />
      </view>
    </view>
  </view>

  <!-- 提示信息 -->
  <view class="tips">
    <view class="tip-item">
      <t-icon name="info-circle-filled" size="28rpx" color="#059669" />
      <text>已发放金额自动计算：发放数量（株）× 单价（元/株）</text>
    </view>
  </view>

  <!-- 底部按钮 -->
  <view class="bottom-actions">
    <button class="btn btn-cancel" bindtap="onCancel">取消</button>
    <button 
      class="btn btn-submit {{!canSubmit ? 'btn-disabled' : ''}}" 
      bindtap="onSubmit"
      loading="{{submitting}}"
      disabled="{{!canSubmit}}"
    >{{submitBtnText}}</button>
  </view>
</view>

<!-- 农户选择弹窗 -->
<t-popup 
  visible="{{showFarmerPopup}}" 
  placement="bottom"
  bind:visible-change="onFarmerPopupChange"
>
  <view class="farmer-popup">
    <view class="popup-header">
      <text class="popup-title">选择农户</text>
      <view class="popup-close" bindtap="closeFarmerPopup">
        <t-icon name="close" size="44rpx" color="#6b7280" />
      </view>
    </view>
    
    <!-- 搜索栏 -->
    <view class="popup-search">
      <view class="search-input-wrap">
        <t-icon name="search" size="36rpx" color="#9ca3af" />
        <input 
          class="search-input"
          placeholder="搜索姓名或手机号"
          value="{{searchValue}}"
          bindinput="onSearchFarmer"
        />
        <view class="search-clear" wx:if="{{searchValue}}" bindtap="clearSearch">
          <t-icon name="close-circle-filled" size="32rpx" color="#d1d5db" />
        </view>
      </view>
    </view>
    
    <!-- 农户列表 -->
    <scroll-view class="farmer-list" scroll-y>
      <view 
        wx:for="{{filteredFarmers}}" 
        wx:key="id"
        class="farmer-item {{selectedFarmer.id === item.id ? 'selected' : ''}}"
        data-farmer="{{item}}"
        bindtap="onSelectFarmer"
      >
        <view class="farmer-item-left">
          <view class="farmer-avatar">
            <text>{{item.name[0]}}</text>
          </view>
          <view class="farmer-item-info">
            <view class="farmer-item-name-row">
              <text class="farmer-item-name">{{item.name}}</text>
              <view class="grade-badge grade-{{item.grade}}">{{item.gradeText}}</view>
            </view>
            <text class="farmer-item-phone">{{item.phone}}</text>
            <text class="farmer-item-addr">{{item.addressText}}</text>
          </view>
        </view>
        <view class="farmer-item-right">
          <view class="item-acreage">
            {{item.acreage || 0}} 亩
          </view>
          <t-icon 
            wx:if="{{selectedFarmer.id === item.id}}" 
            name="check-circle-filled" 
            size="44rpx" 
            color="#059669" 
          />
        </view>
      </view>
      
      <!-- 空状态 -->
      <view class="empty-state" wx:if="{{filteredFarmers.length === 0}}">
        <t-icon name="search" size="80rpx" color="#d1d5db" />
        <text>未找到匹配的农户</text>
      </view>
    </scroll-view>
  </view>
</t-popup>

<!-- 日期时间选择器 -->
<t-date-time-picker
  visible="{{showDatePicker}}"
  mode="minute"
  value="{{datePickerValue}}"
  format="YYYY-MM-DD HH:mm"
  title="选择发放时间"
  bind:confirm="onDateConfirm"
  bind:cancel="onDateCancel"
/>
