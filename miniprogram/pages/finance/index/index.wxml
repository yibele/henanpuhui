<!--
  结算管理页面
  根据角色显示不同视图：会计看待审核，出纳看待付款
-->
<view class="finance-page">
  <!-- 角色提示 -->
  <view class="role-header">
    <view class="role-info">
      <text class="role-label">{{roleLabel}}</text>
      <text class="role-title">结算中心</text>
    </view>
  </view>

  <!-- 汇总统计卡片 -->
  <view class="overview-card">
    <view class="overview-stats">
      <!-- 出纳视图：待付款、已付款 -->
      <block wx:if="{{userRole === 'cashier'}}">
        <view class="overview-stat-item">
          <text class="stat-value stat-value-orange">{{overview.approvedCount}}</text>
          <text class="stat-label">待付款</text>
        </view>
        <view class="overview-stat-item">
          <text class="stat-value stat-value-blue">{{formattedOverview.approvedAmount}}</text>
          <text class="stat-label">待付金额</text>
        </view>
        <view class="overview-stat-item">
          <text class="stat-value stat-value-green">{{overview.completedCount}}</text>
          <text class="stat-label">已付款</text>
        </view>
      </block>
      <!-- 会计视图：待审核、待付款、已完成 -->
      <block wx:else>
        <view class="overview-stat-item">
          <text class="stat-value stat-value-orange">{{counts.pending}}</text>
          <text class="stat-label">待审核</text>
        </view>
        <view class="overview-stat-item">
          <text class="stat-value stat-value-blue">{{overview.approvedCount}}</text>
          <text class="stat-label">待付款</text>
        </view>
        <view class="overview-stat-item">
          <text class="stat-value stat-value-green">{{overview.completedCount}}</text>
          <text class="stat-label">已完成</text>
        </view>
      </block>
    </view>
  </view>

  <!-- 搜索栏 -->
  <view class="search-bar">
    <view class="search-input-wrap">
      <t-icon name="search" size="36rpx" color="#9ca3af" />
      <input 
        class="search-input" 
        placeholder="搜索农户姓名或电话"
        value="{{searchValue}}"
        bindinput="onSearchInput"
        bindconfirm="onSearchConfirm"
      />
      <t-icon 
        wx:if="{{searchValue}}" 
        name="close-circle-filled" 
        size="36rpx" 
        color="#9ca3af" 
        bindtap="onClearSearch"
      />
    </view>
  </view>

  <!-- Tab切换 -->
  <view class="tab-bar">
    <view 
      class="tab-item {{currentTab === index ? 'active' : ''}}"
      wx:for="{{tabs}}"
      wx:key="index"
      bindtap="onTabChange"
      data-tab="{{index}}"
    >
      <text class="tab-text">{{item}}</text>
    </view>
  </view>

  <!-- 结算列表 -->
  <view class="settlement-list" wx:if="{{settlements.length > 0}}">
    <view 
      class="settlement-card"
      wx:for="{{settlements}}"
      wx:key="settlementId"
      bindtap="onSettlementTap"
      data-id="{{item.settlementId}}"
    >
      <!-- 状态标识 -->
      <view class="status-indicator status-indicator-{{item.statusColor}}"></view>
      
      <view class="card-content">
        <!-- 头部 -->
        <view class="card-header">
          <view class="farmer-info">
            <text class="farmer-name">{{item.farmerName}}</text>
            <text class="farmer-phone" wx:if="{{item.farmerPhone}}">{{item.farmerPhone}}</text>
          </view>
          <view class="status-badge status-badge-{{item.statusColor}}">
            <text>{{item.statusLabel}}</text>
          </view>
        </view>
        
        <!-- 金额信息 -->
        <view class="amount-grid">
          <view class="amount-item">
            <text class="amount-label">收购货款</text>
            <text class="amount-value">¥{{item.formattedAmount}}</text>
          </view>
          <view class="amount-item" wx:if="{{item.status !== 'pending'}}">
            <text class="amount-label">扣款</text>
            <text class="amount-value amount-value-red">-¥{{item.formattedDeduction}}</text>
          </view>
          <view class="amount-item" wx:if="{{item.status !== 'pending'}}">
            <text class="amount-label">实付</text>
            <text class="amount-value amount-value-green">¥{{item.formattedActual}}</text>
          </view>
        </view>
        
        <!-- 底部信息 -->
        <view class="card-footer">
          <text class="date">{{item.createTimeStr}}</text>
          <view class="warehouse-info" wx:if="{{item.warehouseName}}">
            <t-icon name="location" size="28rpx" color="#9ca3af" />
            <text>{{item.warehouseName}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 空状态 -->
  <view class="empty-state" wx:if="{{!isLoading && settlements.length === 0}}">
    <t-icon name="folder-open" size="120rpx" color="#d1d5db" />
    <text class="empty-text">暂无结算记录</text>
  </view>

  <!-- 加载状态 -->
  <view class="loading-more" wx:if="{{isLoading}}">
    <t-loading theme="circular" size="40rpx" text="加载中..." />
  </view>
  
  <!-- 加载完成提示 -->
  <view class="load-complete" wx:if="{{!hasMore && settlements.length > 0}}">
    <text>已加载全部 {{total}} 条记录</text>
  </view>

  <!-- 底部间距 -->
  <view class="bottom-space"></view>
</view>
