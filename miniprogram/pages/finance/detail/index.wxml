<!--
  结算详情页面（管理层只读视图）
  只展示数据，不可操作
  审核、支付等操作属于财务权限
-->
<view class="detail-page" wx:if="{{settlement}}">
  <!-- 状态卡片 -->
  <view class="status-card status-card-{{statusConfig.color}}">
    <view class="status-header">
      <view class="status-badge status-badge-{{statusConfig.color}}">
        <text>{{statusConfig.label}}</text>
      </view>
      <text class="status-date">{{settlement.date}}</text>
    </view>
    <text class="status-desc">{{statusConfig.desc}}</text>
  </view>

  <!-- 农户信息 -->
  <view class="section">
    <view class="section-title">农户信息</view>
    <view class="info-card">
      <view class="info-row">
        <text class="info-label">农户姓名</text>
        <text class="info-value">{{settlement.farmerName}}</text>
      </view>
      <view class="info-row">
        <text class="info-label">联系电话</text>
        <text class="info-value">{{settlement.farmerPhone}}</text>
      </view>
      <view class="info-row" wx:if="{{settlement.auditor}}">
        <text class="info-label">审核人</text>
        <text class="info-value">{{settlement.auditor}}</text>
      </view>
      <view class="info-row" wx:if="{{settlement.auditTime}}">
        <text class="info-label">审核时间</text>
        <text class="info-value">{{settlement.auditTime}}</text>
      </view>
    </view>
  </view>

  <!-- 金额计算区 -->
  <view class="section">
    <view class="section-title">金额明细</view>
    <view class="calc-card">
      <!-- 收购总额 -->
      <view class="calc-row calc-row-main">
        <text class="calc-label">收购总额</text>
        <text class="calc-value">¥{{formatted.totalAcquisition}}</text>
      </view>
      
      <!-- 扣款明细 -->
      <view class="calc-group">
        <view class="calc-group-title">扣款明细</view>
        <view class="calc-row calc-row-sub">
          <text class="calc-label">种苗扣款</text>
          <text class="calc-value calc-value-red">-¥{{formatted.seedDeduction}}</text>
        </view>
        <view class="calc-row calc-row-sub">
          <text class="calc-label">农资扣款</text>
          <text class="calc-value calc-value-red">-¥{{formatted.fertilizerDeduction}}</text>
        </view>
        <view class="calc-row calc-row-sub">
          <text class="calc-label">其他扣款</text>
          <text class="calc-value calc-value-red">-¥{{formatted.otherDeduction}}</text>
        </view>
        <view class="calc-row calc-row-total">
          <text class="calc-label">扣款合计</text>
          <text class="calc-value calc-value-red">-¥{{formatted.totalDeduction}}</text>
        </view>
      </view>
      
      <!-- 计算结果 -->
      <view class="calc-divider"></view>
      <view class="calc-row calc-row-result">
        <text class="calc-label">系统计算应付</text>
        <text class="calc-value">¥{{formatted.calculatedPayment}}</text>
      </view>
      
      <!-- 调整后金额（如有调整显示） -->
      <view class="calc-row calc-row-adjust-readonly" wx:if="{{settlement.adjustedPayment !== settlement.calculatedPayment}}">
        <text class="calc-label">会计调整后</text>
        <text class="calc-value calc-value-orange">¥{{formatted.adjustedPayment}}</text>
      </view>
      
      <!-- 最终应付 -->
      <view class="calc-row calc-row-final">
        <text class="calc-label">最终应付</text>
        <text class="calc-value calc-value-green">¥{{formatted.finalPayment}}</text>
      </view>
    </view>
  </view>

  <!-- 预付款记录 -->
  <view class="section" wx:if="{{settlement.prepayments.length > 0}}">
    <view class="section-title">预付款记录</view>
    <view class="prepay-card">
      <view class="prepay-total">
        <text class="prepay-total-label">预付款合计</text>
        <text class="prepay-total-value">¥{{formatted.totalPrepaid}}</text>
      </view>
      <view class="prepay-list">
        <view class="prepay-item" wx:for="{{settlement.prepayments}}" wx:key="id">
          <view class="prepay-info">
            <text class="prepay-amount">¥{{item.amount}}</text>
            <text class="prepay-remark">{{item.remark || '预付款'}}</text>
          </view>
          <view class="prepay-meta">
            <text>{{item.paymentTime}}</text>
            <text>{{item.operator}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 支付进度与记录 -->
  <view class="section">
    <view class="section-header">
      <text class="section-title">支付记录</text>
      <view class="section-badge">
        <text>{{settlement.payments.length}}笔</text>
      </view>
    </view>
    
    <!-- 支付进度 -->
    <view class="payment-progress-card">
      <view class="progress-header">
        <text class="progress-label">支付进度</text>
        <text class="progress-percent">{{paymentProgress}}%</text>
      </view>
      <view class="progress-bar-wrap">
        <view class="progress-bar-fill" style="width: {{paymentProgress}}%;"></view>
      </view>
      <view class="progress-amounts">
        <view class="progress-amount">
          <text class="amount-label">已支付</text>
          <text class="amount-value amount-value-green">¥{{formatted.totalPaid}}</text>
        </view>
        <view class="progress-amount">
          <text class="amount-label">待支付</text>
          <text class="amount-value amount-value-orange">¥{{formatted.remainingPayment}}</text>
        </view>
      </view>
    </view>
    
    <!-- 支付列表 -->
    <view class="payment-list" wx:if="{{settlement.payments.length > 0}}">
      <view class="payment-item" wx:for="{{settlement.payments}}" wx:key="id">
        <view class="payment-index">{{index + 1}}</view>
        <view class="payment-content">
          <view class="payment-main">
            <text class="payment-amount">¥{{item.amount}}</text>
            <text class="payment-method">{{item.paymentMethod}}</text>
          </view>
          <view class="payment-sub">
            <text>{{item.paymentTime}}</text>
            <text>{{item.operator}}</text>
            <text wx:if="{{item.remark}}">{{item.remark}}</text>
          </view>
        </view>
        <t-icon name="check-circle-filled" size="40rpx" color="#059669" />
      </view>
    </view>
    
    <view class="empty-tip" wx:else>
      <text>暂无支付记录</text>
    </view>
  </view>

  <!-- 审核备注 -->
  <view class="section" wx:if="{{settlement.auditRemark}}">
    <view class="section-title">审核备注</view>
    <view class="remark-card">
      <text>{{settlement.auditRemark}}</text>
    </view>
  </view>

  <!-- 底部间距 -->
  <view class="bottom-space"></view>
</view>
