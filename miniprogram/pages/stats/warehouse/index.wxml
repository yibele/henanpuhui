<!--
  仓库管理列表页面
  显示所有仓库的库存概览，支持打包和出库操作
-->
<view class="page-container">
  <!-- 页面标题 -->
  <view class="page-header">
    <text class="page-title">仓库管理</text>
    <text class="page-subtitle">{{todayDate}}</text>
  </view>

  <!-- 加载状态 -->
  <view class="loading-wrap" wx:if="{{loading}}">
    <t-loading theme="circular" size="40rpx" text="加载中..." />
  </view>

  <!-- 仓库列表 -->
  <view class="warehouse-list" wx:else>
    <view 
      class="warehouse-card {{item.isMyWarehouse ? 'my-warehouse' : ''}}" 
      wx:for="{{warehouses}}" 
      wx:key="_id"
      bindtap="goToDetail"
      data-warehouse="{{item}}"
    >
      <!-- 仓库标题行 -->
      <view class="card-header">
        <view class="warehouse-name-wrap">
          <text class="warehouse-name">{{item.name}}</text>
          <view class="my-tag" wx:if="{{item.isMyWarehouse}}">我的仓库</view>
        </view>
        <view class="stock-badge">
          <text class="stock-value">{{item.stock.weight}}</text>
          <text class="stock-unit">KG</text>
        </view>
      </view>

      <!-- 今日数据 -->
      <view class="today-section">
        <view class="section-label">今日数据</view>
        <view class="data-row">
          <view class="data-item">
            <text class="data-label">收购</text>
            <text class="data-value">{{item.today.acquisitionWeight}}kg</text>
          </view>
          <view class="data-item">
            <text class="data-label">打包</text>
            <text class="data-value">{{item.today.packCount}}包</text>
          </view>
          <view class="data-item">
            <text class="data-label">出库</text>
            <text class="data-value">{{item.today.outboundWeight}}kg</text>
          </view>
        </view>
      </view>

      <!-- 累计库存 -->
      <view class="stock-section">
        <view class="stock-row">
          <view class="stock-item">
            <text class="stock-label">累计收购</text>
            <text class="stock-num">{{item.total.acquisitionWeight}}kg</text>
          </view>
          <view class="stock-item">
            <text class="stock-label">累计打包</text>
            <text class="stock-num">{{item.total.packCount}}包</text>
          </view>
          <view class="stock-item">
            <text class="stock-label">累计出库</text>
            <text class="stock-num">{{item.total.outboundWeight}}kg</text>
          </view>
          <view class="stock-item highlight">
            <text class="stock-label">库存包数</text>
            <text class="stock-num">{{item.stock.count}}包</text>
          </view>
        </view>
      </view>

      <!-- 操作按钮（仅自己仓库显示） -->
      <view class="action-row" wx:if="{{item.isMyWarehouse}}" catchtap="showOperationPopup" data-warehouse="{{item}}">
        <t-button theme="primary" size="small" block>填写打包/出库</t-button>
      </view>
    </view>

    <!-- 空状态 -->
    <view class="empty-state" wx:if="{{warehouses.length === 0}}">
      <t-icon name="shop" size="80rpx" color="#d1d5db" />
      <text class="empty-text">暂无仓库数据</text>
    </view>
  </view>

  <!-- 底部安全区 -->
  <view class="safe-bottom"></view>
</view>

<!-- 操作弹窗 -->
<t-popup
  visible="{{showPopup}}"
  placement="bottom"
  bind:visible-change="onPopupVisibleChange"
>
  <view class="popup-content">
    <view class="popup-header">
      <text class="popup-title">{{currentWarehouse.name}} - 仓库操作</text>
      <view class="popup-close" bindtap="closePopup">
        <t-icon name="close" size="40rpx" />
      </view>
    </view>

    <!-- 操作类型切换 -->
    <view class="operation-tabs">
      <view class="op-tab {{operationType === 'pack' ? 'active' : ''}}" bindtap="switchOperationType" data-type="pack">
        <text>打包</text>
      </view>
      <view class="op-tab {{operationType === 'outbound' ? 'active' : ''}}" bindtap="switchOperationType" data-type="outbound">
        <text>出库</text>
      </view>
    </view>

    <!-- 打包表单 -->
    <view class="form-section" wx:if="{{operationType === 'pack'}}">
      <view class="form-row">
        <text class="form-label">打包数量</text>
        <view class="form-input-wrap">
          <input 
            class="form-input" 
            type="number" 
            placeholder="请输入包数" 
            value="{{packCount}}"
            bindinput="onPackCountInput"
          />
          <text class="form-unit">包</text>
        </view>
      </view>
    </view>

    <!-- 出库表单 -->
    <view class="form-section" wx:if="{{operationType === 'outbound'}}">
      <view class="form-row">
        <text class="form-label">出库重量</text>
        <view class="form-input-wrap">
          <input 
            class="form-input" 
            type="digit" 
            placeholder="请输入重量（可负）" 
            value="{{outboundWeight}}"
            bindinput="onOutboundWeightInput"
          />
          <text class="form-unit">KG</text>
        </view>
      </view>
      <view class="form-row">
        <text class="form-label">出库包数</text>
        <view class="form-input-wrap">
          <input 
            class="form-input" 
            type="number" 
            placeholder="请输入包数" 
            value="{{outboundCount}}"
            bindinput="onOutboundCountInput"
          />
          <text class="form-unit">包</text>
        </view>
      </view>
    </view>

    <!-- 备注 -->
    <view class="form-section">
      <view class="form-row">
        <text class="form-label">备注</text>
        <input 
          class="form-input full" 
          placeholder="选填" 
          value="{{remark}}"
          bindinput="onRemarkInput"
        />
      </view>
    </view>

    <!-- 提交按钮 -->
    <view class="popup-footer">
      <t-button theme="primary" size="large" block bindtap="submitOperation" loading="{{submitting}}">
        确认提交
      </t-button>
    </view>
  </view>
</t-popup>
