<!--
  签约农户统计详情页
  管理层查看签约农户的总体情况和单独情况
-->
<view class="page-container">
  <!-- 搜索栏 -->
  <view class="search-bar">
    <view class="search-input-wrap">
      <t-icon name="search" size="36rpx" color="#9ca3af" />
      <input 
        class="search-input" 
        placeholder="搜索手机号或姓名" 
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        bindconfirm="onSearch"
      />
      <view class="search-clear" wx:if="{{searchKeyword}}" bindtap="clearSearch">
        <t-icon name="close-circle-filled" size="32rpx" color="#d1d5db" />
      </view>
    </view>
    <view class="search-btn" bindtap="onSearch">
      <text>搜索</text>
    </view>
  </view>

  <!-- Tab 切换：昨日/全年 -->
  <view class="tab-bar">
    <view class="tab-item {{currentTab === 0 ? 'active' : ''}}" bindtap="switchTab" data-tab="0">
      <text>昨日新增</text>
    </view>
    <view class="tab-item {{currentTab === 1 ? 'active' : ''}}" bindtap="switchTab" data-tab="1">
      <text>全年度累计</text>
    </view>
  </view>

  <!-- 汇总统计卡片 -->
  <view class="card summary-card">
    <view class="summary-row">
      <view class="summary-item">
        <text class="summary-value">{{summary.totalFarmers}}</text>
        <text class="summary-label">签约农户(户)</text>
      </view>
      <view class="summary-item">
        <text class="summary-value">{{summary.totalAcreage}}</text>
        <text class="summary-label">种植面积</text>
      </view>
      <view class="summary-item">
        <text class="summary-value highlight">{{summary.totalDeposit}}</text>
        <text class="summary-label">定金总额</text>
      </view>
    </view>
    
    <!-- 等级分布 -->
    <view class="grade-distribution">
      <view class="grade-bar-wrap">
        <view class="grade-bar grade-gold" style="width: {{summary.goldPercent}}%;">
          <text wx:if="{{summary.goldPercent > 8}}">{{summary.goldPercent}}%</text>
        </view>
        <view class="grade-bar grade-silver" style="width: {{summary.silverPercent}}%;">
          <text wx:if="{{summary.silverPercent > 8}}">{{summary.silverPercent}}%</text>
        </view>
        <view class="grade-bar grade-bronze" style="width: {{summary.bronzePercent}}%;">
          <text wx:if="{{summary.bronzePercent > 8}}">{{summary.bronzePercent}}%</text>
        </view>
      </view>
      <view class="grade-legend">
        <view class="legend-item">
          <view class="legend-dot legend-gold"></view>
          <text>金牌 {{summary.gold}}户</text>
        </view>
        <view class="legend-item">
          <view class="legend-dot legend-silver"></view>
          <text>银牌 {{summary.silver}}户</text>
        </view>
        <view class="legend-item">
          <view class="legend-dot legend-bronze"></view>
          <text>铜牌 {{summary.bronze}}户</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 筛选条件 -->
  <view class="filter-bar">
    <view class="filter-item {{filterGrade === '' ? 'active' : ''}}" bindtap="setFilterGrade" data-grade="">
      <text>全部</text>
    </view>
    <view class="filter-item {{filterGrade === 'gold' ? 'active' : ''}}" bindtap="setFilterGrade" data-grade="gold">
      <view class="filter-dot filter-gold"></view>
      <text>金牌</text>
    </view>
    <view class="filter-item {{filterGrade === 'silver' ? 'active' : ''}}" bindtap="setFilterGrade" data-grade="silver">
      <view class="filter-dot filter-silver"></view>
      <text>银牌</text>
    </view>
    <view class="filter-item {{filterGrade === 'bronze' ? 'active' : ''}}" bindtap="setFilterGrade" data-grade="bronze">
      <view class="filter-dot filter-bronze"></view>
      <text>铜牌</text>
    </view>
  </view>

  <!-- 负责人筛选 -->
  <view class="salesman-filter" bindtap="showSalesmanPicker">
    <text class="salesman-filter-label">负责人：</text>
    <text class="salesman-filter-value">{{filterSalesmanName || '全部'}}</text>
    <t-icon name="chevron-down" size="32rpx" color="#6b7280" />
  </view>

  <!-- 农户列表 -->
  <view class="section-title">
    <text>农户列表</text>
    <text class="list-count">共 {{filteredList.length}} 户</text>
  </view>

  <view class="farmer-list">
    <view class="farmer-item" wx:for="{{displayList}}" wx:key="id" bindtap="goFarmerDetail" data-id="{{item.id}}">
      <view class="farmer-info">
        <view class="farmer-header">
          <text class="farmer-name">{{item.name}}</text>
          <view class="farmer-grade grade-tag-{{item.grade}}">
            <text>{{item.gradeText}}</text>
          </view>
        </view>
        <view class="farmer-detail">
          <text class="farmer-phone">{{item.phone}}</text>
          <text class="farmer-divider">|</text>
          <text class="farmer-acreage">{{item.acreage}}亩</text>
          <text class="farmer-divider">|</text>
          <text class="farmer-deposit">定金 ¥{{item.deposit}}</text>
        </view>
        <view class="farmer-extra">
          <text class="farmer-manager">负责人：{{item.manager}}</text>
          <text class="farmer-date">{{item.contractDate}}</text>
        </view>
      </view>
      <t-icon name="chevron-right" size="36rpx" color="#d1d5db" />
    </view>

    <!-- 加载更多 -->
    <view class="load-more" wx:if="{{hasMore}}" bindtap="loadMore">
      <text>{{loading ? '加载中...' : '加载更多'}}</text>
    </view>

    <!-- 空状态 -->
    <view class="empty-state" wx:if="{{filteredList.length === 0 && !loading}}">
      <t-icon name="info-circle" size="80rpx" color="#d1d5db" />
      <text class="empty-text">{{searchKeyword ? '未找到匹配的农户' : '暂无数据'}}</text>
    </view>
  </view>

  <!-- 底部安全区 -->
  <view class="safe-bottom"></view>
</view>

<!-- 负责人选择弹窗 -->
<t-popup visible="{{showSalesmanPopup}}" placement="bottom" bind:visible-change="onSalesmanPopupChange">
  <view class="salesman-popup">
    <view class="popup-header">
      <text class="popup-title">选择负责人</text>
      <view class="popup-close" bindtap="closeSalesmanPopup">
        <t-icon name="close" size="40rpx" color="#6b7280" />
      </view>
    </view>
    <scroll-view class="popup-content" scroll-y>
      <view class="popup-item {{filterSalesman === '' ? 'active' : ''}}" bindtap="selectSalesman" data-id="" data-name="">
        <text>全部负责人</text>
        <t-icon wx:if="{{filterSalesman === ''}}" name="check" size="36rpx" color="#059669" />
      </view>
      <view class="popup-item {{filterSalesman === item.salesmanId ? 'active' : ''}}" 
            wx:for="{{salesmanList}}" wx:key="salesmanId"
            bindtap="selectSalesman" data-id="{{item.salesmanId}}" data-name="{{item.salesmanName}}">
        <text>{{item.salesmanName}}</text>
        <t-icon wx:if="{{filterSalesman === item.salesmanId}}" name="check" size="36rpx" color="#059669" />
      </view>
    </scroll-view>
  </view>
</t-popup>

