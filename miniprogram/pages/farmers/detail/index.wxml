<!--
  农户详情页面
  UI 重构：简洁、标准、符合操作习惯
-->
<view class="farmer-detail-page">
  <block wx:if="{{farmer}}">
    <!-- 1. 顶部身份卡片 -->
    <view class="profile-header">
      <view class="profile-main">
        <view class="avatar-area">
          <view class="avatar-circle grade-bg-{{farmer.grade}}">
            <text class="avatar-text">{{farmer.name[0]}}</text>
          </view>
          <view class="grade-tag grade-tag-{{farmer.grade}}">
            <text wx:if="{{farmer.grade === 'gold'}}">金牌农户</text>
            <text wx:elif="{{farmer.grade === 'silver'}}">银牌农户</text>
            <text wx:else>铜牌农户</text>
          </view>
        </view>
        <view class="info-area">
          <view class="name-row">
            <text class="name-text">{{farmer.name}}</text>
            <text class="phone-text">{{farmer.phone}}</text>
            <view class="call-btn" bindtap="onCallTap">
              <t-icon name="call" size="32rpx" color="#059669" />
            </view>
          </view>
          <view class="meta-row">
            <text class="meta-item">编码: {{farmer.customerCode}}</text>
            <text class="meta-divider">|</text>
            <text class="meta-item">负责人: {{farmer.manager || '无'}}</text>
          </view>
          <view class="address-row">
            <t-icon name="location" size="24rpx" color="#9ca3af" />
            <text class="address-text">{{farmer.addressText || farmer.address.village || '未录入地址'}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 2. 核心数据指标 -->
    <view class="stats-card">
      <!-- 签约信息 -->
      <view class="section-title-row">
        <text class="section-title-text">签约信息</text>
      </view>
      <view class="stats-row">
        <view class="stat-item">
          <text class="stat-value">{{farmer.acreage}}</text>
          <text class="stat-label">签约面积(亩)</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-value stat-green">¥{{farmer.deposit || 0}}</text>
          <text class="stat-label">已交定金</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-value stat-blue">{{farmer.contractDate}}</text>
          <text class="stat-label">签约日期</text>
        </view>
      </view>
      <!-- 种苗签约信息（第二行） -->
      <view class="stats-row stats-row-tertiary">
        <view class="stat-item">
          <text class="stat-value stat-purple">{{farmer.seedTotal || 0}}</text>
          <text class="stat-label">种苗合计(万株)</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-value stat-orange">¥{{farmer.receivableAmount || 0}}</text>
          <text class="stat-label">签约金额</text>
        </view>
      </view>

      <!-- 种苗发放 -->
      <view class="section-title-row section-title-row-mt">
        <text class="section-title-text">种苗发放</text>
        <view wx:if="{{farmer.seedDistributionComplete}}" class="seed-complete-tag">
          <t-icon name="check-circle" size="28rpx" color="#059669" />
          <text>已完成</text>
        </view>
      </view>
      <view class="stats-row">
        <view class="stat-item">
          <text class="stat-value stat-blue">{{seedStats.recordCount || 0}}</text>
          <text class="stat-label">发苗次数</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-value stat-blue">{{seedStats.totalQuantity || 0}}</text>
          <text class="stat-label">发苗数量(万株)</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-value stat-green">{{seedStats.totalArea || 0}}</text>
          <text class="stat-label">发放面积(亩)</text>
        </view>
      </view>
      <view class="stats-row stats-row-tertiary">
        <view class="stat-item">
          <text class="stat-value stat-orange">¥{{seedStats.totalAmount || 0}}</text>
          <text class="stat-label">苗款金额(元)</text>
        </view>
      </view>

      <!-- 农资 -->
      <view class="section-title-row section-title-row-mt">
        <text class="section-title-text">农资发放</text>
      </view>
      <view class="stats-row">
        <view class="stat-item">
          <text class="stat-value stat-cyan">¥{{farmer.fertilizerAmount || 0}}</text>
          <text class="stat-label">化肥金额</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-value stat-pink">¥{{farmer.pesticideAmount || 0}}</text>
          <text class="stat-label">农药金额</text>
        </view>
      </view>

      <!-- 欠款汇总 -->
      <view class="section-title-row section-title-row-mt">
        <text class="section-title-text">欠款汇总</text>
      </view>
      <view class="stats-row">
        <view class="stat-item">
          <!-- 种苗欠款：只有发过苗才显示实际欠款，否则显示0 -->
          <text class="stat-value stat-red">¥{{seedStats.recordCount > 0 ? (farmer.seedDebt || 0) : 0}}</text>
          <text class="stat-label">种苗欠款</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-value stat-red">¥{{farmer.agriculturalDebt || 0}}</text>
          <text class="stat-label">农资欠款</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-value stat-orange">¥{{farmer.advancePayment || 0}}</text>
          <text class="stat-label">预支款</text>
        </view>
      </view>
    </view>

    <!-- 3. 快捷操作区 (管理层不显示) -->
    <view class="section-card" wx:if="{{!isFinanceAdmin}}">
      <view class="section-header">
        <text class="section-title">业务操作</text>
      </view>
      <view class="action-grid">
        <view class="action-item {{farmer.seedDistributionComplete ? 'action-item-disabled' : ''}}" bindtap="{{farmer.seedDistributionComplete ? '' : 'onGoSeedAdd'}}">
          <view class="action-icon-bg {{farmer.seedDistributionComplete ? 'bg-gray' : 'bg-green'}}">
            <t-icon name="corn" size="44rpx" color="{{farmer.seedDistributionComplete ? '#9ca3af' : '#059669'}}" />
          </view>
          <text class="action-name">{{farmer.seedDistributionComplete ? '发苗完成' : '发放种苗'}}</text>
        </view>
        <view class="action-item {{farmer.seedDistributionComplete ? 'action-item-disabled' : ''}}" bindtap="{{farmer.seedDistributionComplete ? '' : 'onOpenAcreagePopup'}}">
          <view class="action-icon-bg {{farmer.seedDistributionComplete ? 'bg-gray' : 'bg-blue'}}">
            <t-icon name="measurement" size="44rpx" color="{{farmer.seedDistributionComplete ? '#9ca3af' : '#3b82f6'}}" />
          </view>
          <text class="action-name">追加面积</text>
        </view>
        <view class="action-item" bindtap="onOpenAdvancePopup">
          <view class="action-icon-bg bg-orange">
            <t-icon name="wallet" size="44rpx" color="#f59e0b" />
          </view>
          <text class="action-name">预支款</text>
        </view>
        <view class="action-item" bindtap="onOpenFertilizerPopup">
          <view class="action-icon-bg bg-cyan">
            <t-icon name="filter" size="44rpx" color="#0891b2" />
          </view>
          <text class="action-name">发放化肥</text>
        </view>
        <view class="action-item" bindtap="onOpenPesticidePopup">
          <view class="action-icon-bg bg-red">
            <t-icon name="control-platform" size="44rpx" color="#ef4444" />
          </view>
          <text class="action-name">发放农药</text>
        </view>
      </view>
    </view>

    <!-- 5. 业务往来记录 (Timeline) -->
    <view class="section-card">
      <view class="section-header">
        <text class="section-title">业务往来记录</text>
      </view>
      <view class="timeline-container">
        <block wx:if="{{businessRecords.length > 0}}">
          <view class="timeline-item" wx:for="{{businessRecords}}" wx:key="id">
            <!-- 左侧时间线 -->
            <view class="timeline-line">
              <view class="timeline-dot dot-{{item.type}}"></view>
              <view class="timeline-connector"></view>
            </view>
            <!-- 右侧内容 -->
            <view class="timeline-content">
              <view class="timeline-row-1">
                <text class="record-title">{{item.name}}</text>
                <text class="record-date">{{item.date}}</text>
              </view>
              <view class="timeline-row-2">
                <text class="record-desc">{{item.desc || '无详细信息'}}</text>
                <text class="record-operator">操作人: {{item.operator}}</text>
              </view>

            </view>
          </view>
        </block>
        <view wx:else class="empty-state">
          <text>暂无业务记录</text>
        </view>
      </view>
    </view>

  </block>

  <!-- 加载中 -->
  <view wx:else class="loading-state">
    <t-loading theme="circular" size="40rpx" />
    <text>加载中...</text>
  </view>

  <!-- 底部间距 -->
  <view class="bottom-space"></view>

  <!-- ==================== 弹窗区域 ==================== -->
  
  <!-- 1. 追加面积弹窗（完整版：面积+定金+种苗） -->
  <t-popup visible="{{acreagePopupVisible}}" placement="bottom" bind:visible-change="onCloseAcreagePopup">
    <view class="popup-container popup-container-tall">
      <view class="popup-header-bar">
        <text class="popup-title">追加签约信息</text>
        <t-icon name="close" size="40rpx" color="#9ca3af" bindtap="onCloseAcreagePopup" />
      </view>
      
      <scroll-view class="popup-scroll" scroll-y>
        <!-- 当前汇总信息 -->
        <view class="popup-summary">
          <view class="summary-item">
            <text class="summary-label">当前面积</text>
            <text class="summary-value">{{farmer.acreage}} 亩</text>
          </view>
          <view class="summary-item">
            <text class="summary-label">当前定金</text>
            <text class="summary-value">¥{{farmer.deposit || 0}}</text>
          </view>
        </view>

        <!-- 追加面积 -->
        <view class="form-field">
          <text class="field-label required">追加面积（亩）</text>
          <input class="field-input" type="digit" placeholder="请输入追加亩数" value="{{acreageForm.acreage}}" bindinput="onAcreageFormInput" data-field="acreage" />
        </view>

        <!-- 追加种苗 -->
        <view class="form-field">
          <text class="field-label">追加种苗（万株）</text>
          <input class="field-input" type="digit" placeholder="请输入追加种苗数量" value="{{acreageForm.seedTotal}}" bindinput="onAcreageFormInput" data-field="seedTotal" />
        </view>

        <!-- 种苗单价 -->
        <view class="form-field">
          <text class="field-label">种苗单价（元/万株）</text>
          <input class="field-input" type="digit" placeholder="请输入单价" value="{{acreageForm.seedUnitPrice}}" bindinput="onAcreageFormInput" data-field="seedUnitPrice" />
        </view>

        <!-- 追加应收款（自动计算） -->
        <view class="popup-info-row" wx:if="{{acreageForm.receivableAmount > 0}}">
          <text>追加应收</text>
          <text class="popup-highlight">¥{{acreageForm.receivableAmount}}</text>
        </view>

        <!-- 是否追加定金 -->
        <view class="form-field">
          <view class="toggle-row">
            <text class="field-label">是否追加定金</text>
            <view class="toggle-switch {{acreageForm.addDeposit ? 'active' : ''}}" bindtap="onToggleAddDeposit">
              <view class="toggle-dot"></view>
            </view>
          </view>
        </view>

        <!-- 追加定金金额（条件显示） -->
        <view class="form-field" wx:if="{{acreageForm.addDeposit}}">
          <text class="field-label">追加定金（元）</text>
          <input class="field-input" type="digit" placeholder="请输入定金金额" value="{{acreageForm.deposit}}" bindinput="onAcreageFormInput" data-field="deposit" />
        </view>

        <!-- 备注 -->
        <view class="form-field">
          <text class="field-label">备注</text>
          <input class="field-input" placeholder="可选填备注" value="{{acreageForm.remark}}" bindinput="onAcreageFormInput" data-field="remark" />
        </view>
      </scroll-view>

      <view class="popup-footer-bar">
        <button class="btn-cancel" bindtap="onCloseAcreagePopup">取消</button>
        <button class="btn-confirm" bindtap="onSubmitAcreage">确认追加</button>
      </view>
    </view>
  </t-popup>

  <!-- 2. 追加定金弹窗 -->
  <t-popup visible="{{depositPopupVisible}}" placement="bottom" bind:visible-change="onCloseDepositPopup">
    <view class="popup-container">
      <view class="popup-header-bar">
        <text class="popup-title">追加定金</text>
        <t-icon name="close" size="40rpx" color="#9ca3af" bindtap="onCloseDepositPopup" />
      </view>
      <view class="popup-body">
        <view class="popup-info-row">
          <text>当前定金</text>
          <text class="popup-highlight">¥{{farmer.deposit || 0}}</text>
        </view>
        <view class="form-field">
          <text class="field-label">增加金额 (元)</text>
          <input class="field-input" type="digit" placeholder="请输入金额" value="{{depositInputValue}}" bindinput="onDepositInputChange" />
        </view>
        <view class="form-field">
          <text class="field-label">收款方式</text>
          <view class="tag-group">
            <view class="tag-item active">现金</view>
            <view class="tag-item">微信</view>
            <view class="tag-item">转账</view>
          </view>
        </view>
      </view>
      <view class="popup-footer-bar">
        <button class="btn-cancel" bindtap="onCloseDepositPopup">取消</button>
        <button class="btn-confirm" bindtap="onSubmitDeposit">确认收款</button>
      </view>
    </view>
  </t-popup>

  <!-- 3. 预付款弹窗 -->
  <t-popup visible="{{advancePopupVisible}}" placement="bottom" bind:visible-change="onCloseAdvancePopup">
    <view class="popup-container">
      <view class="popup-header-bar">
        <text class="popup-title">支付预付款</text>
        <t-icon name="close" size="40rpx" color="#9ca3af" bindtap="onCloseAdvancePopup" />
      </view>
      <view class="popup-body">
        <view class="form-field">
          <text class="field-label">预付金额 (元)</text>
          <input class="field-input" type="digit" placeholder="请输入金额" value="{{advanceForm.amount}}" bindinput="onAdvanceAmountInput" />
        </view>
        <view class="form-field">
          <text class="field-label">支付日期</text>
          <picker mode="date" value="{{advanceForm.date}}" bindchange="onAdvanceDateChange">
            <view class="picker-box">{{advanceForm.date}}</view>
          </picker>
        </view>
        <view class="form-field">
          <text class="field-label">备注</text>
          <input class="field-input" placeholder="输入备注信息" value="{{advanceForm.remark}}" bindinput="onAdvanceRemarkInput" />
        </view>
      </view>
      <view class="popup-footer-bar">
        <button class="btn-cancel" bindtap="onCloseAdvancePopup">取消</button>
        <button class="btn-confirm" bindtap="onSubmitAdvance">确认支付</button>
      </view>
    </view>
  </t-popup>

  <!-- 4. 发放化肥弹窗 -->
  <t-popup visible="{{fertilizerPopupVisible}}" placement="bottom" bind:visible-change="onCloseFertilizerPopup">
    <view class="popup-container popup-container-tall">
      <view class="popup-header-bar">
        <text class="popup-title">发放化肥</text>
        <t-icon name="close" size="40rpx" color="#9ca3af" bindtap="onCloseFertilizerPopup" />
      </view>

      <scroll-view class="popup-scroll" scroll-y>
        <!-- 发放日期 -->
        <view class="form-field">
          <text class="field-label">发放日期</text>
          <picker mode="date" value="{{fertilizerForm.date}}" bindchange="onFertilizerDateChange">
            <view class="picker-box">{{fertilizerForm.date}}</view>
          </picker>
        </view>

        <!-- 化肥名称 -->
        <view class="form-field">
          <text class="field-label required">化肥名称</text>
          <input class="field-input" placeholder="如：复合肥、尿素等" value="{{fertilizerForm.name}}" bindinput="onFertilizerNameInput" />
        </view>

        <!-- 种类 -->
        <view class="form-field">
          <text class="field-label">种类</text>
          <input class="field-input" placeholder="可选填种类" value="{{fertilizerForm.category}}" bindinput="onFertilizerCategoryInput" />
        </view>

        <!-- 数量 -->
        <view class="form-field">
          <text class="field-label required">数量</text>
          <view class="input-with-unit">
            <input class="field-input flex-1" type="digit" placeholder="请输入数量" value="{{fertilizerForm.quantity}}" bindinput="onFertilizerQuantityInput" />
            <input class="unit-input" placeholder="袋" value="{{fertilizerForm.unit}}" bindinput="onFertilizerUnitInput" />
          </view>
        </view>

        <!-- 单价 -->
        <view class="form-field">
          <text class="field-label required">单价（元）</text>
          <input class="field-input" type="digit" placeholder="请输入单价" value="{{fertilizerForm.price}}" bindinput="onFertilizerPriceInput" />
        </view>

        <!-- 金额（自动计算） -->
        <view class="popup-info-row" wx:if="{{fertilizerForm.amount > 0}}">
          <text>金额合计</text>
          <text class="popup-highlight">¥{{fertilizerForm.amount}}</text>
        </view>

        <!-- 备注 -->
        <view class="form-field">
          <text class="field-label">备注</text>
          <input class="field-input" placeholder="可选填备注" value="{{fertilizerForm.remark}}" bindinput="onFertilizerRemarkInput" />
        </view>
      </scroll-view>

      <view class="popup-footer-bar">
        <button class="btn-cancel" bindtap="onCloseFertilizerPopup">取消</button>
        <button class="btn-confirm" bindtap="onSubmitFertilizer">确认发放</button>
      </view>
    </view>
  </t-popup>

  <!-- 5. 发放农药弹窗 -->
  <t-popup visible="{{pesticidePopupVisible}}" placement="bottom" bind:visible-change="onClosePesticidePopup">
    <view class="popup-container popup-container-tall">
      <view class="popup-header-bar">
        <text class="popup-title">发放农药</text>
        <t-icon name="close" size="40rpx" color="#9ca3af" bindtap="onClosePesticidePopup" />
      </view>

      <scroll-view class="popup-scroll" scroll-y>
        <!-- 发放日期 -->
        <view class="form-field">
          <text class="field-label">发放日期</text>
          <picker mode="date" value="{{pesticideForm.date}}" bindchange="onPesticideDateChange">
            <view class="picker-box">{{pesticideForm.date}}</view>
          </picker>
        </view>

        <!-- 农药名称 -->
        <view class="form-field">
          <text class="field-label required">农药名称</text>
          <input class="field-input" placeholder="如：吡虫啉、多菌灵等" value="{{pesticideForm.name}}" bindinput="onPesticideNameInput" />
        </view>

        <!-- 种类 -->
        <view class="form-field">
          <text class="field-label">种类</text>
          <input class="field-input" placeholder="可选填种类" value="{{pesticideForm.category}}" bindinput="onPesticideCategoryInput" />
        </view>

        <!-- 数量 -->
        <view class="form-field">
          <text class="field-label required">数量</text>
          <view class="input-with-unit">
            <input class="field-input flex-1" type="digit" placeholder="请输入数量" value="{{pesticideForm.quantity}}" bindinput="onPesticideQuantityInput" />
            <input class="unit-input" placeholder="瓶" value="{{pesticideForm.unit}}" bindinput="onPesticideUnitInput" />
          </view>
        </view>

        <!-- 单价 -->
        <view class="form-field">
          <text class="field-label required">单价（元）</text>
          <input class="field-input" type="digit" placeholder="请输入单价" value="{{pesticideForm.price}}" bindinput="onPesticidePriceInput" />
        </view>

        <!-- 金额（自动计算） -->
        <view class="popup-info-row" wx:if="{{pesticideForm.amount > 0}}">
          <text>金额合计</text>
          <text class="popup-highlight">¥{{pesticideForm.amount}}</text>
        </view>

        <!-- 备注 -->
        <view class="form-field">
          <text class="field-label">备注</text>
          <input class="field-input" placeholder="可选填备注" value="{{pesticideForm.remark}}" bindinput="onPesticideRemarkInput" />
        </view>
      </scroll-view>

      <view class="popup-footer-bar">
        <button class="btn-cancel" bindtap="onClosePesticidePopup">取消</button>
        <button class="btn-confirm" bindtap="onSubmitPesticide">确认发放</button>
      </view>
    </view>
  </t-popup>
</view>
