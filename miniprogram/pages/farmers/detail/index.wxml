<!--
  农户详情页面
  UI 重构：简洁、标准、符合操作习惯
-->
<view class="farmer-detail-page">
  <block wx:if="{{farmer}}">
    <!-- 1. 顶部身份卡片 -->
    <view class="profile-header">
      <view class="profile-main">
        <view class="avatar-area">
          <view class="avatar-circle grade-bg-{{farmer.grade}}">
            <text class="avatar-text">{{farmer.name[0]}}</text>
          </view>
          <view class="grade-tag grade-tag-{{farmer.grade}}">
            <text wx:if="{{farmer.grade === 'gold'}}">金牌农户</text>
            <text wx:elif="{{farmer.grade === 'silver'}}">银牌农户</text>
            <text wx:else>铜牌农户</text>
          </view>
        </view>
        <view class="info-area">
          <view class="name-row">
            <text class="name-text">{{farmer.name}}</text>
            <text class="phone-text">{{farmer.phone}}</text>
            <view class="call-btn" bindtap="onCallTap">
              <t-icon name="call" size="32rpx" color="#059669" />
            </view>
          </view>
          <view class="meta-row">
            <text class="meta-item">编码: {{farmer.customerCode}}</text>
            <text class="meta-divider">|</text>
            <text class="meta-item">负责人: {{farmer.manager || '无'}}</text>
          </view>
          <view class="address-row">
            <t-icon name="location" size="24rpx" color="#9ca3af" />
            <text class="address-text">{{farmer.addressText || farmer.address.village || '未录入地址'}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 2. 核心数据指标 -->
    <view class="stats-card">
      <view class="stat-item">
        <text class="stat-value">{{farmer.acreage}}</text>
        <text class="stat-label">签约面积(亩)</text>
      </view>
      <view class="stat-divider"></view>
      <view class="stat-item">
        <text class="stat-value stat-green">¥{{farmer.deposit || 0}}</text>
        <text class="stat-label">已交定金</text>
      </view>
      <view class="stat-divider"></view>
      <view class="stat-item">
        <text class="stat-value stat-blue">{{farmer.contractDate}}</text>
        <text class="stat-label">签约日期</text>
      </view>
    </view>

    <!-- 3. 快捷操作区 (管理层不显示) -->
    <view class="section-card" wx:if="{{!isFinanceAdmin}}">
      <view class="section-header">
        <text class="section-title">业务操作</text>
      </view>
      <view class="action-grid">
        <view class="action-item" bindtap="onOpenAcreagePopup">
          <view class="action-icon-bg bg-blue">
            <t-icon name="measurement" size="44rpx" color="#3b82f6" />
          </view>
          <text class="action-name">追加面积</text>
        </view>
        <view class="action-item" bindtap="onOpenDepositPopup">
          <view class="action-icon-bg bg-green">
            <t-icon name="money-circle" size="44rpx" color="#059669" />
          </view>
          <text class="action-name">追加定金</text>
        </view>
        <view class="action-item" bindtap="onOpenAdvancePopup">
          <view class="action-icon-bg bg-orange">
            <t-icon name="wallet" size="44rpx" color="#f59e0b" />
          </view>
          <text class="action-name">预付款</text>
        </view>
        <view class="action-item" bindtap="onViewContract">
          <view class="action-icon-bg bg-purple">
            <t-icon name="file-contract" size="44rpx" color="#8b5cf6" />
          </view>
          <text class="action-name">查看合同</text>
        </view>
      </view>
    </view>
    
    <!-- 4. 生产管理 (折叠或单独区域) -->
    <view class="section-card" wx:if="{{!isFinanceAdmin}}">
      <view class="section-header">
        <text class="section-title">生产发放</text>
      </view>
      <view class="action-grid">
        <view class="action-item" bindtap="onOpenSeedPopup">
          <view class="action-icon-bg bg-teal">
            <t-icon name="corn" size="44rpx" color="#0d9488" />
          </view>
          <text class="action-name">发放种苗</text>
        </view>
        <view class="action-item" bindtap="onOpenFertilizerPopup">
          <view class="action-icon-bg bg-cyan">
            <t-icon name="filter" size="44rpx" color="#0891b2" />
          </view>
          <text class="action-name">发放化肥</text>
        </view>
        <view class="action-item" bindtap="onOpenPesticidePopup">
          <view class="action-icon-bg bg-red">
            <t-icon name="control-platform" size="44rpx" color="#ef4444" />
          </view>
          <text class="action-name">发放农药</text>
        </view>
      </view>
    </view>

    <!-- 5. 业务往来记录 (Timeline) -->
    <view class="section-card">
      <view class="section-header">
        <text class="section-title">业务往来记录</text>
      </view>
      <view class="timeline-container">
        <block wx:if="{{businessRecords.length > 0}}">
          <view class="timeline-item" wx:for="{{businessRecords}}" wx:key="id">
            <!-- 左侧时间线 -->
            <view class="timeline-line">
              <view class="timeline-dot dot-{{item.type}}"></view>
              <view class="timeline-connector"></view>
            </view>
            <!-- 右侧内容 -->
            <view class="timeline-content">
              <view class="timeline-row-1">
                <text class="record-title">{{item.name}}</text>
                <text class="record-date">{{item.date}}</text>
              </view>
              <view class="timeline-row-2">
                <text class="record-desc">{{item.desc || '无详细信息'}}</text>
                <text class="record-operator">操作人: {{item.operator}}</text>
              </view>
              <view class="timeline-row-3" wx:if="{{item.amount}}">
                <text class="record-amount {{item.isIncome ? 'amount-plus' : 'amount-minus'}}">{{item.isIncome ? '+' : '-'}}¥{{item.amount}}</text>
              </view>
            </view>
          </view>
        </block>
        <view wx:else class="empty-state">
          <text>暂无业务记录</text>
        </view>
      </view>
    </view>

  </block>

  <!-- 加载中 -->
  <view wx:else class="loading-state">
    <t-loading theme="circular" size="40rpx" />
    <text>加载中...</text>
  </view>

  <!-- 底部间距 -->
  <view class="bottom-space"></view>

  <!-- ==================== 弹窗区域 ==================== -->
  
  <!-- 1. 追加面积弹窗 -->
  <t-popup visible="{{acreagePopupVisible}}" placement="bottom" bind:visible-change="onCloseAcreagePopup">
    <view class="popup-container">
      <view class="popup-header-bar">
        <text class="popup-title">追加签约面积</text>
        <t-icon name="close" size="40rpx" color="#9ca3af" bindtap="onCloseAcreagePopup" />
      </view>
      <view class="popup-body">
        <view class="popup-info-row">
          <text>当前面积</text>
          <text class="popup-highlight">{{farmer.acreage}} 亩</text>
        </view>
        <view class="form-field">
          <text class="field-label">追加面积 (亩)</text>
          <input class="field-input" type="digit" placeholder="请输入增加的亩数" value="{{acreageInputValue}}" bindinput="onAcreageInputChange" />
        </view>
        <view class="form-field">
          <text class="field-label">备注</text>
          <input class="field-input" placeholder="可选填备注" />
        </view>
      </view>
      <view class="popup-footer-bar">
        <button class="btn-cancel" bindtap="onCloseAcreagePopup">取消</button>
        <button class="btn-confirm" bindtap="onSubmitAcreage">确认追加</button>
      </view>
    </view>
  </t-popup>

  <!-- 2. 追加定金弹窗 -->
  <t-popup visible="{{depositPopupVisible}}" placement="bottom" bind:visible-change="onCloseDepositPopup">
    <view class="popup-container">
      <view class="popup-header-bar">
        <text class="popup-title">追加定金</text>
        <t-icon name="close" size="40rpx" color="#9ca3af" bindtap="onCloseDepositPopup" />
      </view>
      <view class="popup-body">
        <view class="popup-info-row">
          <text>当前定金</text>
          <text class="popup-highlight">¥{{farmer.deposit || 0}}</text>
        </view>
        <view class="form-field">
          <text class="field-label">增加金额 (元)</text>
          <input class="field-input" type="digit" placeholder="请输入金额" value="{{depositInputValue}}" bindinput="onDepositInputChange" />
        </view>
        <view class="form-field">
          <text class="field-label">收款方式</text>
          <view class="tag-group">
            <view class="tag-item active">现金</view>
            <view class="tag-item">微信</view>
            <view class="tag-item">转账</view>
          </view>
        </view>
      </view>
      <view class="popup-footer-bar">
        <button class="btn-cancel" bindtap="onCloseDepositPopup">取消</button>
        <button class="btn-confirm" bindtap="onSubmitDeposit">确认收款</button>
      </view>
    </view>
  </t-popup>

  <!-- 3. 预付款弹窗 -->
  <t-popup visible="{{advancePopupVisible}}" placement="bottom" bind:visible-change="onCloseAdvancePopup">
    <view class="popup-container">
      <view class="popup-header-bar">
        <text class="popup-title">支付预付款</text>
        <t-icon name="close" size="40rpx" color="#9ca3af" bindtap="onCloseAdvancePopup" />
      </view>
      <view class="popup-body">
        <view class="form-field">
          <text class="field-label">预付金额 (元)</text>
          <input class="field-input" type="digit" placeholder="请输入金额" value="{{advanceForm.amount}}" bindinput="onAdvanceAmountInput" />
        </view>
        <view class="form-field">
          <text class="field-label">支付日期</text>
          <picker mode="date" value="{{advanceForm.date}}" bindchange="onAdvanceDateChange">
            <view class="picker-box">{{advanceForm.date}}</view>
          </picker>
        </view>
        <view class="form-field">
          <text class="field-label">备注</text>
          <input class="field-input" placeholder="输入备注信息" value="{{advanceForm.remark}}" bindinput="onAdvanceRemarkInput" />
        </view>
      </view>
      <view class="popup-footer-bar">
        <button class="btn-cancel" bindtap="onCloseAdvancePopup">取消</button>
        <button class="btn-confirm" bindtap="onSubmitAdvance">确认支付</button>
      </view>
    </view>
  </t-popup>

  <!-- 4. 查看合同弹窗 -->
  <t-popup visible="{{contractPopupVisible}}" placement="center" bind:visible-change="onCloseContractPopup">
    <view class="popup-container-center">
      <view class="popup-header-bar">
        <text class="popup-title">合同附件</text>
        <t-icon name="close" size="40rpx" color="#9ca3af" bindtap="onCloseContractPopup" />
      </view>
      <scroll-view class="contract-scroll" scroll-y>
        <view class="contract-list" wx:if="{{farmer.contractImages && farmer.contractImages.length > 0}}">
          <image 
            wx:for="{{farmer.contractImages}}" 
            wx:key="*this"
            class="contract-img"
            src="{{item}}"
            mode="widthFix"
            bindtap="onPreviewContract"
            data-url="{{item}}"
          />
        </view>
        <view wx:else class="empty-contract">
          <t-icon name="file" size="64rpx" color="#d1d5db" />
          <text>暂无合同附件</text>
        </view>
      </scroll-view>
    </view>
  </t-popup>

  <!-- 5. 发放种苗/化肥/农药 (复用之前的逻辑，简化弹窗样式) -->
  <!-- (这里为了简洁，省略了生产发放的弹窗代码，假设复用相同的样式类 popup-container) -->
  <t-popup visible="{{seedPopupVisible}}" placement="bottom" bind:visible-change="onCloseSeedPopup">
    <view class="popup-container">
      <view class="popup-header-bar">
        <text class="popup-title">发放种苗</text>
        <t-icon name="close" size="40rpx" color="#9ca3af" bindtap="onCloseSeedPopup" />
      </view>
      <view class="popup-body">
        <view class="form-field">
          <text class="field-label">发放数量 (株)</text>
          <input class="field-input" type="digit" value="{{seedForm.quantity}}" bindinput="onSeedQuantityInput" placeholder="0" />
        </view>
        <view class="form-field">
          <text class="field-label">单价 (元)</text>
          <input class="field-input" type="digit" value="{{seedForm.price}}" bindinput="onSeedPriceInput" placeholder="0.00" />
        </view>
        <view class="popup-info-row">
          <text>总金额</text>
          <text class="popup-highlight">¥{{seedForm.amount}}</text>
        </view>
      </view>
      <view class="popup-footer-bar">
        <button class="btn-cancel" bindtap="onCloseSeedPopup">取消</button>
        <button class="btn-confirm" bindtap="onSubmitSeed">确认发放</button>
      </view>
    </view>
  </t-popup>

</view>
