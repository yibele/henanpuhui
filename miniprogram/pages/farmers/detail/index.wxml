<!--
  å†œæˆ·è¯¦æƒ…é¡µé¢
  å±•ç¤ºå†œæˆ·ä¿¡æ¯ã€æ“ä½œæŒ‰é’®ã€ä¸šåŠ¡å¾€æ¥è®°å½•
-->
<view class="farmer-detail-page">
  <block wx:if="{{farmer}}">
    <!-- åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
    <view class="profile-card">
      <view class="profile-header">
        <view class="profile-avatar">
          <text wx:if="{{farmer.grade === 'gold'}}" class="grade-emoji">ğŸ¥‡</text>
          <text wx:elif="{{farmer.grade === 'silver'}}" class="grade-emoji">ğŸ¥ˆ</text>
          <text wx:else class="grade-emoji">ğŸ¥‰</text>
        </view>
        <view class="profile-info">
          <view class="profile-name-row">
            <text class="profile-name">{{farmer.name}}</text>
            <view class="grade-badge grade-badge-{{farmer.grade}}">
              <text wx:if="{{farmer.grade === 'gold'}}">é‡‘ç‰Œ</text>
              <text wx:elif="{{farmer.grade === 'silver'}}">é“¶ç‰Œ</text>
              <text wx:else>é“œç‰Œ</text>
            </view>
          </view>
          <view class="profile-code">
            <text class="code-text">{{farmer.customerCode}}</text>
          </view>
          <view class="profile-contact" bindtap="onCallTap">
            <t-icon name="call" size="28rpx" color="#059669" />
            <text>{{farmer.phone}}</text>
          </view>
        </view>
      </view>

      <!-- å¿«é€Ÿä¿¡æ¯ -->
      <view class="quick-info-grid">
        <view class="quick-info-item quick-info-blue">
          <text class="quick-info-label">ç§æ¤é¢ç§¯</text>
          <view class="quick-info-value">
            <text class="value-num">{{farmer.acreage}}</text>
            <text class="value-unit">äº©</text>
          </view>
        </view>
        <view class="quick-info-item quick-info-orange">
          <text class="quick-info-label">å®šé‡‘</text>
          <view class="quick-info-value">
            <text class="value-num">{{farmer.deposit || 0}}</text>
            <text class="value-unit">å…ƒ</text>
          </view>
        </view>
        <view class="quick-info-item quick-info-purple">
          <text class="quick-info-label">ç­¾çº¦æ—¥æœŸ</text>
          <view class="quick-info-value">
            <text class="value-date">{{farmer.contractDate}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- ä½œä¸šæ“ä½œæŒ‰é’® -->
    <view class="section">
      <view class="section-title">ä½œä¸šæ“ä½œ</view>
      <view class="action-grid">
        <view class="action-card action-card-green" bindtap="onOpenSeedPopup">
          <view class="action-icon">ğŸŒ±</view>
          <text class="action-label">å‘æ”¾ç§è‹—</text>
        </view>
        <view class="action-card action-card-blue" bindtap="onOpenFertilizerPopup">
          <view class="action-icon">ğŸ§ª</view>
          <text class="action-label">å‘æ”¾åŒ–è‚¥</text>
        </view>
        <view class="action-card action-card-red" bindtap="onOpenPesticidePopup">
          <view class="action-icon">ğŸ§´</view>
          <text class="action-label">å‘æ”¾å†œè¯</text>
        </view>
        <view class="action-card action-card-orange" bindtap="onOpenAdvancePopup">
          <view class="action-icon">ğŸ’°</view>
          <text class="action-label">é¢„ä»˜æ¬¾</text>
        </view>
        <view class="action-card action-card-purple" bindtap="onOpenPurchasePopup">
          <view class="action-icon">ğŸ›’</view>
          <text class="action-label">è¿½åŠ è´­è‹—</text>
        </view>
        <view class="action-card action-card-teal" bindtap="onViewContract">
          <view class="action-icon">ğŸ“„</view>
          <text class="action-label">æŸ¥çœ‹åˆåŒ</text>
        </view>
      </view>
    </view>

    <!-- ç§æ¤åœ°å€ -->
    <view class="section">
      <view class="section-title">ç§æ¤åœ°å€</view>
      <view class="info-card">
        <view class="address-detail">
          <view class="address-row">
            <t-icon name="location" size="40rpx" color="#059669" />
            <text class="address-full">{{farmer.addressText || 'æœªå½•å…¥'}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- å†œæˆ·ä¿¡æ¯ -->
    <view class="section">
      <view class="section-title">å†œæˆ·ä¿¡æ¯</view>
      <view class="info-card">
        <view class="info-item">
          <view class="info-icon">
            <t-icon name="user" size="40rpx" color="#9ca3af" />
          </view>
          <view class="info-content">
            <text class="info-label">ç§æ¤æˆ·è´Ÿè´£äºº</text>
            <text class="info-value">{{farmer.manager || 'æœªå½•å…¥'}}</text>
          </view>
        </view>
        <view class="info-divider"></view>
        <view class="info-item">
          <view class="info-icon">
            <t-icon name="creditcard" size="40rpx" color="#9ca3af" />
          </view>
          <view class="info-content">
            <text class="info-label">èº«ä»½è¯å·</text>
            <text class="info-value">{{farmer.idCard || 'æœªå½•å…¥'}}</text>
          </view>
        </view>
        <view class="info-divider"></view>
        <view class="info-item">
          <view class="info-icon">
            <t-icon name="user-circle" size="40rpx" color="#9ca3af" />
          </view>
          <view class="info-content">
            <text class="info-label">ç­¾çº¦ä¸šåŠ¡å‘˜</text>
            <text class="info-value">{{farmer.salesmanName || 'æœªæŒ‡å®š'}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- å®šé‡‘ä¸é¢ç§¯ç®¡ç† -->
    <view class="section">
      <view class="section-title">å®šé‡‘ä¸é¢ç§¯ç®¡ç†</view>
      <view class="manage-card">
        <view class="manage-row">
          <view class="manage-info">
            <text class="manage-label">å½“å‰å®šé‡‘</text>
            <text class="manage-value manage-value-orange">Â¥{{farmer.deposit || 0}}</text>
          </view>
          <view class="manage-actions">
            <button class="manage-btn manage-btn-add" bindtap="onAddDeposit">
              <t-icon name="add" size="28rpx" color="#059669" />
            </button>
            <button class="manage-btn manage-btn-reduce" bindtap="onReduceDeposit">
              <t-icon name="remove" size="28rpx" color="#ef4444" />
            </button>
          </view>
        </view>
        <view class="manage-divider"></view>
        <view class="manage-row">
          <view class="manage-info">
            <text class="manage-label">ç§æ¤é¢ç§¯</text>
            <text class="manage-value manage-value-blue">{{farmer.acreage}} äº©</text>
          </view>
          <button class="manage-btn-text" bindtap="onUpdateAcreage">
            <t-icon name="edit" size="28rpx" color="#3b82f6" />
            <text>è°ƒæ•´</text>
          </button>
        </view>
      </view>
    </view>

    <!-- ä¸šåŠ¡å¾€æ¥è®°å½• -->
    <view class="section">
      <view class="section-title">ä¸šåŠ¡å¾€æ¥è®°å½•</view>
      <view class="timeline" wx:if="{{businessRecords.length > 0}}">
        <view 
          wx:for="{{businessRecords}}" 
          wx:key="id"
          class="timeline-item"
        >
          <view class="timeline-dot timeline-dot-{{item.type}}"></view>
          <view class="timeline-content">
            <view class="timeline-header">
              <text class="timeline-date">{{item.date}}</text>
              <view class="timeline-tag timeline-tag-{{item.type}}">
                <text wx:if="{{item.type === 'seed'}}">å‘è‹—</text>
                <text wx:elif="{{item.type === 'fertilizer'}}">åŒ–è‚¥</text>
                <text wx:elif="{{item.type === 'pesticide'}}">å†œè¯</text>
                <text wx:elif="{{item.type === 'advance'}}">é¢„ä»˜æ¬¾</text>
                <text wx:elif="{{item.type === 'purchase'}}">è´­è‹—</text>
                <text wx:else>å…¶ä»–</text>
              </view>
            </view>
            <view class="timeline-title">{{item.name || item.seedType || item.productType}}</view>
            <view class="timeline-desc">
              <text wx:if="{{item.quantity}}">æ•°é‡: {{item.quantity}}{{item.unit || ''}}</text>
              <text wx:if="{{item.amount}}"> â€¢ é‡‘é¢: Â¥{{item.amount}}</text>
            </view>
          </view>
        </view>
      </view>
      <view wx:else class="empty-records">
        <text>æš‚æ— ä¸šåŠ¡è®°å½•</text>
      </view>
    </view>
  </block>

  <!-- åŠ è½½ä¸­ -->
  <view wx:else class="loading-state">
    <t-loading theme="circular" size="40rpx" />
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- ==================== å‘æ”¾ç§è‹—å¼¹çª— ==================== -->
  <t-popup visible="{{seedPopupVisible}}" placement="bottom" bind:visible-change="onCloseSeedPopup">
    <view class="popup-content popup-content-tall">
      <view class="popup-header">
        <text class="popup-title">ğŸŒ± å‘æ”¾ç§è‹—</text>
        <view class="popup-close" bindtap="onCloseSeedPopup">
          <t-icon name="close" size="40rpx" color="#9ca3af" />
        </view>
      </view>
      <scroll-view class="popup-scroll" scroll-y>
        <view class="popup-form">
          <view class="form-item">
            <text class="form-label">å‘æ”¾æ—¶é—´</text>
            <picker mode="date" value="{{seedForm.date}}" bindchange="onSeedDateChange">
              <view class="picker-value">{{seedForm.date || 'è¯·é€‰æ‹©æ—¥æœŸ'}}</view>
            </picker>
          </view>
          <view class="form-item">
            <text class="form-label">å‘æ”¾æ•°é‡ï¼ˆæ ªï¼‰</text>
            <input class="form-input" type="digit" placeholder="è¾“å…¥æ•°é‡" value="{{seedForm.quantity}}" bindinput="onSeedQuantityInput" />
          </view>
          <view class="form-item">
            <text class="form-label">å•ä»·ï¼ˆå…ƒ/æ ªï¼‰</text>
            <input class="form-input" type="digit" placeholder="è¾“å…¥å•ä»·" value="{{seedForm.price}}" bindinput="onSeedPriceInput" />
          </view>
          <view class="form-item">
            <text class="form-label">è‹—æ¬¾é‡‘é¢ï¼ˆå…ƒï¼‰</text>
            <view class="form-value-auto">Â¥{{seedForm.amount || 0}}</view>
          </view>
          <view class="form-item">
            <text class="form-label">é¢†å–äºº</text>
            <input class="form-input" placeholder="è¾“å…¥é¢†å–äººå§“å" value="{{seedForm.receiver}}" bindinput="onSeedReceiverInput" />
          </view>
          <view class="form-item">
            <text class="form-label">é¢†å–åœ°ç‚¹</text>
            <input class="form-input" placeholder="è¾“å…¥é¢†å–åœ°ç‚¹" value="{{seedForm.location}}" bindinput="onSeedLocationInput" />
          </view>
          <view class="form-item">
            <text class="form-label">å‘è‹—è´Ÿè´£äºº</text>
            <view class="form-value-auto">{{currentUser}}</view>
          </view>
        </view>
      </scroll-view>
      <view class="popup-footer">
        <button class="popup-btn popup-btn-cancel" bindtap="onCloseSeedPopup">å–æ¶ˆ</button>
        <button class="popup-btn popup-btn-confirm" bindtap="onSubmitSeed">ç¡®è®¤å‘æ”¾</button>
      </view>
    </view>
  </t-popup>

  <!-- ==================== å‘æ”¾åŒ–è‚¥å¼¹çª— ==================== -->
  <t-popup visible="{{fertilizerPopupVisible}}" placement="bottom" bind:visible-change="onCloseFertilizerPopup">
    <view class="popup-content">
      <view class="popup-header">
        <text class="popup-title">ğŸ§ª å‘æ”¾åŒ–è‚¥</text>
        <view class="popup-close" bindtap="onCloseFertilizerPopup">
          <t-icon name="close" size="40rpx" color="#9ca3af" />
        </view>
      </view>
      <scroll-view class="popup-scroll" scroll-y>
        <view class="popup-form">
          <view class="form-item">
            <text class="form-label">ä½¿ç”¨æ—¶é—´</text>
            <picker mode="date" value="{{fertilizerForm.date}}" bindchange="onFertilizerDateChange">
              <view class="picker-value">{{fertilizerForm.date || 'è¯·é€‰æ‹©æ—¥æœŸ'}}</view>
            </picker>
          </view>
          <view class="form-item">
            <text class="form-label">åŒ–è‚¥åç§°</text>
            <input class="form-input" placeholder="å¦‚ï¼šå¤åˆè‚¥ã€å°¿ç´ ç­‰" value="{{fertilizerForm.name}}" bindinput="onFertilizerNameInput" />
          </view>
          <view class="form-item">
            <text class="form-label">æ•°é‡ï¼ˆè¢‹/kgï¼‰</text>
            <input class="form-input" type="digit" placeholder="è¾“å…¥æ•°é‡" value="{{fertilizerForm.quantity}}" bindinput="onFertilizerQuantityInput" />
          </view>
          <view class="form-item">
            <text class="form-label">å•ä»·ï¼ˆå…ƒï¼‰</text>
            <input class="form-input" type="digit" placeholder="è¾“å…¥å•ä»·" value="{{fertilizerForm.price}}" bindinput="onFertilizerPriceInput" />
          </view>
          <view class="form-item">
            <text class="form-label">é‡‘é¢ï¼ˆå…ƒï¼‰</text>
            <view class="form-value-auto">Â¥{{fertilizerForm.amount || 0}}</view>
          </view>
        </view>
      </scroll-view>
      <view class="popup-footer">
        <button class="popup-btn popup-btn-cancel" bindtap="onCloseFertilizerPopup">å–æ¶ˆ</button>
        <button class="popup-btn popup-btn-confirm" bindtap="onSubmitFertilizer">ç¡®è®¤å‘æ”¾</button>
      </view>
    </view>
  </t-popup>

  <!-- ==================== å‘æ”¾å†œè¯å¼¹çª— ==================== -->
  <t-popup visible="{{pesticidePopupVisible}}" placement="bottom" bind:visible-change="onClosePesticidePopup">
    <view class="popup-content">
      <view class="popup-header">
        <text class="popup-title">ğŸ§´ å‘æ”¾å†œè¯</text>
        <view class="popup-close" bindtap="onClosePesticidePopup">
          <t-icon name="close" size="40rpx" color="#9ca3af" />
        </view>
      </view>
      <scroll-view class="popup-scroll" scroll-y>
        <view class="popup-form">
          <view class="form-item">
            <text class="form-label">ä½¿ç”¨æ—¶é—´</text>
            <picker mode="date" value="{{pesticideForm.date}}" bindchange="onPesticideDateChange">
              <view class="picker-value">{{pesticideForm.date || 'è¯·é€‰æ‹©æ—¥æœŸ'}}</view>
            </picker>
          </view>
          <view class="form-item">
            <text class="form-label">å†œè¯åç§°</text>
            <input class="form-input" placeholder="å¦‚ï¼šå¡è™«å•‰ã€è‰ç”˜è†¦ç­‰" value="{{pesticideForm.name}}" bindinput="onPesticideNameInput" />
          </view>
          <view class="form-item">
            <text class="form-label">æ•°é‡ï¼ˆç“¶/kgï¼‰</text>
            <input class="form-input" type="digit" placeholder="è¾“å…¥æ•°é‡" value="{{pesticideForm.quantity}}" bindinput="onPesticideQuantityInput" />
          </view>
          <view class="form-item">
            <text class="form-label">å•ä»·ï¼ˆå…ƒï¼‰</text>
            <input class="form-input" type="digit" placeholder="è¾“å…¥å•ä»·" value="{{pesticideForm.price}}" bindinput="onPesticidePriceInput" />
          </view>
          <view class="form-item">
            <text class="form-label">é‡‘é¢ï¼ˆå…ƒï¼‰</text>
            <view class="form-value-auto">Â¥{{pesticideForm.amount || 0}}</view>
          </view>
        </view>
      </scroll-view>
      <view class="popup-footer">
        <button class="popup-btn popup-btn-cancel" bindtap="onClosePesticidePopup">å–æ¶ˆ</button>
        <button class="popup-btn popup-btn-confirm" bindtap="onSubmitPesticide">ç¡®è®¤å‘æ”¾</button>
      </view>
    </view>
  </t-popup>

  <!-- ==================== é¢„ä»˜æ¬¾å¼¹çª— ==================== -->
  <t-popup visible="{{advancePopupVisible}}" placement="bottom" bind:visible-change="onCloseAdvancePopup">
    <view class="popup-content">
      <view class="popup-header">
        <text class="popup-title">ğŸ’° é¢„ä»˜æ¬¾</text>
        <view class="popup-close" bindtap="onCloseAdvancePopup">
          <t-icon name="close" size="40rpx" color="#9ca3af" />
        </view>
      </view>
      <view class="popup-form">
        <view class="form-item">
          <text class="form-label">é¢„ä»˜æ—¥æœŸ</text>
          <picker mode="date" value="{{advanceForm.date}}" bindchange="onAdvanceDateChange">
            <view class="picker-value">{{advanceForm.date || 'è¯·é€‰æ‹©æ—¥æœŸ'}}</view>
          </picker>
        </view>
        <view class="form-item">
          <text class="form-label">é¢„ä»˜é‡‘é¢ï¼ˆå…ƒï¼‰</text>
          <input class="form-input" type="digit" placeholder="è¾“å…¥é‡‘é¢" value="{{advanceForm.amount}}" bindinput="onAdvanceAmountInput" />
        </view>
        <view class="form-item">
          <text class="form-label">å¤‡æ³¨</text>
          <input class="form-input" placeholder="å¯é€‰å¡«å†™å¤‡æ³¨" value="{{advanceForm.remark}}" bindinput="onAdvanceRemarkInput" />
        </view>
      </view>
      <view class="popup-footer">
        <button class="popup-btn popup-btn-cancel" bindtap="onCloseAdvancePopup">å–æ¶ˆ</button>
        <button class="popup-btn popup-btn-confirm" bindtap="onSubmitAdvance">ç¡®è®¤é¢„ä»˜</button>
      </view>
    </view>
  </t-popup>

  <!-- ==================== è¿½åŠ è´­è‹—å¼¹çª— ==================== -->
  <t-popup visible="{{purchasePopupVisible}}" placement="bottom" bind:visible-change="onClosePurchasePopup">
    <view class="popup-content">
      <view class="popup-header">
        <text class="popup-title">ğŸ›’ è¿½åŠ è´­è‹—</text>
        <view class="popup-close" bindtap="onClosePurchasePopup">
          <t-icon name="close" size="40rpx" color="#9ca3af" />
        </view>
      </view>
      <scroll-view class="popup-scroll" scroll-y>
        <view class="popup-form">
          <view class="form-item">
            <text class="form-label">è´­ä¹°æ—¥æœŸ</text>
            <picker mode="date" value="{{purchaseForm.date}}" bindchange="onPurchaseDateChange">
              <view class="picker-value">{{purchaseForm.date || 'è¯·é€‰æ‹©æ—¥æœŸ'}}</view>
            </picker>
          </view>
          <view class="form-item">
            <text class="form-label">è´­ä¹°æ•°é‡ï¼ˆæ ªï¼‰</text>
            <input class="form-input" type="digit" placeholder="è¾“å…¥æ•°é‡" value="{{purchaseForm.quantity}}" bindinput="onPurchaseQuantityInput" />
          </view>
          <view class="form-item">
            <text class="form-label">å•ä»·ï¼ˆå…ƒ/æ ªï¼‰</text>
            <input class="form-input" type="digit" placeholder="è¾“å…¥å•ä»·" value="{{purchaseForm.price}}" bindinput="onPurchasePriceInput" />
          </view>
          <view class="form-item">
            <text class="form-label">é‡‘é¢ï¼ˆå…ƒï¼‰</text>
            <view class="form-value-auto">Â¥{{purchaseForm.amount || 0}}</view>
          </view>
        </view>
      </scroll-view>
      <view class="popup-footer">
        <button class="popup-btn popup-btn-cancel" bindtap="onClosePurchasePopup">å–æ¶ˆ</button>
        <button class="popup-btn popup-btn-confirm" bindtap="onSubmitPurchase">ç¡®è®¤è´­ä¹°</button>
      </view>
    </view>
  </t-popup>

  <!-- ==================== æŸ¥çœ‹åˆåŒå¼¹çª— ==================== -->
  <t-popup visible="{{contractPopupVisible}}" placement="bottom" bind:visible-change="onCloseContractPopup">
    <view class="popup-content popup-content-tall">
      <view class="popup-header">
        <text class="popup-title">ğŸ“„ åˆåŒé™„ä»¶</text>
        <view class="popup-close" bindtap="onCloseContractPopup">
          <t-icon name="close" size="40rpx" color="#9ca3af" />
        </view>
      </view>
      <scroll-view class="popup-scroll" scroll-y>
        <view class="contract-images" wx:if="{{farmer.contractImages && farmer.contractImages.length > 0}}">
          <image 
            wx:for="{{farmer.contractImages}}" 
            wx:key="*this"
            class="contract-image"
            src="{{item}}"
            mode="widthFix"
            bindtap="onPreviewContract"
            data-url="{{item}}"
          />
        </view>
        <view wx:else class="empty-contract">
          <text>æš‚æ— åˆåŒé™„ä»¶</text>
        </view>
      </scroll-view>
      <view class="popup-footer">
        <button class="popup-btn popup-btn-full" bindtap="onCloseContractPopup">å…³é—­</button>
      </view>
    </view>
  </t-popup>

  <!-- ==================== å®šé‡‘è°ƒæ•´å¼¹çª— ==================== -->
  <t-popup visible="{{depositPopupVisible}}" placement="bottom" bind:visible-change="onCloseDepositPopup">
    <view class="popup-content">
      <view class="popup-header">
        <text class="popup-title">{{depositAction === 'add' ? 'å¢åŠ å®šé‡‘' : 'å‡å°‘å®šé‡‘'}}</text>
        <view class="popup-close" bindtap="onCloseDepositPopup">
          <t-icon name="close" size="40rpx" color="#9ca3af" />
        </view>
      </view>
      <view class="popup-form">
        <view class="form-item">
          <text class="form-label">é‡‘é¢ï¼ˆå…ƒï¼‰</text>
          <input class="form-input" type="digit" placeholder="è¾“å…¥é‡‘é¢" value="{{depositInputValue}}" bindinput="onDepositInputChange" />
        </view>
      </view>
      <view class="popup-footer">
        <button class="popup-btn popup-btn-cancel" bindtap="onCloseDepositPopup">å–æ¶ˆ</button>
        <button class="popup-btn popup-btn-confirm" bindtap="onSubmitDeposit">ç¡®è®¤</button>
      </view>
    </view>
  </t-popup>

  <!-- ==================== é¢ç§¯è°ƒæ•´å¼¹çª— ==================== -->
  <t-popup visible="{{acreagePopupVisible}}" placement="bottom" bind:visible-change="onCloseAcreagePopup">
    <view class="popup-content">
      <view class="popup-header">
        <text class="popup-title">è°ƒæ•´ç§æ¤é¢ç§¯</text>
        <view class="popup-close" bindtap="onCloseAcreagePopup">
          <t-icon name="close" size="40rpx" color="#9ca3af" />
        </view>
      </view>
      <view class="popup-form">
        <view class="form-item">
          <text class="form-label">å½“å‰é¢ç§¯: {{farmer.acreage}} äº©</text>
          <input class="form-input" type="digit" placeholder="è¾“å…¥æ–°çš„é¢ç§¯" value="{{acreageInputValue}}" bindinput="onAcreageInputChange" />
        </view>
      </view>
      <view class="popup-footer">
        <button class="popup-btn popup-btn-cancel" bindtap="onCloseAcreagePopup">å–æ¶ˆ</button>
        <button class="popup-btn popup-btn-confirm" bindtap="onSubmitAcreage">ç¡®è®¤</button>
      </view>
    </view>
  </t-popup>
</view>
