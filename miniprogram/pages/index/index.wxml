<!--
  首页 Dashboard
  根据角色显示不同内容：
  - 助理：我的工作（我的农户、我的发苗、快捷操作）
  - 管理层：数据总览（全公司统计）
-->
<view class="dashboard-page">
  <!-- ==================== 助理视图 ==================== -->
  <block wx:if="{{currentRoleKey === 'salesman'}}">
    <!-- 欢迎横幅 -->
    <view class="salesman-header">
      <view class="header-greeting">
        <text class="greeting-text">{{greeting}}，{{userName}}</text>
        <text class="greeting-sub">今天也要加油哦</text>
      </view>
      <view class="header-logout" bindtap="onLogout">
        <t-icon name="poweroff" size="40rpx" color="#ffffff" />
      </view>
    </view>

    <!-- 我录入的农户卡片 -->
    <view class="my-stats-card">
      <view class="my-stats-title">我录入的农户</view>
      <!-- 第一行：签约数据 -->
      <view class="my-stats-row">
        <view class="my-stat-box" bindtap="goMyFarmers">
          <text class="my-stat-value">{{myStats.farmerCount}}</text>
          <text class="my-stat-label">签约农户(户)</text>
        </view>
        <view class="my-stat-box">
          <text class="my-stat-value">{{myStats.acreage}}</text>
          <text class="my-stat-label">总面积(亩)</text>
        </view>
        <view class="my-stat-box">
          <text class="my-stat-value my-stat-green">{{myStats.depositFormat}}</text>
          <text class="my-stat-label">定金(元)</text>
        </view>
      </view>
      <!-- 第二行：发苗数据 -->
      <view class="my-stats-row my-stats-row-seed">
        <view class="my-stat-box">
          <text class="my-stat-value my-stat-orange">{{myStats.seedCount}}</text>
          <text class="my-stat-label">发苗次数</text>
        </view>
        <view class="my-stat-box">
          <text class="my-stat-value">{{myStats.seedQuantityFormat}}</text>
          <text class="my-stat-label">发苗数量(万株)</text>
        </view>
        <view class="my-stat-box">
          <text class="my-stat-value my-stat-blue">{{myStats.seedAmountFormat}}</text>
          <text class="my-stat-label">苗款金额(元)</text>
        </view>
      </view>
    </view>

    <!-- 快捷操作 -->
    <view class="quick-section">
      <view class="quick-grid">
        <view class="quick-btn quick-btn-primary" bindtap="goAddFarmer">
          <view class="quick-btn-icon">
            <t-icon name="user-add" size="56rpx" color="#ffffff" />
          </view>
          <text class="quick-btn-text">录入农户</text>
        </view>
        <view class="quick-btn quick-btn-secondary" bindtap="goAddSeed">
          <view class="quick-btn-icon">
            <t-icon name="corn" size="56rpx" color="#059669" />
          </view>
          <text class="quick-btn-text">发苗登记</text>
        </view>
      </view>
    </view>

    <!-- 最近签约 -->
    <view class="recent-section">
      <view class="section-header">
        <text class="section-title">最近签约</text>
        <view class="section-more" bindtap="goMyFarmers">
          <text>查看全部</text>
          <t-icon name="chevron-right" size="32rpx" color="#059669" />
        </view>
      </view>
      
      <view class="recent-list" wx:if="{{recentFarmers.length > 0}}">
        <view class="recent-item" wx:for="{{recentFarmers}}" wx:key="id" bindtap="goFarmerDetail" data-id="{{item.id}}">
          <view class="recent-item-left">
            <view class="recent-avatar grade-bar-{{item.grade}}">
              <text>{{item.name[0]}}</text>
            </view>
            <view class="recent-info">
              <text class="recent-name">{{item.name}}</text>
              <text class="recent-meta">{{item.acreage}}亩 · {{item.phone}}</text>
            </view>
          </view>
          <text class="recent-date">{{item.contractDate}}</text>
        </view>
      </view>
      
      <view class="empty-recent" wx:else>
        <text>暂无签约记录，快去录入吧~</text>
      </view>
    </view>
  </block>

  <!-- ==================== 仓库管理员视图 ==================== -->
  <block wx:if="{{currentRoleKey === 'warehouse'}}">
    <!-- 欢迎横幅 -->
    <view class="warehouse-header">
      <view class="warehouse-header-bg"></view>
      <view class="warehouse-header-content">
        <view class="header-greeting">
          <text class="greeting-text">{{greeting}}，{{userName}}</text>
          <text class="greeting-sub">{{warehouseInfo.name}}仓库</text>
        </view>
        <view class="warehouse-code-badge">
          <text class="code-label">仓库编号</text>
          <text class="code-value">{{warehouseInfo.code}}</text>
        </view>
      </view>
    </view>

    <view class="warehouse-actions">
      <t-button theme="primary" size="large" block bindtap="goAcquisitionCreate">收购登记</t-button>
    </view>

    <!-- 今日收苗数据卡片 -->
    <view class="today-stats-card">
      <view class="stats-card-header">
        <view class="stats-card-title">

          <text>今日收苗</text>
        </view>
        <text class="stats-date">{{todayDate}}</text>
      </view>
      
      <view class="today-stats-row">
        <view class="today-stat-item">
          <text class="today-stat-value">{{warehouseStats.todayQuantity}}</text>
          <text class="today-stat-label">收购数量 (kg)</text>
        </view>
        <view class="today-stat-divider"></view>
        <view class="today-stat-item">
          <text class="today-stat-value today-stat-green">{{warehouseStats.todayAmountWan}}</text>
          <text class="today-stat-label">收购金额 (万元)</text>
        </view>
        <view class="today-stat-divider"></view>
        <view class="today-stat-item">
          <text class="today-stat-value today-stat-blue">{{warehouseStats.todayFarmerCount}}</text>
          <text class="today-stat-label">农户数 (户)</text>
        </view>
      </view>
    </view>

    <!-- 累计数据卡片 -->
    <view class="total-stats-card">
      <view class="stats-card-header">
        <view class="stats-card-title">

          <text>累计数据</text>
        </view>
      </view>
      
      <view class="total-stats-grid">
        <view class="total-stat-box">
          <text class="total-stat-label">累计收购</text>
          <text class="total-stat-value">{{warehouseStats.totalQuantity}}</text>
          <text class="total-stat-unit">kg</text>
        </view>
        <view class="total-stat-box">
          <text class="total-stat-label">累计金额</text>
          <text class="total-stat-value total-stat-green">{{warehouseStats.totalAmountWan}}</text>
          <text class="total-stat-unit">万元</text>
        </view>
        <view class="total-stat-box">
          <text class="total-stat-label">累计农户</text>
          <text class="total-stat-value total-stat-blue">{{warehouseStats.totalFarmerCount}}</text>
          <text class="total-stat-unit">户</text>
        </view>
      </view>
    </view>

    <!-- 库存数据卡片 -->
    <view class="stock-stats-card">
      <view class="stats-card-header">
        <view class="stats-card-title">

          <text>库存情况</text>
        </view>
      </view>
      
      <view class="stock-stats-row">
        <view class="stock-stat-item stock-current">
          <view class="stock-stat-top">
            <text class="stock-stat-label">当前库存</text>
            <view class="stock-badge stock-badge-success">正常</view>
          </view>
          <text class="stock-stat-value">{{warehouseStats.currentStock}}</text>
          <text class="stock-stat-unit">kg</text>
        </view>
        <view class="stock-stat-item stock-out">
          <view class="stock-stat-top">
            <text class="stock-stat-label">已出库</text>
          </view>
          <text class="stock-stat-value">{{warehouseStats.outStock}}</text>
          <text class="stock-stat-unit">kg</text>
        </view>
      </view>
    </view>


  </block>

  <!-- ==================== 管理层视图 ==================== -->
  <block wx:if="{{currentRoleKey === 'finance'}}">
    <!-- 欢迎横幅 -->
    <view class="welcome-banner">
      <view class="banner-content">
        <view class="banner-left">
          <view class="banner-subtitle">数据总览</view>
          <view class="banner-title">{{greeting}}，{{userName}}</view>
        </view>
        <view class="banner-right" bindtap="onScanTap">
          <t-icon name="qrcode" size="48rpx" color="#ffffff" />
        </view>
      </view>
    </view>

    <!-- 核心指标卡片 -->
    <view class="overview-cards" wx:if="{{farmerSummary}}">
      <view class="overview-tab-bar">
        <view class="overview-tab {{overviewTab === 0 ? 'active' : ''}}" bindtap="switchOverviewTab" data-tab="0">
          <text>昨日新增</text>
        </view>
        <view class="overview-tab {{overviewTab === 1 ? 'active' : ''}}" bindtap="switchOverviewTab" data-tab="1">
          <text>全年度累计</text>
        </view>
      </view>

      <view class="overview-row overview-row-3">
        <view class="overview-card" data-type="farmers" bindtap="onStatTap">
          <view class="overview-bg-icon">
            <t-icon name="user" size="80rpx" color="rgba(5, 150, 105, 0.1)" />
          </view>
          <view class="overview-info">
            <text class="overview-value">{{currentOverview.farmers}}</text>
            <text class="overview-label">签约农户(户)</text>
          </view>
        </view>
        <view class="overview-card">
          <view class="overview-bg-icon">
            <t-icon name="location" size="80rpx" color="rgba(5, 150, 105, 0.1)" />
          </view>
          <view class="overview-info">
            <text class="overview-value">{{currentOverview.acreage}}</text>
            <text class="overview-label">种植面积(亩)</text>
          </view>
        </view>
        <view class="overview-card">
          <view class="overview-bg-icon">
            <t-icon name="money-circle" size="80rpx" color="rgba(5, 150, 105, 0.1)" />
          </view>
          <view class="overview-info">
            <text class="overview-value">{{currentOverview.deposit}}</text>
            <text class="overview-label">定金总额(元)</text>
          </view>
        </view>
      </view>

      <!-- 等级分布 -->
      <view class="grade-chart-card">
        <view class="grade-row">
          <view class="grade-row-left">
            <view class="grade-dot grade-dot-gold"></view>
            <text class="grade-name">金牌</text>
          </view>
          <view class="grade-row-center">
            <view class="grade-bar-bg">
              <view class="grade-bar-fill grade-fill-gold" style="width: {{farmerSummary.gradeDistribution.goldPercent}}%;">
                <text class="grade-bar-percent">{{farmerSummary.gradeDistribution.goldPercent}}%</text>
              </view>
            </view>
          </view>
          <text class="grade-count">{{farmerSummary.gradeDistribution.gold}}户</text>
        </view>
        <view class="grade-row">
          <view class="grade-row-left">
            <view class="grade-dot grade-dot-silver"></view>
            <text class="grade-name">银牌</text>
          </view>
          <view class="grade-row-center">
            <view class="grade-bar-bg">
              <view class="grade-bar-fill grade-fill-silver" style="width: {{farmerSummary.gradeDistribution.silverPercent}}%;">
                <text class="grade-bar-percent">{{farmerSummary.gradeDistribution.silverPercent}}%</text>
              </view>
            </view>
          </view>
          <text class="grade-count">{{farmerSummary.gradeDistribution.silver}}户</text>
        </view>
        <view class="grade-row">
          <view class="grade-row-left">
            <view class="grade-dot grade-dot-bronze"></view>
            <text class="grade-name">铜牌</text>
          </view>
          <view class="grade-row-center">
            <view class="grade-bar-bg">
              <view class="grade-bar-fill grade-fill-bronze" style="width: {{farmerSummary.gradeDistribution.bronzePercent}}%;">
                <text class="grade-bar-percent">{{farmerSummary.gradeDistribution.bronzePercent}}%</text>
              </view>
            </view>
          </view>
          <text class="grade-count">{{farmerSummary.gradeDistribution.bronze}}户</text>
        </view>
      </view>
    </view>

    <!-- 负责人统计 -->
    <view class="section">
      <view class="section-header-row">
        <text class="section-title">负责人签约统计</text>
        <view class="section-detail-btn" bindtap="goSalesmanDetail">
          <text>详情</text>
          <t-icon name="chevron-right" size="32rpx" color="#059669" />
        </view>
      </view>
      
      <view class="salesman-tab-bar">
        <view class="salesman-tab {{salesmanTab === 0 ? 'active' : ''}}" bindtap="switchSalesmanTab" data-tab="0">
          <text>昨日新增</text>
        </view>
        <view class="salesman-tab {{salesmanTab === 1 ? 'active' : ''}}" bindtap="switchSalesmanTab" data-tab="1">
          <text>全年度</text>
        </view>
      </view>
      
      <view class="card salesman-card">
        <block wx:if="{{displaySalesmanList.length > 0}}">
          <view class="salesman-table-header">
            <text class="col-rank">#</text>
            <text class="col-name">负责人</text>
            <text class="col-count">农户</text>
            <text class="col-acreage">面积</text>
            <text class="col-deposit">定金</text>
          </view>
          
          <view class="salesman-list">
            <view class="salesman-item" wx:for="{{displaySalesmanList}}" wx:key="salesmanId">
              <text class="col-rank item-rank">{{item.rank}}</text>
              <text class="col-name item-name">{{item.salesmanName}}</text>
              <text class="col-count item-count">{{item.farmerCount}}</text>
              <text class="col-acreage item-acreage">{{item.formatAcreage}}</text>
              <text class="col-deposit item-deposit">{{item.formatDeposit}}</text>
            </view>
          </view>
          
          <view class="salesman-expand" bindtap="toggleSalesmanExpand" wx:if="{{salesmanStats.length > 5}}">
            <text>{{salesmanExpanded ? '收起' : '查看更多'}}</text>
            <t-icon name="{{salesmanExpanded ? 'chevron-up' : 'chevron-down'}}" size="32rpx" color="#059669" />
          </view>
        </block>
        
        <view class="salesman-empty" wx:else>
          <t-icon name="info-circle" size="64rpx" color="#d1d5db" />
          <text class="empty-text">昨日暂无新增签约</text>
        </view>
      </view>
    </view>

    <!-- 发苗统计 -->
    <view class="section" wx:if="{{seedYesterday && seedYearTotal}}">
      <view class="section-header-row">
        <text class="section-title">发苗统计</text>
        <view class="section-detail-btn" bindtap="goSeedDetail">
          <text>详情</text>
          <t-icon name="chevron-right" size="32rpx" color="#059669" />
        </view>
      </view>
      
      <view class="card seed-stats-card" bindtap="goSeedDetail">
        <view class="seed-stats-header">
          <view class="seed-stats-title">
            <text>甜叶菊</text>
            <t-icon name="chevron-right" size="28rpx" color="#9ca3af" />
          </view>
          <view class="seed-stats-tabs">
            <view class="seed-tab {{seedStatsTab === 0 ? 'seed-tab-active' : ''}}" catchtap="onSeedStatsTabChange" data-value="{{0}}">昨日</view>
            <view class="seed-tab {{seedStatsTab === 1 ? 'seed-tab-active' : ''}}" catchtap="onSeedStatsTabChange" data-value="{{1}}">年度累计</view>
          </view>
        </view>

        <view class="seed-overview">
          <view class="seed-overview-progress">
            <view class="seed-overview-info">
              <text class="seed-overview-label">发苗进度</text>
              <text class="seed-overview-value">{{seedYearTotal.distributedFarmerCount}}/{{seedYearTotal.totalFarmerCount}}户</text>
            </view>
            <view class="seed-overview-percent">{{seedYearTotal.distributionPercent}}%</view>
          </view>
          <view class="seed-overview-bar">
            <view class="seed-overview-fill" style="width: {{seedYearTotal.distributionPercent}}%;"></view>
          </view>
        </view>

        <view class="seed-stats-content" wx:if="{{seedStatsTab === 0}}">
          <view class="seed-core-stats">
            <view class="seed-core-item">
              <text class="seed-core-value">{{seedYesterdayFormat.quantity}}</text>
              <text class="seed-core-label">发放</text>
            </view>
            <view class="seed-core-divider"></view>
            <view class="seed-core-item">
              <text class="seed-core-value">{{seedYesterdayFormat.amount}}</text>
              <text class="seed-core-label">金额</text>
            </view>
            <view class="seed-core-divider"></view>
            <view class="seed-core-item">
              <text class="seed-core-value seed-value-green">{{seedYesterdayFormat.paid}}</text>
              <text class="seed-core-label">已收</text>
            </view>
            <view class="seed-core-divider"></view>
            <view class="seed-core-item">
              <text class="seed-core-value seed-value-orange">{{seedYesterdayFormat.unpaid}}</text>
              <text class="seed-core-label">欠款</text>
            </view>
          </view>
        </view>

        <view class="seed-stats-content" wx:if="{{seedStatsTab === 1}}">
          <view class="seed-core-stats">
            <view class="seed-core-item">
              <text class="seed-core-value">{{seedYearFormat.quantity}}</text>
              <text class="seed-core-label">发放</text>
            </view>
            <view class="seed-core-divider"></view>
            <view class="seed-core-item">
              <text class="seed-core-value">{{seedYearFormat.amount}}</text>
              <text class="seed-core-label">金额</text>
            </view>
            <view class="seed-core-divider"></view>
            <view class="seed-core-item">
              <text class="seed-core-value seed-value-green">{{seedYearFormat.paid}}</text>
              <text class="seed-core-label">已收</text>
            </view>
            <view class="seed-core-divider"></view>
            <view class="seed-core-item">
              <text class="seed-core-value seed-value-orange">{{seedYearFormat.unpaid}}</text>
              <text class="seed-core-label">欠款</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </block>

  <!-- ==================== 出纳视图 ==================== -->
  <block wx:if="{{currentRoleKey === 'cashier'}}">
    <!-- 欢迎横幅 -->
    <view class="cashier-header">
      <view class="header-greeting">
        <text class="greeting-text">{{greeting}}，{{userName}}</text>
        <text class="greeting-sub">出纳工作台</text>
      </view>
      <view class="header-logout" bindtap="onLogout">
        <t-icon name="poweroff" size="40rpx" color="#ffffff" />
      </view>
    </view>

    <!-- 待付款统计卡片 -->
    <view class="cashier-stats-card pending-card" bindtap="goSettlementPage">
      <view class="cashier-card-header">
        <view class="cashier-card-icon pending-icon">
          <t-icon name="wallet" size="48rpx" color="#ffffff" />
        </view>
        <view class="cashier-card-title">
          <text class="title-main">待付款结算</text>
          <text class="title-sub">点击查看详情</text>
        </view>
        <t-icon name="chevron-right" size="40rpx" color="#9ca3af" />
      </view>
      <view class="cashier-card-content">
        <view class="cashier-stat-item">
          <text class="cashier-stat-value pending-value">{{cashierStats.pendingCount || 0}}</text>
          <text class="cashier-stat-label">待付笔数</text>
        </view>
        <view class="cashier-stat-divider"></view>
        <view class="cashier-stat-item">
          <text class="cashier-stat-value pending-amount">¥{{cashierStats.pendingAmountFormat || '0'}}</text>
          <text class="cashier-stat-label">待付金额</text>
        </view>
      </view>
    </view>

    <!-- 今日已付款统计卡片 -->
    <view class="cashier-stats-card today-card">
      <view class="cashier-card-header">
        <view class="cashier-card-icon today-icon">
          <t-icon name="check-circle" size="48rpx" color="#ffffff" />
        </view>
        <view class="cashier-card-title">
          <text class="title-main">今日已付</text>
        </view>
      </view>
      <view class="cashier-card-content">
        <view class="cashier-stat-item">
          <text class="cashier-stat-value today-value">{{cashierStats.todayPaidCount || 0}}</text>
          <text class="cashier-stat-label">已付笔数</text>
        </view>
        <view class="cashier-stat-divider"></view>
        <view class="cashier-stat-item">
          <text class="cashier-stat-value today-amount">¥{{cashierStats.todayPaidAmountFormat || '0'}}</text>
          <text class="cashier-stat-label">已付金额</text>
        </view>
      </view>
    </view>

    <!-- 快捷操作 -->
    <view class="cashier-actions">
      <view class="cashier-action-btn" bindtap="goSettlementPage">
        <view class="action-icon">
          <t-icon name="wallet" size="56rpx" color="#059669" />
        </view>
        <text class="action-text">去付款</text>
      </view>
    </view>
  </block>

  <!-- 底部间距 -->
  <view class="bottom-space"></view>
</view>
