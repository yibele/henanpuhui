## 改造方案（在现有框架下的最小增量）

目标：在不大动现有页面框架、主页面不改的前提下，补齐甲方要求。先让业务员/仓库/财务能录入与跑通流程，再给管理方提供全局视角与汇总看板。

### 角色与权限
- 业务员：签约录入/编辑；自己负责农户的发苗/农资/预付/追加购苗；查看自身范围明细与个人汇总。
- 仓库管理员：成品收购录入；仓库发货/转运/库存预警；仅本仓库可见。
- 财务（含管理层同权限）：查看全部；录入结算/支付/预付；查看农资/收购/库存/结算汇总。
- 管理层：同财务查看 + 总览看板、负责人维度汇总；不做一线录入。
- 前端显隐：`role` 注入 `data`，`wxml` 用 `wx:if` 控制按钮/区块；后端接口按角色二次校验。

### 模块改造（主页面除外）
**模块1 签约信息（`farmers/add`, `farmers/detail` 基础信息区）**
- 补字段：姓名、电话、身份证、地址（县/乡/镇/村）、面积+增减记录、等级（金/银/铜）、定金+增减、负责人、客户编码（业务员编号+手机号）、合同图片。
- 批量导入：`farmers/list` 加“导入”入口（录入权限可见），校验必填/手机号格式/重复手机号。
- 汇总（管理/财务可见）：已签约户数、总面积、定金总额、金银铜占比；负责人维度同样指标。

**模块2 种苗发放（基于现有发苗弹窗）**
- 表单保留，补字段：发苗负责人；每户次数上限=10；金额自动算。
- 汇总：昨日/累计数量、总价、各品种数量、单价、已收款/欠款、覆盖率（已发苗户/签约户）。管理/财务可见，业务员仅自己范围。

**模块3 农资使用/种植指导（新增区块+弹窗）**
- 农资使用录入（限10次/户）：时间、类型（农药/化肥）、名称、单价、数量、金额自动算；录入人=财务或指定账号。
- 时间轴节点+预警：节点（苗期/成活率、农药、追肥、成熟）+计划时间，逾期标红。
- 汇总：使用公司农资的农户数量/占比、金额；负责人维度同样统计。管理/财务可见，业务员看自身。

**模块4 收购与库存（新增“收购录入”弹窗 + 仓库页）**
- 成品回收录入（农户详情内）：毛重、皮重、水杂率→自动算水杂/净重；单价、奖励、收购价、金额、仓库、录入人。限20录入账号（仓库/指定）。
- 仓库页：每仓库的累计收购、发货、仓库间转运、实际库存=收购-发货+转运；容量与剩余仓位<15%预警。仓库管理员可录入发货/转运，管理/财务可查看。
- 汇总：今日/累计收购重量、金额、单价；按仓库拆分；累计已卖农户数。管理/财务可见。

**模块5 结算管理（详情页新增区块）**
- 自动算应付（基于发苗/农资/收购/预付），财务勾选确认，可备注校对。
- 预付款录入：沿用现有“预付款”弹窗，记录时间与金额。
- 分批支付（≤5笔）：每笔金额/时间；展示应付/已付/待付。
- 汇总：已结算农户数、应付、已付、待付；待结算列表。财务/管理可见。

### 数据与接口（最小集，可先云函数）
- 表/集合：`farmer`、`seed_records`、`agri_use_records`、`seedling_purchase_records`、`advance_records`、`harvest_records`、`warehouse_inventory`、`settlement_records`、`payment_records`。
- 核心接口示例：`GET/POST /farmer`、`POST /farmer/import`、`POST /seed/record`、`GET /seed/summary`、`POST /agri/record`、`GET /agri/summary`、`POST /harvest/record`、`GET /harvest/summary`、`POST /warehouse/transfer`、`GET /warehouse/summary`、`POST /settlement/confirm`、`POST /payment`、`GET /settlement/summary`。
- 权限：业务员仅负责农户；仓库接口限定仓库 ID；财务/管理可读全量。

### 前端改造点（保持现有结构）
- `farmers/list`：保留搜索；加“导入”按钮（有录入权限可见）；可选在列表头展示汇总卡片（管理/财务）。
- `farmers/add`：补签约字段（等级、面积/定金增减、负责人、客户编码）；前端先算编码，后端复核。
- `farmers/detail`：
  - 展示签约字段/定金/面积。
  - 发苗弹窗：加负责人、次数限制提示。
  - 新增“农资使用”弹窗与记录列表；时间轴节点区块（简单状态+预警标记）。
  - 新增“收购录入”弹窗；收购记录列表。
  - 新增“结算”区块：应付/已付/待付、预付款、分批支付列表、财务确认按钮。
  - 显隐：业务员（发苗/农资/预付/追加购苗）、仓库（收购录入）、财务/管理（结算/支付、汇总）、管理（总览卡片）。
- 可选新增页：`summary/dashboard`（管理/财务），聚合各模块汇总与负责人维度数据。

### 计算与校验规则（前端先做，后端复核）
- 金额=数量*单价（两位小数）；水杂=（毛重-皮重）*水杂率；净重=毛重-皮重-水杂；收购价=单价+奖励；金额=收购价*净重。
- 仓库库存：库存=收购-发货+转运；剩余=容量-库存；<15%预警。
- 次数限制：发苗/农资各10次/户；收购录入次数按需求配置。
- 编码：客户编码=业务员编号+手机号（前端拼接，后端校验唯一）。

### 落地优先级（先能用后完善）
1. 补签约字段 + 导入入口 + 定金/面积增减逻辑。
2. 发苗完善（负责人+次数限制）与汇总接口。
3. 农资使用录入 + 简易时间轴预警。
4. 收购录入 + 仓库库存/预警视图。
5. 结算/支付区块与汇总。
6. 管理方汇总看板（总览与负责人维度）。

### 待确认
- 角色字段名与取值来源（现有账号体系）。
- 导入文件模板格式。
- 时间轴预警规则（提前/逾期天数）。
- 仓库容量与预警阈值是否固定15%。
- 支付/收款是否需对接第三方或仅登记。

