# 普惠农户 CRM 系统架构设计文档

> 版本：v1.0  
> 创建日期：2024-12-04  
> 状态：待确认

---

## 📋 目录

1. [项目概述](#1-项目概述)
2. [技术架构](#2-技术架构)
3. [系统模块](#3-系统模块)
4. [数据库设计](#4-数据库设计)
5. [云函数设计](#5-云函数设计)
6. [前端应用](#6-前端应用)
7. [部署方案](#7-部署方案)
8. [开发计划](#8-开发计划)
9. [待确认事项](#9-待确认事项)

---

## 1. 项目概述

### 1.1 项目背景

普惠农户 CRM 系统是一个面向农业企业的客户关系管理系统，用于管理签约农户、种苗发放、种植指导、农产品收购、财务结算等核心业务流程。

### 1.2 用户角色

| 角色 | 使用端 | 主要功能 |
|------|--------|----------|
| 外勤员工 | 小程序 | 农户录入、种苗发放、收购登记、种植指导 |
| 管理员 | 小程序 + 网页后台 | 数据查看、统计分析、结算审核 |
| 财务人员 | 网页后台 | 结算管理、报表导出 |

### 1.3 核心功能

- **农户管理**：签约农户信息录入、查询、状态管理
- **种苗发放**：种苗/物资发放登记、库存管理
- **种植指导**：技术指导记录、现场照片
- **收购管理**：农产品收购登记、称重记录
- **财务结算**：结算单生成、扣款计算、支付状态
- **数据看板**：业务统计、趋势分析
- **AI 助手**：智能问答（对接微信 DeepSeek）

---

## 2. 技术架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户层                                    │
│                                                                 │
│    ┌─────────────────┐              ┌─────────────────┐        │
│    │   微信小程序      │              │   网页后台系统    │        │
│    │  (TDesign 组件)  │              │  (Vue3+TDesign) │        │
│    │   外勤员工使用    │              │   管理员使用      │        │
│    └────────┬────────┘              └────────┬────────┘        │
└─────────────┼────────────────────────────────┼──────────────────┘
              │                                │
              │ 小程序 SDK                      │ Web SDK
              │                                │
┌─────────────┼────────────────────────────────┼──────────────────┐
│             │      微信云开发环境              │                  │
│             └────────────────┬───────────────┘                  │
│                              │                                  │
│  ┌───────────────────────────┴────────────────────────────────┐ │
│  │                        云函数层                             │ │
│  │                                                            │ │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      │ │
│  │  │  auth    │ │  farmer  │ │ operation│ │ finance  │      │ │
│  │  │ 用户认证  │ │ 农户管理  │ │ 作业管理  │ │ 财务结算  │      │ │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘      │ │
│  │                                                            │ │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐                   │ │
│  │  │ inventory│ │   ai     │ │  stats   │                   │ │
│  │  │ 库存管理  │ │ AI助手   │ │ 统计分析  │                   │ │
│  │  └──────────┘ └──────────┘ └──────────┘                   │ │
│  └────────────────────────────────────────────────────────────┘ │
│                              │                                  │
│  ┌───────────────────────────┴────────────────────────────────┐ │
│  │                        数据层                               │ │
│  │                                                            │ │
│  │  ┌─────────────────────┐    ┌─────────────────────┐       │ │
│  │  │      云数据库         │    │       云存储         │       │ │
│  │  │                     │    │                     │       │ │
│  │  │  · users           │    │  · 合同照片          │       │ │
│  │  │  · farmers         │    │  · 身份证照片        │       │ │
│  │  │  · seed_records    │    │  · 指导现场照片      │       │ │
│  │  │  · guidance        │    │  · 收购凭证          │       │ │
│  │  │  · acquisitions    │    │                     │       │ │
│  │  │  · inventory       │    │                     │       │ │
│  │  │  · settlements     │    │                     │       │ │
│  │  └─────────────────────┘    └─────────────────────┘       │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                     静态网站托管                            │ │
│  │              (网页后台系统部署位置)                          │ │
│  │           https://xxx.tcloudbase.com                       │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 技术选型

| 层级 | 技术选型 | 说明 |
|------|----------|------|
| 小程序端 | 原生小程序 + TypeScript | 已完成 UI 开发 |
| 小程序 UI | TDesign 小程序组件库 | 腾讯官方组件库 |
| 网页后台 | Vue3 + TypeScript | 主流前端框架 |
| 网页 UI | TDesign Vue Next | 与小程序风格统一 |
| 后端服务 | 微信云开发云函数 | Serverless，免运维 |
| 数据库 | 微信云开发云数据库 | JSON 文档数据库 |
| 文件存储 | 微信云开发云存储 | 图片、文件存储 |
| AI 能力 | 微信官方 DeepSeek | 智能问答 |

### 2.3 为什么选择云开发？

| 优势 | 说明 |
|------|------|
| **零运维** | 无需购买/维护服务器 |
| **免费额度** | 初期完全免费，后续按量付费 |
| **数据共享** | 小程序和网页共用同一数据库 |
| **快速开发** | 省去后端搭建，专注业务逻辑 |
| **安全可靠** | 腾讯云基础设施，自动备份 |
| **弹性扩展** | 自动扩容，无需担心并发 |

---

## 3. 系统模块

### 3.1 小程序端模块

```
小程序
├── 登录模块
│   └── 手机号验证码登录
│
├── 首页 Dashboard
│   ├── 数据看板（待确认具体指标）
│   ├── 快捷操作入口
│   └── 业务趋势图表
│
├── 农户管理
│   ├── 农户列表（搜索/筛选）
│   ├── 农户详情
│   ├── 新增农户
│   └── 状态变更
│
├── 农事作业
│   ├── 种苗发放登记
│   ├── 种植指导记录
│   ├── 收购录入
│   └── 库存查询
│
├── 财务结算（只读查看）
│   └── 结算记录列表
│
└── AI 智能助手
    └── 对话问答
```

### 3.2 网页后台模块

```
网页后台
├── 登录模块
│   └── 账号密码 / 微信扫码登录
│
├── 数据看板
│   ├── 核心指标统计
│   ├── 趋势图表
│   └── 实时数据
│
├── 农户管理
│   ├── 农户列表（高级筛选）
│   ├── 批量导入/导出
│   └── 农户详情编辑
│
├── 作业管理
│   ├── 发放记录查询
│   ├── 指导记录查询
│   └── 收购记录查询
│
├── 库存管理
│   ├── 库存列表
│   ├── 入库/出库
│   └── 库存盘点
│
├── 财务结算（待确认具体需求）
│   ├── 结算单列表
│   ├── 结算单详情
│   ├── 批量结算
│   └── 结算审核
│
├── 报表中心
│   ├── 业务报表
│   ├── 财务报表
│   └── 数据导出
│
└── 系统设置
    ├── 用户管理
    ├── 角色权限
    └── 系统配置
```

---

## 4. 数据库设计

### 4.1 集合（表）结构

#### users - 用户表

```javascript
{
  _id: "user_001",              // 用户ID
  phone: "13800138000",         // 手机号
  name: "张三",                  // 姓名
  role: "STAFF",                // 角色: ADMIN / STAFF / FINANCE
  avatar: "cloud://xxx",        // 头像
  openid: "xxx",                // 微信 openid
  status: "active",             // 状态
  createTime: Date,             // 创建时间
  lastLoginTime: Date           // 最后登录时间
}
```

#### farmers - 农户表

```javascript
{
  _id: "farmer_001",
  name: "李四",                  // 姓名
  phone: "13900139000",         // 电话
  idCard: "510100xxxx",         // 身份证号
  bankAccount: "6222xxxx",      // 银行卡号
  bankName: "农业银行",          // 开户行
  address: "幸福村3组",          // 地址
  acreage: 15.5,                // 种植面积（亩）
  contractDate: "2024-01-15",   // 签约日期
  contractImages: ["cloud://xxx"], // 合同照片
  status: "active",             // 状态: active/pending/inactive
  createBy: "user_001",         // 创建人
  createTime: Date,
  updateTime: Date
}
```

#### seed_records - 种苗发放表

```javascript
{
  _id: "seed_001",
  farmerId: "farmer_001",       // 农户ID
  farmerName: "李四",            // 农户姓名（冗余）
  seedType: "优质稻谷A",         // 种苗品类
  quantity: 50,                 // 数量（kg）
  date: "2024-04-01",           // 发放日期
  distributor: "user_001",      // 发放人ID
  distributorName: "张三",       // 发放人姓名
  remark: "",                   // 备注
  createTime: Date
}
```

#### guidance - 种植指导表

```javascript
{
  _id: "guide_001",
  farmerId: "farmer_001",
  farmerName: "李四",
  guidanceType: "fertilizer",   // 类型: fertilizer/pesticide/technical/other
  notes: "建议每亩施用尿素20kg", // 指导内容
  images: ["cloud://xxx"],      // 现场照片
  date: "2024-05-15",
  technician: "user_001",       // 技术员ID
  technicianName: "张三",
  createTime: Date
}
```

#### acquisitions - 收购记录表

```javascript
{
  _id: "acq_001",
  farmerId: "farmer_001",
  farmerName: "李四",
  productType: "成熟稻谷",       // 品类
  quantity: 5000,               // 重量（kg）
  pricePerKg: 2.4,              // 单价（元/kg）
  totalAmount: 12000,           // 总金额
  date: "2024-10-20",
  operator: "user_001",         // 操作员ID
  operatorName: "张三",
  settlementId: null,           // 关联的结算单ID
  status: "pending",            // pending/settled
  createTime: Date
}
```

#### inventory - 库存表

```javascript
{
  _id: "inv_001",
  name: "优质稻谷A (种子)",
  category: "seed",             // seed/fertilizer/crop/other
  quantity: 450,
  unit: "kg",
  location: "1号库 A区",
  minStock: 100,                // 最低库存预警
  updateTime: Date
}
```

#### settlements - 结算表

```javascript
{
  _id: "settle_001",
  farmerId: "farmer_001",
  farmerName: "李四",
  acquisitionIds: ["acq_001"],  // 关联的收购记录
  totalAmount: 12000,           // 收购总额
  deductions: [                 // 扣款明细
    { type: "seed", amount: 300, note: "种子款" },
    { type: "fertilizer", amount: 200, note: "肥料款" }
  ],
  deductionTotal: 500,          // 扣款合计
  finalAmount: 11500,           // 实付金额
  status: "unpaid",             // unpaid/paid
  createTime: Date,
  paymentTime: null,            // 支付时间
  paymentMethod: null,          // 支付方式
  paymentBy: null,              // 支付操作人
  remark: ""
}
```

### 4.2 索引设计

| 集合 | 索引字段 | 说明 |
|------|----------|------|
| farmers | phone | 手机号查询 |
| farmers | status, createTime | 状态筛选 |
| seed_records | farmerId, date | 农户发放记录 |
| acquisitions | farmerId, status | 农户收购记录 |
| settlements | farmerId, status | 农户结算记录 |

---

## 5. 云函数设计

### 5.1 函数列表

| 函数名 | 功能 | 触发方式 |
|--------|------|----------|
| auth | 用户认证（登录/注册） | 小程序/Web 调用 |
| farmer | 农户增删改查 | 小程序/Web 调用 |
| operation | 作业管理（发放/指导/收购） | 小程序调用 |
| inventory | 库存管理 | 小程序/Web 调用 |
| settlement | 结算管理 | Web 调用 |
| stats | 统计分析 | 小程序/Web 调用 |
| ai | AI 助手对话 | 小程序调用 |
| export | 数据导出 | Web 调用 |

### 5.2 函数结构示例

```javascript
// cloudfunctions/farmer/index.js
const cloud = require('wx-server-sdk');
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const db = cloud.database();

exports.main = async (event, context) => {
  const { action, data } = event;
  
  switch (action) {
    case 'list':
      return await listFarmers(data);
    case 'detail':
      return await getFarmerDetail(data);
    case 'add':
      return await addFarmer(data);
    case 'update':
      return await updateFarmer(data);
    default:
      return { code: -1, message: '未知操作' };
  }
};
```

---

## 6. 前端应用

### 6.1 小程序端

**当前状态**：UI 开发已完成 ✅

**技术栈**：
- 原生微信小程序
- TypeScript
- TDesign 小程序组件库

**目录结构**：
```
miniprogram/
├── pages/
│   ├── login/          # 登录页
│   ├── index/          # 首页
│   ├── farmers/        # 农户管理
│   ├── operations/     # 农事作业
│   ├── finance/        # 财务结算
│   └── ai/             # AI 助手
├── models/             # 数据类型定义
├── custom-tab-bar/     # 自定义导航栏
└── docs/               # 文档
```

### 6.2 网页后台

**当前状态**：待开发

**技术栈**：
- Vue 3 + TypeScript
- TDesign Vue Next
- Vite 构建工具
- 云开发 Web SDK

**功能规划**：
- 数据看板（图表展示）
- 农户管理（高级筛选、批量操作）
- 作业记录查询
- 库存管理
- 财务结算管理
- 报表导出
- 系统设置

---

## 7. 部署方案

### 7.1 环境规划

| 环境 | 用途 | 云开发环境 ID |
|------|------|--------------|
| 开发环境 | 开发调试 | puhui-dev |
| 生产环境 | 正式使用 | puhui-prod |

### 7.2 部署流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  本地开发    │ --> │  开发环境    │ --> │  生产环境    │
│             │     │  测试验证    │     │  正式发布    │
└─────────────┘     └─────────────┘     └─────────────┘
```

### 7.3 费用预估

#### 云开发免费额度（每月）

| 资源 | 免费额度 | 预估使用 |
|------|----------|----------|
| 云数据库存储 | 2 GB | < 100 MB |
| 云数据库读取 | 5 万次/天 | < 1 万次/天 |
| 云数据库写入 | 3 万次/天 | < 5000 次/天 |
| 云存储容量 | 5 GB | < 2 GB |
| 云存储下载 | 2 GB/月 | < 1 GB/月 |
| 云函数调用 | 4 万次/月 | < 2 万次/月 |
| 静态网站托管 | 1 GB | < 100 MB |

**结论**：初期免费额度完全够用，预计月费用 **0 元**

---

## 8. 开发计划

### 8.1 阶段划分

| 阶段 | 内容 | 预估时间 | 状态 |
|------|------|----------|------|
| Phase 1 | 小程序 UI 开发 | - | ✅ 已完成 |
| Phase 2 | 云开发环境搭建 + 数据库设计 | 1 天 | 待开始 |
| Phase 3 | 云函数开发 | 2-3 天 | 待开始 |
| Phase 4 | 小程序对接云开发 | 1-2 天 | 待开始 |
| Phase 5 | 网页后台开发 | 3-5 天 | 待开始 |
| Phase 6 | AI 助手对接 | 1 天 | 待开始 |
| Phase 7 | 测试 & 优化 | 2 天 | 待开始 |

### 8.2 里程碑

- [ ] **M1**：云开发环境就绪，数据库可用
- [ ] **M2**：小程序核心功能可用
- [ ] **M3**：网页后台基础功能可用
- [ ] **M4**：系统全功能上线

---

## 9. 待确认事项

> ⚠️ 以下事项需要与甲方确认后再进行开发

### 9.1 首页看板数据

**当前设计**：
- 本月收购量（kg）
- 待结算金额（元）
- 总签约农户数
- 进行中合同数

**待确认**：
- [ ] 看板需要展示哪些核心指标？
- [ ] 是否需要按时间范围筛选（日/周/月/年）？
- [ ] 是否需要对比数据（同比/环比）？
- [ ] 图表展示哪些趋势数据？

### 9.2 结算功能

**当前设计**：
- 小程序端：只读查看结算记录
- 网页后台：结算审核、支付确认

**待确认**：
- [ ] 结算流程是怎样的？
- [ ] 扣款项有哪些？如何计算？
- [ ] 是否需要多级审批？
- [ ] 支付方式有哪些？
- [ ] 是否需要对接银行/支付系统？
- [ ] 结算单需要打印吗？

### 9.3 其他待确认

- [ ] 用户角色和权限划分
- [ ] 数据导出格式要求
- [ ] 是否需要消息通知功能
- [ ] 是否需要离线使用能力

---

## 📎 附录

### A. 相关文档

- [API 接口文档](./miniprogram/docs/API.md)
- [数据类型定义](./miniprogram/models/types.ts)
- [Mock 数据](./miniprogram/models/mock-data.ts)

### B. 参考资料

- [微信云开发文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html)
- [TDesign 小程序组件库](https://tdesign.tencent.com/miniprogram/)
- [TDesign Vue Next](https://tdesign.tencent.com/vue-next/)

---

**文档结束**

> 本文档将随项目进展持续更新

