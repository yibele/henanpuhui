# æ™®æƒ å†œæˆ· CRM ç³»ç»Ÿæ¶æ„è®¾è®¡æ–‡æ¡£

> ç‰ˆæœ¬ï¼šv1.1  
> æ›´æ–°æ—¥æœŸï¼š2026-01-27  
> çŠ¶æ€ï¼šå·²æ›´æ–° (åŸºäºç°æœ‰ä»£ç é€»è¾‘)

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
2. [æŠ€æœ¯æ¶æ„](#2-æŠ€æœ¯æ¶æ„)
3. [ç³»ç»Ÿæ¨¡å—](#3-ç³»ç»Ÿæ¨¡å—)
4. [æ•°æ®åº“è®¾è®¡](#4-æ•°æ®åº“è®¾è®¡)
5. [äº‘å‡½æ•°è®¾è®¡](#5-äº‘å‡½æ•°è®¾è®¡)
6. [æ ¸å¿ƒä¸šåŠ¡æµç¨‹](#6-æ ¸å¿ƒä¸šåŠ¡æµç¨‹)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯
æ™®æƒ å†œæˆ· CRM ç³»ç»Ÿæ˜¯ä¸€ä¸ªé¢å‘å†œä¸šä¼ä¸šçš„å…¨æµç¨‹ç®¡ç†ç³»ç»Ÿã€‚å®ƒä»¥**å†œæˆ·**ä¸ºæ ¸å¿ƒï¼Œé€šè¿‡**èµ„é‡‘æµ**ï¼ˆå®šé‡‘ã€æ¬ æ¬¾ã€ç»“ç®—ï¼‰å’Œ**ç‰©èµ„æµ**ï¼ˆç§è‹—ã€åŒ–è‚¥ã€æ”¶è´­ä½œç‰©ï¼‰ä¸²è”èµ·â€œç­¾çº¦ -> å‘æ”¾ -> æŒ‡å¯¼ -> æ”¶è´­ -> ç»“ç®—â€çš„å®Œæ•´å†œä¸šç”Ÿäº§å‘¨æœŸã€‚

### 1.2 ç”¨æˆ·è§’è‰²

| è§’è‰² | ä»£ç  | èŒè´£ | æƒé™èŒƒå›´ |
|------|------|------|----------|
| **å¤–å‹¤/åŠ©ç†** | `assistant` | å†œæˆ·ç­¾çº¦ã€æ”¶å–å®šé‡‘ã€ç§è‹—å‘æ”¾ã€ç§æ¤æŒ‡å¯¼ | ä»…é™æŸ¥çœ‹å’Œæ“ä½œè‡ªå·±åä¸‹çš„å†œæˆ· (Private) |
| **ä»“åº“ç®¡ç†å‘˜** | `warehouse_manager` | å†œäº§å“æ”¶è´­ç™»è®°ã€å®šçº§ç§°é‡ã€åº“å­˜ç®¡ç† | ä»…é™æŸ¥çœ‹å’Œæ“ä½œæ‰€å±ä»“åº“çš„æ•°æ® (Warehouse Scope) |
| **è´¢åŠ¡/ç®¡ç†å±‚** | `finance_admin` | ç»“ç®—å•å®¡æ ¸ã€æ‰£æ¬¾è°ƒæ•´ã€æ”¯ä»˜æ‰“æ¬¾ã€ç»è¥æŠ¥è¡¨ | å…¨å±€æ•°æ®æŸ¥çœ‹ã€èµ„é‡‘æ“ä½œæƒé™ (Global) |
| **ç®¡ç†å‘˜** | `admin` | ç³»ç»Ÿé…ç½®ã€ç”¨æˆ·ç®¡ç†ã€æ•°æ®ä¿®æ­£ | æœ€é«˜æƒé™ (Root) |

---

## 2. æŠ€æœ¯æ¶æ„

### 2.1 æ•´ä½“æ¶æ„
é‡‡ç”¨ **å¾®ä¿¡å°ç¨‹åº + äº‘å¼€å‘ (Serverless)** æ¶æ„ã€‚
- **å‰ç«¯**ï¼šåŸç”Ÿå°ç¨‹åº (TypeScript) + TDesign ç»„ä»¶åº“ã€‚
- **åç«¯**ï¼šäº‘å‡½æ•° (Node.js) å¤„ç†ä¸šåŠ¡é€»è¾‘ã€‚
- **æ•°æ®åº“**ï¼šäº‘æ•°æ®åº“ (NoSQL) å­˜å‚¨æ–‡æ¡£å‹æ•°æ®ã€‚

### 2.2 æ ¸å¿ƒè®¾è®¡ç†å¿µ
1.  **æ•°æ®ä¸€è‡´æ€§**ï¼šé€šè¿‡äº‘å‡½æ•°å°è£…æ‰€æœ‰å†™æ“ä½œã€‚ä¾‹å¦‚ï¼Œåˆ›å»ºæ”¶è´­å•æ—¶ï¼Œè‡ªåŠ¨è§¦å‘ï¼š
    -   `acquisitions` è¡¨æ’å…¥è®°å½•
    -   `settlements` è¡¨è‡ªåŠ¨ç”Ÿæˆï¼ˆå¾…å®¡æ ¸çŠ¶æ€ï¼‰
    -   `farmers.stats` ç´¯åŠ æ”¶è´­é‡å’Œé‡‘é¢
    -   `warehouses.stats` ç´¯åŠ åº“å­˜å’Œä»Šæ—¥æ•°æ®
2.  **è½¯åˆ é™¤ä¸å›æ»š**ï¼šå…³é”®æ•°æ®ï¼ˆå¦‚æ”¶è´­å•ã€å‘è‹—è®°å½•ï¼‰åˆ é™¤æ—¶é‡‡ç”¨â€œè½¯åˆ é™¤â€ï¼Œå¹¶è‡ªåŠ¨å›æ»šå…³è”çš„ç»Ÿè®¡æ•°æ®ï¼ˆFarmer Stats / Warehouse Statsï¼‰ï¼Œç¡®ä¿æŠ¥è¡¨å‡†ç¡®ã€‚
3.  **è‡ªåŠ¨æŠµæ‰£æœºåˆ¶**ï¼šç»“ç®—æ—¶ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—ï¼š`åº”ä»˜ = æ”¶è´­æ€»é¢ - ç§è‹—æ¬ æ¬¾ - å†œèµ„æ¬ æ¬¾ - é¢„æ”¯æ¬¾`ã€‚

---

## 3. ç³»ç»Ÿæ¨¡å—

### 3.1 å†œæˆ·ç®¡ç† (Farmer CRM)
- **æ¡£æ¡ˆç®¡ç†**ï¼šå››çº§åœ°å€ï¼ˆå¿/ä¹¡/é•‡/æ‘ï¼‰ã€ç§æ¤é¢ç§¯ã€åˆåŒç…§ç‰‡ã€‚
- **ä¸šåŠ¡è®°å½• (Timeline)**ï¼šé€šè¿‡ `business_records` è¡¨è®°å½•è¯¥å†œæˆ·çš„æ‰€æœ‰äº¤äº’ï¼ˆè¿½åŠ ç­¾çº¦ã€å‘è‹—ã€æ”¶è´§ç­‰ï¼‰ï¼Œå½¢æˆæ—¶é—´è½´ã€‚
- **çŠ¶æ€è¿½è¸ª**ï¼šæœªå‘è‹— -> å‘è‹—ä¸­ -> å·²å‘è‹— -> å¾…æ”¶è´­ -> æ”¶è´­ä¸­ -> ç»“ç®—å®Œæˆã€‚

### 3.2 ç§è‹—ä¸ç‰©èµ„ (Inventory & Distribution)
- **å‘æ”¾ç™»è®°**ï¼šè®°å½•å‘ç»™è°ã€å‘å¤šå°‘ã€é‡‘é¢ã€‚
- **è‡ªåŠ¨è®°è´¦**ï¼šå‘æ”¾åŒæ—¶å¢åŠ å†œæˆ·çš„ `seedDebt` (ç§è‹—æ¬ æ¬¾)ã€‚
- **åº“å­˜è”åŠ¨**ï¼šå‘æ”¾åè‡ªåŠ¨æ‰£å‡ä»“åº“åº“å­˜ï¼ˆå¦‚æœ‰ï¼‰ã€‚

### 3.3 æ”¶è´­ç®¡ç† (Acquisition)
- **ç§°é‡å…¥åº“**ï¼šæ¯›é‡ã€çš®é‡ã€æ°´æ‚ç‡ -> å‡€é‡ã€‚
- **æ™ºèƒ½é£æ§**ï¼šç³»ç»Ÿæ ¹æ®äº©äº§é¢„ä¼°é‡é‡ï¼ˆå¦‚ 300kg/äº©ï¼‰ï¼Œè‹¥å®é™…æ”¶è´­é‡å·®å¼‚è¿‡å¤§ï¼ˆ>50%ï¼‰ï¼Œè‡ªåŠ¨æ ‡è®°ä¸º**å¼‚å¸¸ (Abnormal)**ï¼Œæç¤ºè´¢åŠ¡é‡ç‚¹å®¡æ ¸ã€‚
- **ç»“ç®—ç”Ÿæˆ**ï¼šæ”¶è´­å®Œæˆå³åˆ»ç”Ÿæˆå…³è”ç»“ç®—å•ã€‚

### 3.4 è´¢åŠ¡ç»“ç®— (Finance & Settlement)
- **å¤šçº§çŠ¶æ€**ï¼š`Pending` (å¾…å®¡æ ¸) -> `Approved` (å·²å®¡æ ¸/å¾…æ”¯ä»˜) -> `Paying` (æ”¯ä»˜ä¸­) -> `Completed` (å·²å®Œæˆ)ã€‚
- **è°ƒæ•´èƒ½åŠ›**ï¼šè´¢åŠ¡æ‹¥æœ‰ `recalculate` æƒé™ï¼Œå¯æ‰‹åŠ¨è°ƒæ•´å†œèµ„æ‰£æ¬¾ã€é¢„æ”¯æ¬¾ï¼Œå¹¶å¼ºåˆ¶ä¿®æ­£æœ€ç»ˆåº”ä»˜é‡‘é¢ï¼ˆç”¨äºå¤„ç†ç‰¹æ®Šåè´¦æˆ–å¥–åŠ±ï¼‰ã€‚
- **åˆ†æ‰¹æ”¯ä»˜**ï¼šæ”¯æŒæ ‡è®°æ”¯ä»˜çŠ¶æ€ï¼Œè®°å½•æ”¯ä»˜å‡­è¯ã€‚

---

## 4. æ•°æ®åº“è®¾è®¡

### 4.1 æ ¸å¿ƒé›†åˆ (Collections)

#### `farmers` - å†œæˆ·æ¡£æ¡ˆ
æ ¸å¿ƒèµ„äº§è¡¨ï¼Œå­˜å‚¨åŸºç¡€ä¿¡æ¯å’Œå®æ—¶ç»Ÿè®¡å¿«ç…§ã€‚
```javascript
{
  _id: "...",
  farmerId: "FAR_20260127_0001",
  name: "å¼ ä¸‰",
  phone: "13800138000",
  // å››çº§åœ°å€
  address: { county: "æ–°éƒ‘", township: "é¾™æ¹–", town: "...", village: "..." },
  acreage: 10.5,         // ç§æ¤é¢ç§¯
  grade: "gold",         // gold/silver/bronze
  
  // èµ„é‡‘ç›¸å…³
  deposit: 5000,         // å·²äº¤å®šé‡‘
  seedDebt: 3000,        // å½“å‰ç§è‹—æ¬ æ¬¾ï¼ˆåŠ¨æ€è®¡ç®—ï¼šå‘è‹—é¢ - å®šé‡‘ - å·²æŠµæ‰£ï¼‰
  agriculturalDebt: 0,   // å†œèµ„æ¬ æ¬¾
  advancePayment: 0,     // é¢„æ”¯æ¬¾é¡¹
  
  // å®æ—¶ç»Ÿè®¡ï¼ˆç”±äº‘å‡½æ•°ç»´æŠ¤ï¼Œå‹¿ç›´æ¥ä¿®æ”¹ï¼‰
  stats: {
    totalSeedDistributed: 500,  // ç´¯è®¡é¢†è‹—
    totalSeedAmount: 1500,      // ç´¯è®¡è‹—æ¬¾
    totalAcquisitionWeight: 0,  // ç´¯è®¡äº¤è´§
    totalPaidAmount: 0,         // ç´¯è®¡è·åˆ©
    currentDebt: 3000           // å½“å‰æ€»æ¬ æ¬¾
  },
  
  firstManager: "UserA", // å½’å±åŠ©ç†
  status: "active"
}
```

#### `seed_records` - ç§è‹—å‘æ”¾è®°å½•
```javascript
{
  recordId: "SEED_...",
  farmerId: "...",
  quantity: 100,      // æ•°é‡
  amount: 300,        // é‡‘é¢
  distributedArea: 5, // å¯¹åº”é¢ç§¯
  createBy: "UserA"   // æ“ä½œäºº
}
```

#### `acquisitions` - æ”¶è´­è®°å½•
```javascript
{
  acquisitionId: "ACQ_...",
  farmerId: "...",
  warehouseId: "WH_01",
  grossWeight: 5000,  // æ¯›é‡
  tareWeight: 200,    // çš®é‡
  netWeight: 4800,    // å‡€é‡
  unitPrice: 2.5,     // å•ä»·
  totalAmount: 12000, // æ€»é¢
  
  // é£æ§å­—æ®µ
  estimatedWeight: 4500, // é¢„ä¼°äº§é‡
  isAbnormal: false,     // æ˜¯å¦å¼‚å¸¸
  
  status: "confirmed" // confirmed / audit_rejected / deleted
}
```

#### `settlements` - ç»“ç®—å•
```javascript
{
  settlementId: "STL_...",
  acquisitionId: "ACQ_...",
  
  // é‡‘é¢è®¡ç®—
  grossAmount: 12000,      // æ”¶è´­é¢
  seedDebt: 3000,          // æŠµæ‰£ï¼šç§è‹—æ¬¾
  agriculturalDebt: 0,     // æŠµæ‰£ï¼šå†œèµ„
  advancePayment: 0,       // æŠµæ‰£ï¼šé¢„æ”¯
  actualPayment: 9000,     // å®ä»˜ = 12000 - 3000
  
  // è´¢åŠ¡è°ƒæ•´
  adjustedPayment: null,   // ä¼šè®¡äººå·¥è°ƒæ•´é¢ï¼ˆå¦‚æœ‰ï¼‰
  
  // çŠ¶æ€æµè½¬
  auditStatus: "pending",  // pending -> approved -> rejected
  paymentStatus: "unpaid", // unpaid -> paying -> paid
  
  paymentVoucher: "url",   // æ”¯ä»˜å‡­è¯
  createTime: Date
}
```

#### `business_records` - ä¸šåŠ¡æµæ°´
ç»Ÿä¸€è®°å½•å†œæˆ·çš„æ‰€æœ‰å…³é”®äº‹ä»¶ï¼ˆè¿½åŠ ã€å‘è‹—ã€æ”¶è´­ï¼‰ï¼Œç”¨äºæ—¶é—´è½´å±•ç¤ºã€‚

---

## 5. äº‘å‡½æ•°è®¾è®¡

| å‡½æ•°å | Action | åŠŸèƒ½è¯´æ˜ | å…³é”®é€»è¾‘ |
| :--- | :--- | :--- | :--- |
| **farmer-manage** | `create` | åˆ›å»ºå†œæˆ· | æ ¡éªŒæ‰‹æœº/èº«ä»½è¯å”¯ä¸€æ€§ |
| | `addendum` | è¿½åŠ ç­¾çº¦ | æ›´æ–°é¢ç§¯/å®šé‡‘ï¼Œå†™å…¥ business_records |
| | `getBusinessRecords`| è·å–æµæ°´ | æ—¶é—´è½´æ•°æ®æº |
| **seed-manage** | `distribute` | å‘è‹— | å¢åŠ  farmer.seedDebtï¼Œæ›´æ–° farmer.stats |
| | `delete` | åˆ é™¤è®°å½• | **è‡ªåŠ¨å›æ»š** farmer.stats ç»Ÿè®¡æ•°æ® |
| **acquisition-manage**| `create` | æ”¶è´­ç™»è®° | **è‡ªåŠ¨åˆ›å»ºç»“ç®—å•**ï¼Œè§¦å‘é£æ§æ£€æµ‹ï¼Œæ›´æ–° warehouse.stats |
| | `update` | ä¿®æ­£è®°å½• | ä»…é™å®¡æ ¸é©³å›åä½¿ç”¨ï¼ŒåŒæ­¥æ›´æ–°ç»“ç®—é‡‘é¢ |
| | `delete` | åˆ é™¤è®°å½• | ä»…é™è´¢åŠ¡/ç®¡ç†å‘˜ï¼Œ**å›æ»š**æ‰€æœ‰å…³è”ç»Ÿè®¡ |
| **settlement-manage** | `audit` | å®¡æ ¸ | è´¢åŠ¡ç¡®è®¤é‡‘é¢æ— è¯¯ï¼Œé€šçŸ¥ä»“ç®¡ |
| | `recalculate` | **é‡ç®—** | è´¢åŠ¡è°ƒæ•´æ‰£æ¬¾é¡¹ï¼ˆå†œèµ„/é¢„æ”¯ï¼‰ï¼Œæ›´æ–°å®ä»˜é‡‘é¢ |
| | `markPayment` | æ ‡è®°æ”¯ä»˜ | çŠ¶æ€æ”¹ä¸º paying |
| | `completePayment` | å®Œæˆæ”¯ä»˜ | çŠ¶æ€æ”¹ä¸º paidï¼Œæ‰£é™¤å†œæˆ·æ¬ æ¬¾ï¼Œè®°å½•å‡­è¯ |
| **user-manage** | `login` | ç™»å½• | èº«ä»½æ ¡éªŒï¼Œè¿”å›è§’è‰²æƒé™ |

---

## 6. æ ¸å¿ƒä¸šåŠ¡æµç¨‹

### 6.1 æ”¶è´­ä¸ç»“ç®—é—­ç¯
1.  **ä»“ç®¡**å½•å…¥æ”¶è´­å• -> ç³»ç»Ÿç”Ÿæˆ `acquisitions` å’Œ `settlements`ã€‚
2.  **ç³»ç»Ÿ**è®¡ç®— `NetWeight` å’Œ `TotalAmount`ï¼Œå¹¶æ‹‰å–å½“å‰ `Farmer.SeedDebt` å¡«å…¥ç»“ç®—å•ã€‚
3.  **è´¢åŠ¡**åœ¨åå°çœ‹åˆ° "å¾…å®¡æ ¸" ç»“ç®—å•ã€‚
    *   *åœºæ™¯A (æ­£å¸¸)*ï¼šæ ¸å¯¹æ— è¯¯ -> ç‚¹å‡» `Audit Pass`ã€‚
    *   *åœºæ™¯B (è°ƒæ•´)*ï¼šå‘ç°å†œæˆ·è¿˜æœ‰ç¬”å†œèµ„æ¬¾æ²¡å½•ç³»ç»Ÿ -> ç‚¹å‡» `Recalculate` -> è¾“å…¥ `AgriculturalDebt` -> ç³»ç»Ÿæ›´æ–° `ActualPayment` -> ç‚¹å‡» `Audit Pass`ã€‚
4.  **å‡ºçº³**çœ‹åˆ° "å¾…æ”¯ä»˜" åˆ—è¡¨ -> çº¿ä¸‹æ‰“æ¬¾ -> ä¸Šä¼ å‡­è¯ -> ç‚¹å‡» `Complete Payment`ã€‚
5.  **ç³»ç»Ÿ**æ›´æ–° `settlement.status = completed`ï¼Œå¹¶ä» `Farmer.SeedDebt` ä¸­æ­£å¼æ‰£é™¤ç›¸åº”é‡‘é¢ï¼Œäº¤æ˜“ç»“æŸã€‚