# 前端对接云函数指南

## ✅ 已完成的对接

### 1. 登录功能
- **文件**: `miniprogram/pages/login/index.ts`
- **云函数**: `user-manage`
- **状态**: ✅ 已完成

### 2. 首页数据展示
- **文件**: `miniprogram/pages/index/index.ts`
- **云函数**: `dashboard-stats`
- **功能**:
  - ✅ 助理首页：显示我录入的农户统计
  - ✅ 仓管首页：显示仓库今日和累计数据
- **状态**: ✅ 已完成

### 3. 农户录入
- **文件**: `miniprogram/pages/farmers/add/index.ts`
- **云函数**: `farmer-manage`
- **功能**: ✅ 创建新农户
- **状态**: ✅ 已完成

### 4. 收购登记
- **文件**: `miniprogram/pages/operations/buy-add/index.ts`
- **云函数**: `acquisition-manage`
- **功能**: ✅ 创建收购记录，自动生成结算单
- **状态**: ✅ 已完成

---

## 📋 需要手动部署的云函数

### **新增云函数：dashboard-stats**

这是新创建的首页统计数据云函数，需要部署到云端。

#### 部署步骤：

1. **在微信开发者工具中**：
   - 右键点击 `cloudfunctions/dashboard-stats` 文件夹
   - 选择 **"上传并部署：云端安装依赖"**
   - 等待部署完成（约30秒）

2. **验证部署**：
   - 在云开发控制台 → 云函数
   - 查看 `dashboard-stats` 是否显示为 **"已部署"**

---

## 🧪 测试流程

### **1. 测试登录**
- 打开小程序 → 点击"微信登录"
- 应该能成功登录（前提：已在 `users` 集合中添加了你的用户）

### **2. 测试首页数据**

#### **助理角色**：
1. 登录后，首页应显示：
   - 我录入的农户数
   - 总面积
   - 总应收款
   - 最近录入的3个农户

#### **仓管角色**：
1. 登录后，首页应显示：
   - 仓库名称和信息
   - 今日收购数据（数量、金额、农户数）
   - 累计收购数据
   - 库存状态

### **3. 测试农户录入**
1. 助理登录 → 点击"录入农户"
2. 填写农户信息：
   - 基本信息（姓名、手机、身份证）
   - 种植地址（县/区、乡镇、村）
   - 种植面积
   - 签约信息（种苗合计、单价、欠款）
   - 第一负责人、第二负责人
3. 点击"提交"
4. 应该提示"签约成功"，返回上一页
5. **验证**：在云开发控制台 → 数据库 → `farmers` 集合，查看是否有新记录

### **4. 测试收购登记**
1. 仓管登录 → 点击"收购登记"
2. 填写收购信息：
   - 选择农户
   - 输入重量数据（手重、皮重、水杂率）
   - 输入单价
   - 系统自动计算净重和金额
3. 点击"确认收购"
4. 应该提示"收购登记成功"，返回上一页
5. **验证**：
   - 在 `acquisitions` 集合，查看是否有新记录
   - 在 `settlements` 集合，查看是否自动生成了结算单

---

## ⚠️ 常见问题

### 问题1：首页显示"加载数据失败"
**原因**：`dashboard-stats` 云函数未部署
**解决**：按照上面的步骤部署 `dashboard-stats` 云函数

### 问题2：农户录入提示"创建失败"
**可能原因**：
- 手机号或身份证重复
- `farmers` 集合索引未创建
**解决**：
- 检查数据库中是否已有相同手机号/身份证的农户
- 确认已创建唯一索引（见 `docs/部署指南.md` 第3步）

### 问题3：收购登记提示"收购登记失败"
**可能原因**：
- 选择的农户不存在
- 仓库ID不正确
**解决**：
- 确保先录入了农户
- 确保用户的 `warehouseId` 正确绑定

### 问题4：控制台报错 "database collection not exists"
**原因**：数据库集合未创建或未初始化
**解决**：
1. 确保已创建所有9个数据库集合
2. 运行 `database-init` 云函数初始化仓库数据

---

## 🔜 待对接的功能

以下功能暂时使用 Mock 数据，后续需要对接云函数：

### 1. 农户列表页
- **文件**: `miniprogram/pages/farmers/list/index.ts`
- **需要对接**: `farmer-manage` (action: 'list')

### 2. 农户详情页
- **文件**: `miniprogram/pages/farmers/detail/index.ts`
- **需要对接**: `farmer-manage` (action: 'get')

### 3. 发苗登记
- **文件**: `miniprogram/pages/operations/seed-add/index.ts`
- **需要对接**: 待创建 `seed-manage` 云函数

### 4. 财务管理（结算审核、支付）
- **文件**: `miniprogram/pages/finance/index/index.ts`
- **需要对接**: `settlement-manage` (action: 'audit', 'markPayment', 'completePayment')

### 5. 管理层首页（全部统计数据）
- **文件**: `miniprogram/pages/index/index.ts` (loadManagerData 方法)
- **需要对接**: `dashboard-stats` (action: 'getFinanceStats')

---

## 📝 下一步计划

1. **测试核心业务流程**：
   - 助理录入农户 → 仓管收购 → 财务审核 → 财务支付

2. **完善数据展示**：
   - 对接农户列表页
   - 对接收购记录列表页
   - 对接结算单列表页

3. **添加更多用户**：
   - 在 `users` 集合中添加助理、仓管、财务用户
   - 为仓管用户绑定对应的 `warehouseId`

4. **优化用户体验**：
   - 添加下拉刷新
   - 添加分页加载
   - 优化加载动画

---

**有任何问题，随时联系！** 🚀
