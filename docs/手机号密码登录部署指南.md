# 手机号+密码登录 - 部署指南

## ✅ 已完成的修改

### 1. 云函数修改
- ✅ `cloudfunctions/user-manage/index.js` - 改为手机号+密码验证
- ✅ `cloudfunctions/database-init/index.js` - 添加4个测试账号初始化

### 2. 前端修改
- ✅ `miniprogram/pages/login/index.wxml` - 改为手机号+密码输入框
- ✅ `miniprogram/pages/login/index.ts` - 改为手机号+密码登录逻辑
- ✅ `miniprogram/pages/login/index.wxss` - 添加密码眼睛和测试账号提示样式

---

## 📋 预设的4个测试账号

| 角色 | 姓名 | 手机号 | 密码 | 权限 |
|------|------|--------|------|------|
| 助理 | 张助理 | 13800001111 | 123456 | 录入农户、发苗登记 |
| 仓管 | 李仓管 | 13800002222 | 123456 | 收购登记（绑定"梁寨"仓库）|
| 财务 | 王财务 | 13800003333 | 123456 | 审核结算、支付 |
| 管理员 | 赵管理员 | 13900000000 | admin123 | 全部权限 |

---

## 🚀 部署步骤

### **第1步：重新上传 user-manage 云函数**

1. 在微信开发者工具中
2. 右键点击 `cloudfunctions/user-manage` 文件夹
3. 选择 **"上传并部署：云端安装依赖"**
4. 等待部署完成

### **第2步：重新运行 database-init 云函数**

1. 右键点击 `cloudfunctions/database-init` 文件夹
2. 选择 **"云函数测试"**
3. 点击 **"调用"** 按钮
4. 查看日志，应该看到：
   ```
   ✅ 用户 张助理 (13800001111) 初始化成功
   ✅ 用户 李仓管 (13800002222) 初始化成功
   ✅ 用户 王财务 (13800003333) 初始化成功
   ✅ 用户 赵管理员 (13900000000) 初始化成功
   ```

### **第3步：验证用户数据**

1. 打开 **云开发控制台** → **数据库** → **`users`** 集合
2. 应该看到4条用户记录
3. 每条记录包含：`name`, `phone`, `password`, `role`, `status` 等字段

### **第4步：测试登录**

1. **刷新小程序**（点击开发者工具的"编译"按钮）
2. 登录页面现在显示：
   - 手机号输入框
   - 密码输入框（带眼睛图标）
   - 测试账号提示
3. **测试助理登录**：
   - 手机号：13800001111
   - 密码：123456
   - 点击"登录系统"
   - 应该跳转到首页，显示助理视图
4. **测试仓管登录**：
   - 手机号：13800002222
   - 密码：123456
   - 应该跳转到首页，显示仓管视图（梁寨仓库）

---

## 🎯 登录后的效果

### **助理角色（13800001111）**：
- 首页显示：我录入的农户统计
- 可访问：录入农户、发苗登记、我的农户列表

### **仓管角色（13800002222）**：
- 首页显示：梁寨仓库的今日和累计数据
- 可访问：收购登记、库存管理、收购记录

### **财务角色（13800003333）**：
- 首页显示：待审核结算单、待支付金额、全部统计
- 可访问：结算审核、支付管理、财务报表

### **管理员角色（13900000000）**：
- 全部权限

---

## 🔧 如何添加新用户？

### **方法1：在云开发控制台手动添加**

1. 打开 **云开发控制台** → **数据库** → **`users`** 集合
2. 点击 **"添加记录"**
3. 输入以下内容（根据角色调整）：

```json
{
  "name": "新用户姓名",
  "phone": "13800004444",
  "password": "123456",
  "role": "assistant",
  "avatar": "",
  "nickName": "",
  "warehouseId": "",
  "warehouseName": "",
  "status": "active",
  "createTime": {
    "$date": "2026-01-16T16:00:00.000Z"
  },
  "updateTime": {
    "$date": "2026-01-16T16:00:00.000Z"
  }
}
```

4. 点击"确定"保存

**注意**：
- `role` 可选值：`assistant`（助理）、`warehouse_manager`（仓管）、`finance_admin`（财务）、`admin`（管理员）
- 如果是仓管，需要填写 `warehouseId`（从 `warehouses` 集合复制仓库的 `_id`）

### **方法2：通过云函数批量添加**

如果需要添加多个用户，可以修改 `database-init/index.js`，添加更多用户到 `TEST_USERS` 数组，然后重新运行云函数。

---

## ⚠️ 安全说明

### **当前方案（开发/测试环境）**：
- ✅ 简单直接，方便测试
- ⚠️ 密码明文存储（不推荐生产环境）
- ⚠️ 无验证码、无锁定机制

### **生产环境建议**：
1. **密码加密**：使用 bcrypt 或其他加密算法
2. **登录限制**：添加登录次数限制，防止暴力破解
3. **验证码**：添加图形验证码或短信验证码
4. **Token管理**：使用 JWT Token 进行会话管理
5. **审计日志**：记录所有登录尝试

---

## 🧪 测试检查清单

- [ ] database-init 云函数运行成功，4个用户已创建
- [ ] user-manage 云函数重新部署成功
- [ ] 登录页面显示手机号+密码输入框
- [ ] 登录页面显示测试账号提示
- [ ] 使用 13800001111/123456 可以成功登录（助理）
- [ ] 使用 13800002222/123456 可以成功登录（仓管）
- [ ] 使用 13800003333/123456 可以成功登录（财务）
- [ ] 使用 13900000000/admin123 可以成功登录（管理员）
- [ ] 登录后首页显示对应角色的数据
- [ ] 输入错误密码会提示"密码错误"
- [ ] 输入不存在的手机号会提示"手机号不存在"

---

## 💡 下一步

完成登录系统后，可以继续：

1. **测试核心业务流程**：
   - 助理登录 → 录入农户
   - 仓管登录 → 收购登记
   - 财务登录 → 审核结算 → 支付

2. **对接更多页面**：
   - 农户列表页
   - 收购记录列表页
   - 结算单列表页

3. **优化用户体验**：
   - 记住上次登录的手机号
   - 添加退出登录功能
   - 添加修改密码功能

---

**现在开始部署吧！按照上面的步骤一步步来！** 🚀
