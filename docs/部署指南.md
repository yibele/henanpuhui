# 普惠农录 - 详细部署指南

> 云环境ID：`cloud1-5g8kf9072047ce03`

---

## 📋 部署前检查清单

在开始部署之前，请确认：

- ✅ 已安装**微信开发者工具**（最新版本）
- ✅ 已开通**云开发**（环境ID：`cloud1-5g8kf9072047ce03`）
- ✅ 云开发环境状态为**正常**
- ✅ 项目代码已下载到本地
- ✅ 已在 `miniprogram/app.ts` 中配置了云环境ID

---

## 🚀 第一步：部署云函数

### 1.1 打开项目

1. 打开**微信开发者工具**
2. 选择**导入项目**
3. 选择项目目录：`henanpuhui`
4. 填写 AppID（测试号或正式 AppID）
5. 点击**确定**

### 1.2 部署 database-init（数据库初始化）

**作用**：创建8个仓库数据、管理员账号

**步骤**：

1. 在微信开发者工具左侧，展开 `cloudfunctions` 文件夹

2. 找到 `database-init` 文件夹

3. **右键点击** `database-init`

4. 选择 **"上传并部署：云端安装依赖"**

5. 等待部署完成（约30秒-1分钟）

6. 看到 ✅ **"上传成功"** 提示

**验证部署：**

1. 点击工具栏的 **"云开发"** 按钮

2. 进入云开发控制台

3. 左侧菜单 → **"云函数"**

4. 看到 `database-init` 函数，状态为**正常**

---

### 1.3 部署 user-manage（用户管理）

**作用**：用户登录、获取用户信息

**步骤**：

1. **右键点击** `cloudfunctions/user-manage`

2. 选择 **"上传并部署：云端安装依赖"**

3. 等待部署完成

4. 看到 ✅ **"上传成功"**

---

### 1.4 部署 farmer-manage（农户管理）

**作用**：创建、查询、修改农户信息

**步骤**：

1. **右键点击** `cloudfunctions/farmer-manage`

2. 选择 **"上传并部署：云端安装依赖"**

3. 等待部署完成

4. 看到 ✅ **"上传成功"**

---

### 1.5 部署 acquisition-manage（收购管理）

**作用**：创建收购记录、自动生成结算单

**步骤**：

1. **右键点击** `cloudfunctions/acquisition-manage`

2. 选择 **"上传并部署：云端安装依赖"**

3. 等待部署完成

4. 看到 ✅ **"上传成功"**

---

### 1.6 部署 settlement-manage（结算管理）

**作用**：审核结算单、支付款项

**步骤**：

1. **右键点击** `cloudfunctions/settlement-manage`

2. 选择 **"上传并部署：云端安装依赖"**

3. 等待部署完成

4. 看到 ✅ **"上传成功"**

---

### 1.7 验证所有云函数已部署

1. 点击工具栏的 **"云开发"** 按钮

2. 左侧菜单 → **"云函数"**

3. 确认以下5个云函数都显示为**正常**状态：
   - ✅ database-init
   - ✅ user-manage
   - ✅ farmer-manage
   - ✅ acquisition-manage
   - ✅ settlement-manage

---

## 🗄️ 第二步：初始化数据库

### 2.1 运行数据库初始化脚本

**作用**：
- 创建8个仓库（梁寨、沙竹王、郭营、沙堰、青华、赵楼、彭桥、九龙）
- 创建一个系统管理员账号

**步骤**：

1. 在微信开发者工具中，**右键点击** `cloudfunctions/database-init`

2. 选择 **"云函数测试"**

3. 在弹出的窗口中，点击 **"调用"** 按钮

4. 查看日志输出，应该看到：

```
========================================
普惠农录 - 数据库初始化开始
========================================
开始初始化仓库数据...
✅ 仓库 梁寨 初始化成功
✅ 仓库 沙竹王 初始化成功
✅ 仓库 郭营 初始化成功
✅ 仓库 沙堰 初始化成功
✅ 仓库 青华 初始化成功
✅ 仓库 赵楼 初始化成功
✅ 仓库 彭桥 初始化成功
✅ 仓库 九龙 初始化成功
仓库数据初始化完成！
========================================
数据库初始化完成！
========================================
```

5. 如果看到以上日志，说明初始化成功 ✅

---

### 2.2 验证数据库集合已创建

1. 在云开发控制台，左侧菜单 → **"数据库"**

2. 确认以下集合已创建（如果没有，点击"添加集合"手动创建）：

| 集合名称 | 说明 |
|---------|------|
| ✅ warehouses | 仓库表（应该有8条记录） |
| users | 用户表（暂时为空，稍后手动添加） |
| farmers | 农户档案表（暂时为空） |
| seed_records | 种苗发放记录表（暂时为空） |
| acquisitions | 收购记录表（暂时为空） |
| settlements | 结算单表（暂时为空） |
| planting_guidance | 种植指导记录表（暂时为空） |
| notifications | 消息通知表（暂时为空） |
| operation_logs | 操作日志表（暂时为空） |

3. 点击 `warehouses` 集合，确认有**8条记录**（8个仓库）

---

### 2.3 创建数据库索引（重要！）

**为什么要创建索引？**
索引可以大幅提升查询性能，特别是在数据量大的时候。

**操作步骤**：

#### **为 users 集合创建索引**

1. 在数据库页面，点击 **`users`** 集合

2. 点击上方的 **"索引管理"** 标签

3. 点击 **"添加索引"**

4. 填写以下信息：

**索引1：phone（手机号）**
```
索引名称：phone_index
索引字段：phone
排序：升序
唯一索引：否
```

**索引2：role（角色）**
```
索引名称：role_index
索引字段：role
排序：升序
唯一索引：否
```

5. 点击**确定**

---

#### **为 farmers 集合创建索引**

1. 点击 **`farmers`** 集合

2. 点击 **"索引管理"**

3. 添加以下索引：

**索引1：farmerId（唯一）**
```
索引名称：farmerId_unique
索引字段：farmerId
排序：升序
唯一索引：是 ✅
```

**索引2：idCard（身份证号，唯一）**
```
索引名称：idCard_unique
索引字段：idCard
排序：升序
唯一索引：是 ✅
```

**索引3：firstManagerId（负责人）**
```
索引名称：firstManagerId_index
索引字段：firstManagerId
排序：升序
唯一索引：否
```

---

#### **为 acquisitions 集合创建索引**

1. 点击 **`acquisitions`** 集合

2. 点击 **"索引管理"**

3. 添加以下索引：

**索引1：acquisitionId（唯一）**
```
索引名称：acquisitionId_unique
索引字段：acquisitionId
排序：升序
唯一索引：是 ✅
```

**索引2：farmerId（农户）**
```
索引名称：farmerId_index
索引字段：farmerId
排序：升序
唯一索引：否
```

**索引3：warehouseId（仓库）**
```
索引名称：warehouseId_index
索引字段：warehouseId
排序：升序
唯一索引：否
```

---

#### **为 settlements 集合创建索引**

1. 点击 **`settlements`** 集合

2. 点击 **"索引管理"**

3. 添加以下索引：

**索引1：settlementId（唯一）**
```
索引名称：settlementId_unique
索引字段：settlementId
排序：升序
唯一索引：是 ✅
```

**索引2：acquisitionId（唯一）**
```
索引名称：acquisitionId_unique
索引字段：acquisitionId
排序：升序
唯一索引：是 ✅
```

**索引3：auditStatus（审核状态）**
```
索引名称：auditStatus_index
索引字段：auditStatus
排序：升序
唯一索引：否
```

---

**索引创建完成！** ✅

---

## 👤 第三步：添加第一个用户（你自己）

### 3.1 添加管理员账号

1. 在云开发控制台 → 数据库 → 点击 **`users`** 集合

2. 点击右上角的 **"添加记录"** 按钮

3. 在编辑器中输入以下内容（**请修改姓名和手机号为你自己的**）：

```json
{
  "name": "张三",
  "phone": "13800138888",
  "avatar": "",
  "nickName": "",
  "role": "admin",
  "warehouseId": "",
  "warehouseName": "",
  "status": "active",
  "createTime": {
    "$date": "2026-01-16T12:00:00.000Z"
  },
  "updateTime": {
    "$date": "2026-01-16T12:00:00.000Z"
  },
  "lastLoginTime": null
}
```

**字段说明：**
- `name`：你的姓名
- `phone`：你的手机号（可以随便填，用于标识）
- `role`：`admin`（管理员，拥有所有权限）
- `status`：`active`（激活状态）

4. 点击 **"确定"** 保存

5. 确认记录已创建成功 ✅

---

### 3.2 添加其他用户

参考 `docs/如何添加用户.md`，添加助理、仓管、财务等其他用户。

**示例**：

**添加助理：**
```json
{
  "name": "李助理",
  "phone": "13800138001",
  "avatar": "",
  "nickName": "",
  "role": "assistant",
  "warehouseId": "",
  "warehouseName": "",
  "status": "active",
  "createTime": {
    "$date": "2026-01-16T12:00:00.000Z"
  },
  "updateTime": {
    "$date": "2026-01-16T12:00:00.000Z"
  },
  "lastLoginTime": null
}
```

**添加仓管（梁寨仓库）：**
```json
{
  "name": "梁寨-王仓管",
  "phone": "13800138002",
  "avatar": "",
  "nickName": "",
  "role": "warehouse",
  "warehouseId": "WH_LZ",
  "warehouseName": "梁寨",
  "status": "active",
  "createTime": {
    "$date": "2026-01-16T12:00:00.000Z"
  },
  "updateTime": {
    "$date": "2026-01-16T12:00:00.000Z"
  },
  "lastLoginTime": null
}
```

---

## 📱 第四步：测试登录

### 4.1 编译小程序

1. 在微信开发者工具中，点击顶部的 **"编译"** 按钮

2. 等待编译完成

3. 查看控制台，确认没有报错

4. 应该看到日志：
```
云开发初始化成功
```

---

### 4.2 测试登录

1. 在模拟器中，小程序应该自动打开**登录页面**

2. 点击 **"微信登录"** 按钮

3. 可能会提示需要真机调试（因为模拟器无法获取真实的 openid）

**两种测试方式：**

#### **方式1：真机调试（推荐）**

1. 点击工具栏的 **"真机调试"**

2. 用手机微信扫码

3. 手机上打开小程序

4. 点击 **"微信登录"**

5. 如果你的微信账号对应的 openid 在数据库中有记录，登录成功 ✅

6. 如果提示"无权限"，说明你的 openid 还没有绑定

#### **方式2：手动绑定 openid（用于测试）**

1. 在真机调试模式下，点击登录

2. 即使提示"无权限"，也查看控制台日志

3. 找到类似这样的日志：
```
openid: oXXXX-xxxxxxxxxxxxxxxxx
```

4. 复制这个 openid

5. 回到云开发控制台 → 数据库 → `users` 集合

6. 找到你刚才添加的管理员记录，点击 **"编辑"**

7. 添加 `_openid` 字段：
```json
{
  "_openid": "oXXXX-xxxxxxxxxxxxxxxxx",  // 粘贴你刚才复制的 openid
  "name": "张三",
  ...其他字段
}
```

8. 点击 **"确定"** 保存

9. 重新点击登录，应该登录成功 ✅

---

### 4.3 验证登录成功

登录成功后，应该：

1. 看到 Toast 提示："登录成功，管理员" ✅

2. 自动跳转到**首页**

3. 首页显示用户角色对应的界面：
   - 管理员：看到完整的数据看板
   - 助理：看到"我录入的农户"
   - 仓管：看到仓库数据
   - 财务：看到待审核列表

---

## ✅ 部署完成检查清单

请确认以下所有项都已完成：

### 云函数部署

- ✅ database-init（已部署并执行）
- ✅ user-manage（已部署）
- ✅ farmer-manage（已部署）
- ✅ acquisition-manage（已部署）
- ✅ settlement-manage（已部署）

### 数据库

- ✅ 9个集合已创建
- ✅ warehouses 集合有8条记录（8个仓库）
- ✅ users 集合有至少1条记录（你自己）
- ✅ 已创建数据库索引（users、farmers、acquisitions、settlements）

### 小程序

- ✅ app.ts 中已配置云环境ID
- ✅ 编译成功，无报错
- ✅ 登录功能正常
- ✅ 可以跳转到首页

---

## 🎉 恭喜！部署完成！

现在你的系统已经可以正常使用了！

---

## 🔄 后续步骤

### 1. 添加更多用户

参考 `docs/如何添加用户.md`，添加你们公司的其他员工。

### 2. 对接前端页面

目前大部分页面还在使用 Mock 数据，需要对接云函数：
- 农户添加页面
- 收购登记页面
- 财务审核页面

### 3. 测试完整业务流程

```
助理添加农户 → 仓管收购登记 → 财务审核结算 → 财务支付款项
```

---

## ❓ 遇到问题？

### 问题1：云函数部署失败

**可能原因**：
- 网络问题
- 云环境配额不足
- 云函数代码有语法错误

**解决方法**：
1. 检查网络连接
2. 查看云函数日志
3. 重新部署

---

### 问题2：登录时提示"无权限"

**可能原因**：
- 数据库中没有该用户记录
- 用户的 openid 未绑定
- 用户状态不是 `active`

**解决方法**：
1. 检查 `users` 集合是否有记录
2. 手动绑定 openid（参考上面的步骤）
3. 确认 `status` 字段为 `active`

---

### 问题3：编译时报错"找不到模块"

**可能原因**：
- node_modules 未安装

**解决方法**：
```bash
cd miniprogram
npm install
```

---

## 📞 技术支持

如有其他问题，请查阅：
- `cloudfunctions/README.md` - 云函数使用文档
- `docs/如何添加用户.md` - 用户管理文档
- 微信开发者文档：https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html

---

**祝使用愉快！** 🎉
