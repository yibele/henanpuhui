# 如何在云开发控制台添加用户

> **适用场景**：公司内部系统，用户数量不多（<50人），管理员手动添加用户

---

## 📋 准备工作

在添加用户之前，你需要知道：
1. **用户的微信 openid**（首次添加时可以留空，用户首次登录后会自动绑定）
2. **用户的姓名**
3. **用户的手机号**
4. **用户的角色**：
   - `assistant` - 助理（负责农户录入、种苗发放）
   - `warehouse` - 仓库管理员（负责收购登记）
   - `finance` - 财务（负责结算审核、支付）
   - `admin` - 管理员（系统管理，拥有所有权限）
5. **如果是仓库管理员**，还需要知道仓库ID和仓库名称

---

## 🚀 方式一：首次添加（推荐新手）

### 步骤1：打开云开发控制台

1. 打开**微信开发者工具**
2. 打开你的小程序项目
3. 点击工具栏上的 **"云开发"** 按钮

![打开云开发](https://example.com/open-cloud.png)

4. 进入云开发控制台

---

### 步骤2：进入数据库管理

1. 在左侧菜单中，点击 **"数据库"**
2. 在数据库列表中，找到并点击 **`users`** 集合

如果没有 `users` 集合，请先运行数据库初始化脚本（参考 `cloudfunctions/README.md`）

---

### 步骤3：添加用户记录

1. 点击右上角的 **"添加记录"** 按钮

2. 在弹出的编辑器中，输入以下内容（**注意格式**）：

#### **添加助理：**

```json
{
  "name": "张三",
  "phone": "13800138001",
  "avatar": "",
  "nickName": "",
  "role": "assistant",
  "warehouseId": "",
  "warehouseName": "",
  "status": "active",
  "createTime": {
    "$date": "2026-01-16T12:00:00.000Z"
  },
  "updateTime": {
    "$date": "2026-01-16T12:00:00.000Z"
  },
  "lastLoginTime": null
}
```

#### **添加仓库管理员：**

```json
{
  "name": "李四",
  "phone": "13800138002",
  "avatar": "",
  "nickName": "",
  "role": "warehouse",
  "warehouseId": "WH_LZ",
  "warehouseName": "梁寨",
  "status": "active",
  "createTime": {
    "$date": "2026-01-16T12:00:00.000Z"
  },
  "updateTime": {
    "$date": "2026-01-16T12:00:00.000Z"
  },
  "lastLoginTime": null
}
```

**仓库ID对照表：**
| 仓库名称 | 仓库ID |
|---------|--------|
| 梁寨 | WH_LZ |
| 沙竹王 | WH_SZW |
| 郭营 | WH_GY |
| 沙堰 | WH_SY |
| 青华 | WH_QH |
| 赵楼 | WH_ZL |
| 彭桥 | WH_PQ |
| 九龙 | WH_JL |

#### **添加财务：**

```json
{
  "name": "王五",
  "phone": "13800138003",
  "avatar": "",
  "nickName": "",
  "role": "finance",
  "warehouseId": "",
  "warehouseName": "",
  "status": "active",
  "createTime": {
    "$date": "2026-01-16T12:00:00.000Z"
  },
  "updateTime": {
    "$date": "2026-01-16T12:00:00.000Z"
  },
  "lastLoginTime": null
}
```

#### **添加管理员：**

```json
{
  "name": "赵六",
  "phone": "13800138888",
  "avatar": "",
  "nickName": "",
  "role": "admin",
  "warehouseId": "",
  "warehouseName": "",
  "status": "active",
  "createTime": {
    "$date": "2026-01-16T12:00:00.000Z"
  },
  "updateTime": {
    "$date": "2026-01-16T12:00:00.000Z"
  },
  "lastLoginTime": null
}
```

3. 点击 **"确定"** 保存

4. **重要**：保存后，记录会自动生成 `_id` 字段，这是用户的唯一标识。

---

### 步骤4：用户首次登录

1. 用户打开小程序
2. 进入登录页面
3. 点击 **"微信登录"** 按钮
4. 授权后，系统会自动将用户的 `openid` 绑定到该用户记录

**首次登录后**，你可以在数据库中看到该用户的 `_openid` 字段已经自动填充。

---

## 🔧 方式二：批量添加（适合批量导入）

如果需要添加很多用户，可以使用批量导入功能：

### 步骤1：准备 CSV 文件

创建一个 Excel 文件，按照以下格式填写：

| name | phone | role | warehouseId | warehouseName | status |
|------|-------|------|-------------|---------------|--------|
| 张三 | 13800138001 | assistant | | | active |
| 李四 | 13800138002 | warehouse | WH_LZ | 梁寨 | active |
| 王五 | 13800138003 | finance | | | active |

然后另存为 CSV 格式。

### 步骤2：导入数据

1. 在云开发控制台 → 数据库 → `users` 集合
2. 点击右上角的 **"导入"** 按钮
3. 选择你的 CSV 文件
4. 点击 **"确定"** 导入

**注意**：导入后需要手动补充 `createTime`、`updateTime` 等字段。

---

## ✏️ 如何修改用户信息

### 修改用户角色

1. 在 `users` 集合中找到该用户
2. 点击记录右侧的 **"编辑"** 按钮
3. 修改 `role` 字段：
   - `assistant` - 助理
   - `warehouse` - 仓库管理员
   - `finance` - 财务
   - `admin` - 管理员
4. 如果改为仓库管理员，还需要填写 `warehouseId` 和 `warehouseName`
5. 点击 **"确定"** 保存

### 修改仓库绑定（仓管调岗）

1. 在 `users` 集合中找到该用户
2. 点击记录右侧的 **"编辑"** 按钮
3. 修改 `warehouseId` 和 `warehouseName` 字段
4. 点击 **"确定"** 保存

### 停用用户

1. 在 `users` 集合中找到该用户
2. 点击记录右侧的 **"编辑"** 按钮
3. 将 `status` 字段改为 `inactive`
4. 点击 **"确定"** 保存

用户被停用后，将无法登录系统。

---

## 🗑️ 如何删除用户

### 软删除（推荐）

将用户状态改为 `inactive` 或 `deleted`，而不是真正删除记录。

1. 在 `users` 集合中找到该用户
2. 点击记录右侧的 **"编辑"** 按钮
3. 将 `status` 字段改为 `deleted`
4. 点击 **"确定"** 保存

### 硬删除（不推荐）

⚠️ **警告**：删除后无法恢复，且会影响关联数据（如操作日志）。

1. 在 `users` 集合中找到该用户
2. 点击记录右侧的 **"删除"** 按钮
3. 确认删除

---

## 🔍 如何查找用户

### 按姓名查找

1. 在 `users` 集合页面，点击右上角的 **"查询"** 按钮
2. 输入查询条件：
```json
{
  "name": "张三"
}
```
3. 点击 **"查询"**

### 按手机号查找

```json
{
  "phone": "13800138001"
}
```

### 按角色查找

```json
{
  "role": "assistant"
}
```

### 查找所有仓库管理员

```json
{
  "role": "warehouse"
}
```

### 查找指定仓库的管理员

```json
{
  "role": "warehouse",
  "warehouseId": "WH_LZ"
}
```

---

## ❓ 常见问题

### Q1: 用户登录时提示"无权限"？

**原因**：数据库中没有该用户的记录，或者 `status` 不是 `active`。

**解决**：
1. 检查数据库中是否有该用户
2. 检查 `status` 字段是否为 `active`
3. 如果用户是新员工，需要先在数据库中添加记录

---

### Q2: 仓库管理员登录后看不到仓库数据？

**原因**：`warehouseId` 或 `warehouseName` 字段填写错误或为空。

**解决**：
1. 检查数据库中该用户的 `warehouseId` 字段
2. 确保 `warehouseId` 与 `warehouses` 集合中的仓库ID一致
3. 确保 `warehouseName` 也填写正确

---

### Q3: 如何获取用户的 openid？

**方法1**：等用户首次登录后自动绑定（推荐）

首次添加用户时，不需要填写 `_openid` 字段，用户首次登录后会自动绑定。

**方法2**：让用户提供

如果用户已经登录过其他小程序，可以让用户提供 openid（不太现实）。

---

### Q4: 添加用户后，用户多久能登录？

**立即生效**。

用户记录添加到数据库后，用户就可以立即登录小程序。

---

### Q5: 可以同时给一个用户分配多个角色吗？

**不可以**。

目前系统设计为一个用户只能有一个角色。如果需要多角色，需要修改代码逻辑。

---

## 📊 用户管理最佳实践

### 1. 使用统一的命名规范

**建议**：
- 助理：使用真实姓名，如"张三"
- 仓管：使用"仓库名+姓名"，如"梁寨-李四"
- 财务：使用"财务+姓名"，如"财务-王五"

### 2. 定期检查用户状态

每月检查一次 `users` 集合，将已离职员工的 `status` 改为 `inactive`。

### 3. 备份用户数据

定期导出 `users` 集合数据，作为备份。

在云开发控制台 → 数据库 → `users` 集合 → 点击 **"导出"** → 选择 JSON 或 CSV 格式。

### 4. 记录用户变更

建议在 Excel 或文档中记录用户的添加、修改、删除操作，方便追溯。

---

## 🎯 总结

对于 30 个用户的内部系统，**直接在云开发控制台管理用户是最简单的方式**：

✅ **优点**：
- 不用开发管理后台
- 操作简单，即改即生效
- 完全可控，安全性高

⚠️ **缺点**：
- 界面不够友好
- 必须用微信开发者工具打开
- 不适合非技术人员

如果未来用户增多，或者需要非技术人员管理，再考虑开发独立的管理后台。

---

**有问题随时联系管理员！** 📞
