# 财务/出纳模块实现计划

## 一、业务逻辑梳理

### 1. 核心流程

```
仓管收购登记 → 自动生成结算单(待审核) → 会计审核 → 出纳确认付款 → 已完成
```

### 2. 结算公式（审核时实时计算）

```
实付金额 = 收购货款 - 扣款合计

扣款合计 = 种苗欠款(seedDebt) + 农资欠款(agriculturalDebt) + 预付款(advancePayment)

扣款优先级：预付款 > 种苗欠款 > 农资欠款
```

### 3. 关键业务规则

- **定金**：已在签约时从种苗总价中扣除，生成 seedDebt = 种苗总价 - 定金
- **预付款**：现金债权，必须优先从收购款中扣除
- **实时计算**：金额在会计审核时才最终确定，避免并发扣款问题
- **扣款联动**：审核通过后，需更新农户的欠款余额

---

## 二、角色与权限

### 1. 新增角色

| 角色 | 代码 | 说明 |
|------|------|------|
| 出纳 | `cashier` | 负责记录付款完成状态 |

### 2. 权限分配

| 操作 | 会计(finance_admin) | 出纳(cashier) |
|------|-------------------|--------------|
| 查看所有结算单 | ✅ | ✅ |
| 审核结算单 | ✅ | ❌ |
| 确认付款 | ❌ | ✅ |

---

## 三、数据结构

### 1. 结算状态（简化为3个）

```typescript
type SettlementStatus = 'pending' | 'approved' | 'completed';
// pending: 待审核（仓管收购后自动生成）
// approved: 待付款（会计审核通过）
// completed: 已完成（出纳确认付款）
```

### 2. 结算单数据结构

```typescript
interface Settlement {
  id: string;                    // 结算单ID
  settlementNo: string;          // 结算单号 SET_20260127_0001
  
  // 关联信息
  farmerId: string;              // 农户ID
  farmerName: string;            // 农户姓名
  farmerPhone: string;           // 农户电话
  acquisitionId: string;         // 关联收购记录ID
  
  // 收购信息
  acquisitionAmount: number;     // 收购货款（元）
  acquisitionWeight: number;     // 收购重量（斤）
  acquisitionPrice: number;      // 收购单价（元/斤）
  acquisitionDate: string;       // 收购日期
  
  // 扣款明细（审核时计算）
  seedDebt: number;              // 本次扣除种苗欠款
  agriculturalDebt: number;      // 本次扣除农资欠款
  advancePayment: number;        // 本次扣除预付款
  totalDeduction: number;        // 扣款合计
  
  // 结算金额
  actualPayment: number;         // 实际应付金额
  
  // 状态与流程
  status: SettlementStatus;      // 结算状态
  
  // 审核信息
  auditorId?: string;            // 审核人ID
  auditorName?: string;          // 审核人姓名
  auditTime?: Date;              // 审核时间
  auditRemark?: string;          // 审核备注
  
  // 付款信息
  cashierId?: string;            // 出纳ID
  cashierName?: string;          // 出纳姓名
  paymentTime?: Date;            // 付款确认时间
  paymentMethod?: string;        // 付款方式
  paymentRemark?: string;        // 付款备注
  
  // 时间戳
  createTime: Date;              // 创建时间
  updateTime?: Date;             // 更新时间
}
```

---

## 四、页面结构

### 1. 财务/出纳首页 `/pages/finance/index`

根据登录角色显示不同Tab：

**会计视图Tab：**
- 待审核（我需要审核）
- 已审核（我审核过的）
- 全部

**出纳视图Tab：**
- 待付款（我需要处理）
- 已付款（我处理过的）
- 全部

### 2. 结算详情页 `/pages/finance/detail`

展示：
- 农户信息
- 收购信息
- 扣款明细
- 结算金额
- 操作记录
- 操作按钮（根据角色和状态）

---

## 五、实现步骤

### Phase 1: 基础设施 ✅ 已完成
- [x] 1.1 新增 cashier 角色到 types.ts
- [x] 1.2 更新 permission.ts，添加出纳权限和导航栏
- [x] 1.3 更新登录逻辑，支持出纳角色显示

### Phase 2: 云函数 ✅ 已完成
- [x] 2.1 修改 settlement-manage 云函数
  - 简化状态为3个：pending/approved/completed
  - 添加 auditSettlement 审核接口（会计，实时计算扣款）
  - 添加 completePayment 确认付款接口（出纳）
  - 添加 getCashierStats 出纳统计接口
  - 添加 previewDeduction 扣款预览接口
- [x] 2.2 修改 acquisition-manage 云函数
  - 收购提交后自动生成结算单（新字段结构）

### Phase 3: 前端页面 ✅ 已完成
- [x] 3.1 首页添加出纳视图
  - 出纳专属欢迎横幅
  - 待付款/今日已付统计卡片
  - 快捷操作入口
- [x] 3.2 修改 finance/index 页面
  - 根据角色显示不同Tab（会计/出纳）
  - 调用云函数获取真实数据
- [x] 3.3 修改 finance/detail 页面
  - 显示结算详情和扣款明细
  - 根据角色显示操作按钮（审核/付款）
  - 添加审核弹窗和付款弹窗
- [x] 3.4 更新 TabBar 支持出纳角色

### Phase 4: 联调测试（待进行）
- [ ] 4.1 部署云函数到微信云开发环境
- [ ] 4.2 测试完整流程
- [ ] 4.3 验证扣款计算正确性
- [ ] 4.4 验证权限控制

---

## 六、关键代码逻辑

### 1. 审核时实时计算扣款（云函数）

```javascript
async function auditSettlement(settlementId, userId) {
  // 1. 获取结算单和农户信息
  const settlement = await getSettlement(settlementId);
  const farmer = await getFarmer(settlement.farmerId);
  
  // 2. 获取当前农户的各项欠款
  const seedDebt = farmer.seedDebt || 0;
  const agriculturalDebt = farmer.agriculturalDebt || 0;
  const advancePayment = farmer.advancePayment || 0;
  
  // 3. 计算本次可扣除金额（不能超过收购货款）
  let remaining = settlement.acquisitionAmount;
  let deductAdvance = 0;
  let deductSeed = 0;
  let deductAgri = 0;
  
  // 优先扣预付款
  if (remaining > 0 && advancePayment > 0) {
    deductAdvance = Math.min(remaining, advancePayment);
    remaining -= deductAdvance;
  }
  
  // 其次扣种苗欠款
  if (remaining > 0 && seedDebt > 0) {
    deductSeed = Math.min(remaining, seedDebt);
    remaining -= deductSeed;
  }
  
  // 最后扣农资欠款
  if (remaining > 0 && agriculturalDebt > 0) {
    deductAgri = Math.min(remaining, agriculturalDebt);
    remaining -= deductAgri;
  }
  
  const actualPayment = remaining; // 剩余的就是实际应付
  
  // 4. 更新结算单
  await updateSettlement(settlementId, {
    advancePayment: deductAdvance,
    seedDebt: deductSeed,
    agriculturalDebt: deductAgri,
    totalDeduction: deductAdvance + deductSeed + deductAgri,
    actualPayment,
    status: 'approved',
    auditorId: userId,
    auditTime: new Date()
  });
  
  // 5. 更新农户欠款余额
  await updateFarmer(settlement.farmerId, {
    advancePayment: farmer.advancePayment - deductAdvance,
    seedDebt: farmer.seedDebt - deductSeed,
    agriculturalDebt: farmer.agriculturalDebt - deductAgri
  });
}
```

---

## 七、UI 设计要点

1. **列表页**：简洁明了，一眼看出状态
2. **详情页**：金额计算过程透明可查
3. **操作按钮**：醒目，防误触（二次确认）
4. **状态标签**：颜色区分
   - 待审核：橙色
   - 待付款：蓝色
   - 已完成：绿色
