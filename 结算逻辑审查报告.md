# ç»“ç®—é€»è¾‘å®¡æŸ¥æŠ¥å‘Š

## ğŸš¨ å‘ç°çš„ä¸¥é‡é—®é¢˜

### é—®é¢˜ 1: ç§è‹—æ¬ æ¬¾è®¡ç®—é€»è¾‘ä¸ä¸€è‡´ âš ï¸ é«˜é£é™©

**ä½ç½®:** `settlement-manage/auditSettlement` Line 277-279

**é—®é¢˜æè¿°:**
```javascript
// å½“å‰ä»£ç 
const totalSeedAmount = farmer.stats?.totalSeedAmount || 0;  // å®é™…å‘è‹—é‡‘é¢
const deposit = farmer.deposit || 0;                          // å®šé‡‘
const currentSeedDebt = Math.max(0, totalSeedAmount - deposit);
```

**é£é™©ç‚¹:**
1. **å®šé‡‘æ¦‚å¿µæ··æ·†**: å®šé‡‘æ˜¯ç­¾çº¦æ—¶é¢„æ”¶çš„æ¬¾é¡¹ï¼Œåº”è¯¥ä»**åº”æ”¶æ¬¾(receivableAmount)**ä¸­æ‰£é™¤ï¼Œè€Œä¸æ˜¯ä»**å®é™…å‘è‹—é‡‘é¢(totalSeedAmount)**ä¸­æ‰£é™¤
2. **å‘è‹—å‰è®¡ç®—é”™è¯¯**: å¦‚æœå†œæˆ·è¿˜æ²¡å¼€å§‹å‘è‹—ï¼Œ`stats.totalSeedAmount = 0`ï¼Œé‚£ä¹ˆç§è‹—æ¬ æ¬¾å°±å˜æˆ `-deposit`ï¼ˆè´Ÿæ•°ä¼šè¢«Maxç½®0ï¼‰ï¼Œå¯¼è‡´åº”æ”¶çš„ç§è‹—æ¬¾è¢«å¿½ç•¥
3. **æ•°æ®æºä¸ä¸€è‡´**: å†œæˆ·è¡¨ä¸­æœ‰ `seedDebt` å­—æ®µï¼Œä½†å®¡æ ¸æ—¶æ²¡ç”¨ï¼Œåè€Œé‡æ–°è®¡ç®—

**ç¤ºä¾‹åœºæ™¯:**
```
å†œæˆ·ç­¾çº¦: ç§è‹—åº”æ”¶ 27,900å…ƒ, å®šé‡‘ 4,000å…ƒ
- åº”æ”¶ç§è‹—æ¬¾: 27,900 - 4,000 = 23,900å…ƒ

æƒ…å†µ1: å†œæˆ·è¿˜æ²¡å‘è‹—
- stats.totalSeedAmount = 0
- currentSeedDebt = 0 - 4000 = 0 (è¢«Maxæˆªæ–­)
- âŒ é”™è¯¯: åº”è¯¥æ˜¯ 23,900å…ƒï¼Œä½†è®¡ç®—å‡ºæ¥æ˜¯0å…ƒ

æƒ…å†µ2: å†œæˆ·å‘äº†ä¸€åŠè‹— (14,000å…ƒ)
- stats.totalSeedAmount = 14,000
- currentSeedDebt = 14,000 - 4,000 = 10,000å…ƒ
- âŒ é”™è¯¯: åº”è¯¥æ˜¯ 23,900å…ƒï¼Œä½†è®¡ç®—å‡ºæ¥æ˜¯10,000å…ƒ
```

**æ­£ç¡®é€»è¾‘:**
```javascript
// ç§è‹—æ¬ æ¬¾ = åº”æ”¶æ¬¾ - å·²äº¤å®šé‡‘ - å·²ä»˜æ¬¾
// æˆ–è€…ç›´æ¥ä½¿ç”¨å†œæˆ·è¡¨ä¸­ç»´æŠ¤çš„ seedDebt å­—æ®µ
const currentSeedDebt = farmer.seedDebt || 0;
```

---

### é—®é¢˜ 2: å†œæˆ·æ¬ æ¬¾æ›´æ–°å­—æ®µä¸åŒ¹é… âš ï¸ é«˜é£é™©

**ä½ç½®:** `settlement-manage/auditSettlement` Line 344-351

**é—®é¢˜æè¿°:**
```javascript
if (deductSeed > 0) {
  updateData.seedDebt = currentSeedDebt - deductSeed;
  updateData['stats.seedDebt'] = currentSeedDebt - deductSeed;  // âŒ é”™è¯¯å­—æ®µ
}
if (deductAgri > 0) {
  updateData.agriculturalDebt = currentAgriDebt - deductAgri;
  updateData['stats.agriculturalDebt'] = currentAgriDebt - deductAgri;  // âŒ é”™è¯¯å­—æ®µ
}
```

**é£é™©ç‚¹:**
æ ¹æ® `database-schema.md` å†œæˆ·è¡¨ç»“æ„:
```javascript
// å†œæˆ·è¡¨å­—æ®µ
{
  seedDebt: 5000,           // âœ… æ ¹å­—æ®µå­˜åœ¨
  agriculturalDebt: 0,      // âœ… æ ¹å­—æ®µå­˜åœ¨
  advancePayment: 0,        // âœ… æ ¹å­—æ®µå­˜åœ¨
  
  stats: {
    totalSeedDistributed: 0,     // âœ… å­˜åœ¨
    totalSeedAmount: 0,          // âœ… å­˜åœ¨
    seedDistributionCount: 0,    // âœ… å­˜åœ¨
    totalAcquisitionCount: 0,    // âœ… å­˜åœ¨
    // âŒ æ²¡æœ‰ seedDebt å­—æ®µ
    // âŒ æ²¡æœ‰ agriculturalDebt å­—æ®µ
  }
}
```

**åæœ:**
- åœ¨ `stats` å¯¹è±¡ä¸­å†™å…¥ä¸å­˜åœ¨çš„å­—æ®µï¼Œé€ æˆæ•°æ®å†—ä½™
- ä¸‹æ¬¡æŸ¥è¯¢æ—¶å¯èƒ½è¯»åˆ°ä¸ä¸€è‡´çš„å€¼

**æ­£ç¡®ä¿®å¤:**
```javascript
// åªæ›´æ–°æ ¹å­—æ®µï¼Œä¸è¦æ›´æ–° stats ä¸­ä¸å­˜åœ¨çš„å­—æ®µ
if (deductSeed > 0) {
  updateData.seedDebt = currentSeedDebt - deductSeed;
}
if (deductAgri > 0) {
  updateData.agriculturalDebt = currentAgriDebt - deductAgri;
}
```

---

### é—®é¢˜ 3: å¹¶å‘å®¡æ ¸å¯¼è‡´çš„æ¬ æ¬¾æ‰£é™¤é”™è¯¯ âš ï¸ ä¸­é£é™©

**åœºæ™¯:**
```
å†œæˆ·æ¬ æ¬¾: ç§è‹— 10,000å…ƒ

åŒæ—¶æœ‰2ä¸ªæ”¶è´­å•ç­‰å¾…å®¡æ ¸:
- æ”¶è´­å•A: è´§æ¬¾ 8,000å…ƒ
- æ”¶è´­å•B: è´§æ¬¾ 7,000å…ƒ

å¦‚æœä¼šè®¡åŒæ—¶ç‚¹å‡»å®¡æ ¸:
1. å®¡æ ¸Aè¯»å–æ¬ æ¬¾: 10,000å…ƒ â†’ æ‰£é™¤ 8,000 â†’ å‰©ä½™ 2,000
2. å®¡æ ¸Bè¯»å–æ¬ æ¬¾: 10,000å…ƒ â†’ æ‰£é™¤ 7,000 â†’ å‰©ä½™ 3,000

æœ€ç»ˆç»“æœ: æ‰£äº† 8,000 + 7,000 = 15,000å…ƒï¼Œä½†å†œæˆ·åªæ¬  10,000å…ƒ
å†œæˆ·æ¬ æ¬¾å˜æˆè´Ÿæ•°: -5,000å…ƒ
```

**è§£å†³æ–¹æ¡ˆ:**
1. æ–¹æ¡ˆ1 (æ¨è): ä½¿ç”¨å¾®ä¿¡äº‘æ•°æ®åº“çš„**äº‹åŠ¡**
2. æ–¹æ¡ˆ2: ä½¿ç”¨**ä¹è§‚é”** (åœ¨å†œæˆ·è¡¨åŠ  `version` å­—æ®µ)
3. æ–¹æ¡ˆ3: åœ¨å‰ç«¯é™åˆ¶åŒä¸€å†œæˆ·åªèƒ½æœ‰ä¸€ä¸ªå¾…å®¡æ ¸çš„ç»“ç®—å•

---

### é—®é¢˜ 4: æ”¶è´­ä¿®æ”¹åçš„ç»“ç®—å•é‡‘é¢ä¸åŒæ­¥ âš ï¸ ä¸­é£é™©

**ä½ç½®:** `acquisition-manage/updateAcquisition` Line 712

**é—®é¢˜æè¿°:**
```javascript
// ä¿®æ”¹æ”¶è´­è®°å½•åï¼Œé‡æ–°è®¡ç®—ç»“ç®—å•
const newActualPayment = Number((newTotalAmount - (settlement.seedDebt || 0) - (settlement.otherDeductions || 0)).toFixed(2));
```

**é£é™©ç‚¹:**
- ä½¿ç”¨çš„æ˜¯ç»“ç®—å•ä¸Š**å·²ä¿å­˜çš„æ‰£æ¬¾é‡‘é¢** `settlement.seedDebt`
- ä½†å†œæˆ·çš„å®é™…æ¬ æ¬¾å¯èƒ½å·²ç»å˜åŒ– (æ¯”å¦‚åˆå‘äº†è‹—ã€åˆæ”¶äº†ä¸€æ¬¡è´§)
- å¯¼è‡´æ‰£æ¬¾é‡‘é¢ä¸å‡†ç¡®

**æ­£ç¡®é€»è¾‘:**
```javascript
// ä¿®æ”¹æ”¶è´­åï¼Œç»“ç®—å•åº”è¯¥å›åˆ° pending çŠ¶æ€ï¼Œæ¸…ç©ºæ‰£æ¬¾æ˜ç»†
const settlementUpdates = {
  acquisitionWeight: newNetWeight,
  acquisitionAmount: newTotalAmount,
  
  // æ¸…ç©ºæ‰£æ¬¾æ˜ç»†ï¼ˆç­‰å¾…é‡æ–°å®¡æ ¸ï¼‰
  advanceDeduction: 0,
  seedDeduction: 0,
  agriculturalDeduction: 0,
  totalDeduction: 0,
  actualPayment: 0,
  
  status: 'pending',  // é‡æ–°ç­‰å¾…å®¡æ ¸
  updateTime: db.serverDate()
};
```

---

### é—®é¢˜ 5: åˆ é™¤æ”¶è´­è®°å½•æ—¶æœªæ¢å¤å†œæˆ·æ¬ æ¬¾ âš ï¸ ä¸­é£é™©

**ä½ç½®:** `acquisition-manage/deleteAcquisition` Line 998-1009

**é—®é¢˜æè¿°:**
```javascript
// åˆ é™¤æ”¶è´­è®°å½•æ—¶ï¼ŒåŒæ—¶åˆ é™¤ç»“ç®—å•
await db.collection('settlements')
  .where({ acquisitionId })
  .update({
    data: {
      status: 'deleted',
      ...
    }
  });
```

**é£é™©ç‚¹:**
å¦‚æœç»“ç®—å•å·²ç»å®¡æ ¸é€šè¿‡:
1. å†œæˆ·æ¬ æ¬¾å·²è¢«æ‰£é™¤ (æ¯”å¦‚æ‰£äº†5000å…ƒç§è‹—æ¬¾)
2. åˆ é™¤æ”¶è´­è®°å½•æ—¶ï¼Œæ²¡æœ‰æ¢å¤è¿™5000å…ƒ
3. å¯¼è‡´å†œæˆ·æ¬ æ¬¾å°‘äº†5000å…ƒ

**ä¿®å¤æ–¹æ¡ˆ:**
```javascript
// åˆ é™¤å‰æ£€æŸ¥ç»“ç®—å•çŠ¶æ€
const settlement = settlementRes.data[0];

if (settlement.status === 'approved' || settlement.status === 'completed') {
  // å¦‚æœå·²å®¡æ ¸ï¼Œéœ€è¦æ¢å¤å†œæˆ·æ¬ æ¬¾
  if (settlement.advanceDeduction > 0 || settlement.seedDeduction > 0 || settlement.agriculturalDeduction > 0) {
    await db.collection('farmers')
      .where({ farmerId: acquisition.farmerId })
      .update({
        data: {
          advancePayment: _.inc(settlement.advanceDeduction),
          seedDebt: _.inc(settlement.seedDeduction),
          agriculturalDebt: _.inc(settlement.agriculturalDeduction),
          updateTime: db.serverDate()
        }
      });
  }
}
```

---

### é—®é¢˜ 6: é‡‘é¢ç²¾åº¦ç´¯ç§¯è¯¯å·® âš ï¸ ä½é£é™©

**é—®é¢˜æè¿°:**
```javascript
// å¤šæ¬¡ toFixed(2) å¯èƒ½å¯¼è‡´ç²¾åº¦è¯¯å·®
const computedMoistureWeight = (grossWeightNum - tareWeightNum) * (moistureRateNum / 100);
const computedNetWeight = grossWeightNum - tareWeightNum - computedMoistureWeight;
const computedTotalAmount = computedNetWeight * unitPriceNum;

// ç„¶ååˆ:
moistureWeight: Number(computedMoistureWeight.toFixed(2)),
netWeight: Number(computedNetWeight.toFixed(2)),
totalAmount: Number(computedTotalAmount.toFixed(2)),
```

**é£é™©:**
åœ¨å¤§é‡è®¡ç®—åï¼Œç²¾åº¦è¯¯å·®å¯èƒ½ç´¯ç§¯åˆ°å‡ åˆ†é’±ç”šè‡³å‡ å…ƒ

**å»ºè®®:**
- é‡‘é¢ç»Ÿä¸€ä½¿ç”¨**åˆ†**ä¸ºå•ä½å­˜å‚¨ (æ•´æ•°)
- åªåœ¨å±•ç¤ºæ—¶æ‰é™¤ä»¥100
- æˆ–è€…ä½¿ç”¨ `decimal.js` åº“å¤„ç†æµ®ç‚¹æ•°

---

## âœ… æ­£ç¡®çš„è®¡ç®—é€»è¾‘

### æ­£ç¡®çš„æ¬ æ¬¾å®šä¹‰

```javascript
// å†œæˆ·æ¬ æ¬¾ç»“æ„
{
  // 1. ç§è‹—æ¬ æ¬¾ = åº”æ”¶ç§è‹—æ¬¾ - å·²äº¤å®šé‡‘ - å·²ä»˜ç§è‹—æ¬¾
  seedDebt: 23900,  // ç­¾çº¦æ—¶è®¡ç®—: receivableAmount - deposit
  
  // 2. å†œèµ„æ¬ æ¬¾ = é¢†å–çš„å†œèµ„æ€»é‡‘é¢ - å·²ä»˜å†œèµ„æ¬¾
  agriculturalDebt: 0,
  
  // 3. é¢„ä»˜æ¬¾ = å·²é¢„ä»˜çš„ç°é‡‘æ€»é¢ - å·²æŠµæ‰£çš„é¢„ä»˜æ¬¾
  advancePayment: 0,
  
  // å‘è‹—ç»Ÿè®¡ (ç”¨äºè®¡ç®—å·²å‘è‹—é‡‘é¢ï¼Œä½†ä¸ç›´æ¥å‚ä¸ç»“ç®—æ‰£æ¬¾)
  stats: {
    totalSeedAmount: 0,        // å®é™…å‘è‹—é‡‘é¢
    totalSeedDistributed: 0    // å®é™…å‘è‹—æ•°é‡
  }
}
```

### æ­£ç¡®çš„ç»“ç®—æ‰£æ¬¾é€»è¾‘

```javascript
async function auditSettlement(settlementId) {
  // 1. è·å–ç»“ç®—å•
  const settlement = await getSettlement(settlementId);
  const acquisitionAmount = settlement.acquisitionAmount; // æ”¶è´­è´§æ¬¾
  
  // 2. è·å–å†œæˆ·æœ€æ–°æ¬ æ¬¾ï¼ˆç›´æ¥è¯»å–ç»´æŠ¤å¥½çš„å­—æ®µï¼‰
  const farmer = await getFarmer(settlement.farmerId);
  const currentAdvance = farmer.advancePayment || 0;       // é¢„ä»˜æ¬¾
  const currentSeedDebt = farmer.seedDebt || 0;            // ç§è‹—æ¬ æ¬¾
  const currentAgriDebt = farmer.agriculturalDebt || 0;    // å†œèµ„æ¬ æ¬¾
  
  // 3. æŒ‰ä¼˜å…ˆçº§æ‰£æ¬¾ï¼ˆä¸èƒ½è¶…è¿‡æ”¶è´­è´§æ¬¾ï¼‰
  let remaining = acquisitionAmount;
  
  // ä¼˜å…ˆæ‰£é¢„ä»˜æ¬¾ (ç°é‡‘å€ºæƒ)
  let deductAdvance = Math.min(remaining, currentAdvance);
  remaining -= deductAdvance;
  
  // å…¶æ¬¡æ‰£ç§è‹—æ¬ æ¬¾
  let deductSeed = Math.min(remaining, currentSeedDebt);
  remaining -= deductSeed;
  
  // æœ€åæ‰£å†œèµ„æ¬ æ¬¾
  let deductAgri = Math.min(remaining, currentAgriDebt);
  remaining -= deductAgri;
  
  // 4. å®ä»˜é‡‘é¢
  const actualPayment = remaining;
  
  // 5. æ›´æ–°ç»“ç®—å•
  await updateSettlement(settlementId, {
    advanceDeduction: deductAdvance,
    seedDeduction: deductSeed,
    agriculturalDeduction: deductAgri,
    totalDeduction: deductAdvance + deductSeed + deductAgri,
    actualPayment,
    status: 'approved'
  });
  
  // 6. æ›´æ–°å†œæˆ·æ¬ æ¬¾ä½™é¢ï¼ˆä½¿ç”¨ inc é¿å…è¦†ç›–ï¼‰
  await updateFarmer(settlement.farmerId, {
    advancePayment: _.inc(-deductAdvance),     // å‡å°‘é¢„ä»˜æ¬¾
    seedDebt: _.inc(-deductSeed),              // å‡å°‘ç§è‹—æ¬ æ¬¾
    agriculturalDebt: _.inc(-deductAgri)       // å‡å°‘å†œèµ„æ¬ æ¬¾
  });
}
```

---

## ğŸ”§ å»ºè®®çš„ä¿®å¤ä¼˜å…ˆçº§

### P0 - ç«‹å³ä¿®å¤ (å½±å“è´¢åŠ¡å‡†ç¡®æ€§)
1. âœ… **ä¿®å¤ç§è‹—æ¬ æ¬¾è®¡ç®—é€»è¾‘** - ç›´æ¥ä½¿ç”¨ `farmer.seedDebt`
2. âœ… **ä¿®å¤å†œæˆ·æ¬ æ¬¾å­—æ®µæ›´æ–°** - ç§»é™¤ `stats.seedDebt` ç­‰ä¸å­˜åœ¨çš„å­—æ®µ
3. âœ… **ä¿®æ”¹æ”¶è´­åæ¸…ç©ºç»“ç®—å•æ‰£æ¬¾** - é¿å…ä½¿ç”¨æ—§çš„æ‰£æ¬¾é‡‘é¢

### P1 - è¿‘æœŸä¿®å¤ (é˜²æ­¢æ•°æ®ä¸ä¸€è‡´)
4. âœ… **æ·»åŠ å¹¶å‘æ§åˆ¶** - ä½¿ç”¨äº‹åŠ¡æˆ–ä¹è§‚é”
5. âœ… **åˆ é™¤æ”¶è´­æ—¶æ¢å¤æ¬ æ¬¾** - æ£€æŸ¥ç»“ç®—çŠ¶æ€å¹¶å›æ»šæ¬ æ¬¾

### P2 - é•¿æœŸä¼˜åŒ– (æå‡ç¨³å®šæ€§)
6. âœ… **é‡‘é¢ç²¾åº¦ä¼˜åŒ–** - ä½¿ç”¨æ•´æ•°åˆ†æˆ– decimal.js
7. âœ… **æ·»åŠ å•å…ƒæµ‹è¯•** - è¦†ç›–å„ç§è¾¹ç•Œæƒ…å†µ

---

## ğŸ“ æµ‹è¯•ç”¨ä¾‹å»ºè®®

### æµ‹è¯•åœºæ™¯ 1: æ¬ æ¬¾ä¸è¶³ä»¥æŠµæ‰£
```
å†œæˆ·æ¬ æ¬¾: ç§è‹— 3,000å…ƒ
æ”¶è´­è´§æ¬¾: 10,000å…ƒ
é¢„æœŸæ‰£æ¬¾: 3,000å…ƒ
é¢„æœŸå®ä»˜: 7,000å…ƒ
é¢„æœŸæ¬ æ¬¾: 0å…ƒ
```

### æµ‹è¯•åœºæ™¯ 2: å¤šé¡¹æ¬ æ¬¾æŒ‰ä¼˜å…ˆçº§æ‰£é™¤
```
å†œæˆ·æ¬ æ¬¾: é¢„ä»˜æ¬¾ 2,000å…ƒ, ç§è‹— 5,000å…ƒ, å†œèµ„ 3,000å…ƒ
æ”¶è´­è´§æ¬¾: 8,000å…ƒ
é¢„æœŸæ‰£æ¬¾: é¢„ä»˜æ¬¾ 2,000 + ç§è‹— 5,000 + å†œèµ„ 1,000 = 8,000å…ƒ
é¢„æœŸå®ä»˜: 0å…ƒ
é¢„æœŸæ¬ æ¬¾: ç§è‹— 0å…ƒ, å†œèµ„ 2,000å…ƒ
```

### æµ‹è¯•åœºæ™¯ 3: æœªå‘è‹—çš„å†œæˆ·ç»“ç®—
```
å†œæˆ·ç­¾çº¦: åº”æ”¶ 27,900å…ƒ, å®šé‡‘ 4,000å…ƒ
å‘è‹—è®°å½•: æ—  (totalSeedAmount = 0)
ç§è‹—æ¬ æ¬¾: 23,900å…ƒ  (âŒ å½“å‰ä»£ç ä¼šç®—æˆ 0å…ƒ)
æ”¶è´­è´§æ¬¾: 30,000å…ƒ
é¢„æœŸæ‰£æ¬¾: 23,900å…ƒ
é¢„æœŸå®ä»˜: 6,100å…ƒ
```

### æµ‹è¯•åœºæ™¯ 4: å¹¶å‘å®¡æ ¸
```
å†œæˆ·æ¬ æ¬¾: ç§è‹— 10,000å…ƒ
åŒæ—¶å®¡æ ¸2ä¸ªç»“ç®—å•:
- ç»“ç®—å•A: è´§æ¬¾ 8,000å…ƒ
- ç»“ç®—å•B: è´§æ¬¾ 7,000å…ƒ

é¢„æœŸç»“æœ:
- ç»“ç®—å•A: æ‰£æ¬¾ 8,000, å®ä»˜ 0, å‰©ä½™æ¬ æ¬¾ 2,000
- ç»“ç®—å•B: æ‰£æ¬¾ 2,000, å®ä»˜ 5,000, å‰©ä½™æ¬ æ¬¾ 0
- âŒ ä¸åº”è¯¥å‡ºç°è´Ÿæ¬ æ¬¾
```

---

## ğŸ’¡ æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥è„šæœ¬

å»ºè®®å®šæœŸè¿è¡Œæ£€æŸ¥è„šæœ¬,ç¡®ä¿æ•°æ®ä¸€è‡´æ€§:

```javascript
// æ£€æŸ¥å†œæˆ·æ¬ æ¬¾æ˜¯å¦ä¸ºè´Ÿæ•°
db.collection('farmers').where({
  _or: [
    { seedDebt: _.lt(0) },
    { agriculturalDebt: _.lt(0) },
    { advancePayment: _.lt(0) }
  ]
}).get()

// æ£€æŸ¥å·²å®¡æ ¸çš„ç»“ç®—å•æ‰£æ¬¾æ˜¯å¦å¤§äºè´§æ¬¾
db.collection('settlements').where({
  status: 'approved',
  totalDeduction: _.gt(db.command.field('acquisitionAmount'))
}).get()
```
